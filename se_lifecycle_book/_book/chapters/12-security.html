<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>14&nbsp; Chapter 12: Software Security – The Complete Software Engineering Lifecycle</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/13-maintenance-evolution.html" rel="next">
<link href="../chapters/11-cloud-services.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-9b98f18118eee809be1c051eb5cc78e4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/12-security.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 12: Software Security</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">The Complete Software Engineering Lifecycle</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Complete Software Engineering Lifecycle</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../acknowledgments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Acknowledgments</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 1: Introduction to Software Engineering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-requirements-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Chapter 2: Requirements Engineering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-systems-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 3: Systems Modeling and UML</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-software-architecture.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 4: Software Architecture and Design Patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-ui-ux.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 5: UI/UX Design and Prototyping</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-agile-methodologies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 6: Agile Methodologies and Project Management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-version-control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 7: Version Control Workflows</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-cicd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 9: Continuous Integration and Continuous Deployment</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/10-data-management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 10: Data Management and APIs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/11-cloud-services.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 11: Cloud Services and Deployment</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/12-security.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 12: Software Security</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/13-maintenance-evolution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 13: Software Maintenance and Evolution</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/14-ethics-professionalism.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 14: Professional Practice and Ethics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/15-final-project-integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Chapter 15: Final Project Integration and Course Synthesis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/glossary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Glossary</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives"><span class="header-section-number">14.1</span> Learning Objectives</a></li>
  <li><a href="#the-imperative-of-software-security" id="toc-the-imperative-of-software-security" class="nav-link" data-scroll-target="#the-imperative-of-software-security"><span class="header-section-number">14.2</span> 12.1 The Imperative of Software Security</a>
  <ul class="collapse">
  <li><a href="#the-cost-of-security-failures" id="toc-the-cost-of-security-failures" class="nav-link" data-scroll-target="#the-cost-of-security-failures"><span class="header-section-number">14.2.1</span> 12.1.1 The Cost of Security Failures</a></li>
  <li><a href="#security-principles" id="toc-security-principles" class="nav-link" data-scroll-target="#security-principles"><span class="header-section-number">14.2.2</span> 12.1.2 Security Principles</a></li>
  <li><a href="#the-security-mindset" id="toc-the-security-mindset" class="nav-link" data-scroll-target="#the-security-mindset"><span class="header-section-number">14.2.3</span> 12.1.3 The Security Mindset</a></li>
  </ul></li>
  <li><a href="#owasp-top-10-web-application-vulnerabilities" id="toc-owasp-top-10-web-application-vulnerabilities" class="nav-link" data-scroll-target="#owasp-top-10-web-application-vulnerabilities"><span class="header-section-number">14.3</span> 12.2 OWASP Top 10 Web Application Vulnerabilities</a>
  <ul class="collapse">
  <li><a href="#a01-broken-access-control" id="toc-a01-broken-access-control" class="nav-link" data-scroll-target="#a01-broken-access-control"><span class="header-section-number">14.3.1</span> 12.2.1 A01: Broken Access Control</a></li>
  <li><a href="#a02-cryptographic-failures" id="toc-a02-cryptographic-failures" class="nav-link" data-scroll-target="#a02-cryptographic-failures"><span class="header-section-number">14.3.2</span> 12.2.2 A02: Cryptographic Failures</a></li>
  <li><a href="#a03-injection" id="toc-a03-injection" class="nav-link" data-scroll-target="#a03-injection"><span class="header-section-number">14.3.3</span> 12.2.3 A03: Injection</a></li>
  <li><a href="#a04-insecure-design" id="toc-a04-insecure-design" class="nav-link" data-scroll-target="#a04-insecure-design"><span class="header-section-number">14.3.4</span> 12.2.4 A04: Insecure Design</a></li>
  <li><a href="#a05-security-misconfiguration" id="toc-a05-security-misconfiguration" class="nav-link" data-scroll-target="#a05-security-misconfiguration"><span class="header-section-number">14.3.5</span> 12.2.5 A05: Security Misconfiguration</a></li>
  <li><a href="#a06-vulnerable-and-outdated-components" id="toc-a06-vulnerable-and-outdated-components" class="nav-link" data-scroll-target="#a06-vulnerable-and-outdated-components"><span class="header-section-number">14.3.6</span> 12.2.6 A06: Vulnerable and Outdated Components</a></li>
  <li><a href="#a07-identification-and-authentication-failures" id="toc-a07-identification-and-authentication-failures" class="nav-link" data-scroll-target="#a07-identification-and-authentication-failures"><span class="header-section-number">14.3.7</span> 12.2.7 A07: Identification and Authentication Failures</a></li>
  <li><a href="#a08-software-and-data-integrity-failures" id="toc-a08-software-and-data-integrity-failures" class="nav-link" data-scroll-target="#a08-software-and-data-integrity-failures"><span class="header-section-number">14.3.8</span> 12.2.8 A08: Software and Data Integrity Failures</a></li>
  <li><a href="#a09-security-logging-and-monitoring-failures" id="toc-a09-security-logging-and-monitoring-failures" class="nav-link" data-scroll-target="#a09-security-logging-and-monitoring-failures"><span class="header-section-number">14.3.9</span> 12.2.9 A09: Security Logging and Monitoring Failures</a></li>
  <li><a href="#a10-server-side-request-forgery-ssrf" id="toc-a10-server-side-request-forgery-ssrf" class="nav-link" data-scroll-target="#a10-server-side-request-forgery-ssrf"><span class="header-section-number">14.3.10</span> 12.2.10 A10: Server-Side Request Forgery (SSRF)</a></li>
  </ul></li>
  <li><a href="#input-validation-and-sanitization" id="toc-input-validation-and-sanitization" class="nav-link" data-scroll-target="#input-validation-and-sanitization"><span class="header-section-number">14.4</span> 12.3 Input Validation and Sanitization</a>
  <ul class="collapse">
  <li><a href="#validation-strategies" id="toc-validation-strategies" class="nav-link" data-scroll-target="#validation-strategies"><span class="header-section-number">14.4.1</span> 12.3.1 Validation Strategies</a></li>
  <li><a href="#comprehensive-validation-with-joi" id="toc-comprehensive-validation-with-joi" class="nav-link" data-scroll-target="#comprehensive-validation-with-joi"><span class="header-section-number">14.4.2</span> 12.3.2 Comprehensive Validation with Joi</a></li>
  <li><a href="#output-encoding" id="toc-output-encoding" class="nav-link" data-scroll-target="#output-encoding"><span class="header-section-number">14.4.3</span> 12.3.3 Output Encoding</a></li>
  </ul></li>
  <li><a href="#security-headers" id="toc-security-headers" class="nav-link" data-scroll-target="#security-headers"><span class="header-section-number">14.5</span> 12.4 Security Headers</a>
  <ul class="collapse">
  <li><a href="#content-security-policy" id="toc-content-security-policy" class="nav-link" data-scroll-target="#content-security-policy"><span class="header-section-number">14.5.1</span> 12.4.1 Content Security Policy</a></li>
  <li><a href="#other-essential-headers" id="toc-other-essential-headers" class="nav-link" data-scroll-target="#other-essential-headers"><span class="header-section-number">14.5.2</span> 12.4.2 Other Essential Headers</a></li>
  </ul></li>
  <li><a href="#security-testing" id="toc-security-testing" class="nav-link" data-scroll-target="#security-testing"><span class="header-section-number">14.6</span> 12.5 Security Testing</a>
  <ul class="collapse">
  <li><a href="#types-of-security-testing" id="toc-types-of-security-testing" class="nav-link" data-scroll-target="#types-of-security-testing"><span class="header-section-number">14.6.1</span> 12.5.1 Types of Security Testing</a></li>
  <li><a href="#integrating-security-testing-into-cicd" id="toc-integrating-security-testing-into-cicd" class="nav-link" data-scroll-target="#integrating-security-testing-into-cicd"><span class="header-section-number">14.6.2</span> 12.5.2 Integrating Security Testing into CI/CD</a></li>
  <li><a href="#writing-security-tests" id="toc-writing-security-tests" class="nav-link" data-scroll-target="#writing-security-tests"><span class="header-section-number">14.6.3</span> 12.5.3 Writing Security Tests</a></li>
  </ul></li>
  <li><a href="#incident-response" id="toc-incident-response" class="nav-link" data-scroll-target="#incident-response"><span class="header-section-number">14.7</span> 12.6 Incident Response</a>
  <ul class="collapse">
  <li><a href="#incident-response-phases" id="toc-incident-response-phases" class="nav-link" data-scroll-target="#incident-response-phases"><span class="header-section-number">14.7.1</span> 12.6.1 Incident Response Phases</a></li>
  <li><a href="#containment-actions" id="toc-containment-actions" class="nav-link" data-scroll-target="#containment-actions"><span class="header-section-number">14.7.2</span> 12.6.2 Containment Actions</a></li>
  <li><a href="#communication" id="toc-communication" class="nav-link" data-scroll-target="#communication"><span class="header-section-number">14.7.3</span> 12.6.3 Communication</a></li>
  </ul></li>
  <li><a href="#chapter-summary" id="toc-chapter-summary" class="nav-link" data-scroll-target="#chapter-summary"><span class="header-section-number">14.8</span> 12.7 Chapter Summary</a></li>
  <li><a href="#key-terms" id="toc-key-terms" class="nav-link" data-scroll-target="#key-terms"><span class="header-section-number">14.9</span> 12.8 Key Terms</a></li>
  <li><a href="#review-questions" id="toc-review-questions" class="nav-link" data-scroll-target="#review-questions"><span class="header-section-number">14.10</span> 12.9 Review Questions</a></li>
  <li><a href="#hands-on-exercises" id="toc-hands-on-exercises" class="nav-link" data-scroll-target="#hands-on-exercises"><span class="header-section-number">14.11</span> 12.10 Hands-On Exercises</a>
  <ul class="collapse">
  <li><a href="#exercise-12.1-security-audit" id="toc-exercise-12.1-security-audit" class="nav-link" data-scroll-target="#exercise-12.1-security-audit"><span class="header-section-number">14.11.1</span> Exercise 12.1: Security Audit</a></li>
  <li><a href="#exercise-12.2-implement-owasp-protections" id="toc-exercise-12.2-implement-owasp-protections" class="nav-link" data-scroll-target="#exercise-12.2-implement-owasp-protections"><span class="header-section-number">14.11.2</span> Exercise 12.2: Implement OWASP Protections</a></li>
  <li><a href="#exercise-12.3-security-testing-suite" id="toc-exercise-12.3-security-testing-suite" class="nav-link" data-scroll-target="#exercise-12.3-security-testing-suite"><span class="header-section-number">14.11.3</span> Exercise 12.3: Security Testing Suite</a></li>
  <li><a href="#exercise-12.4-dependency-security-pipeline" id="toc-exercise-12.4-dependency-security-pipeline" class="nav-link" data-scroll-target="#exercise-12.4-dependency-security-pipeline"><span class="header-section-number">14.11.4</span> Exercise 12.4: Dependency Security Pipeline</a></li>
  <li><a href="#exercise-12.5-security-logging-implementation" id="toc-exercise-12.5-security-logging-implementation" class="nav-link" data-scroll-target="#exercise-12.5-security-logging-implementation"><span class="header-section-number">14.11.5</span> Exercise 12.5: Security Logging Implementation</a></li>
  <li><a href="#exercise-12.6-incident-response-plan" id="toc-exercise-12.6-incident-response-plan" class="nav-link" data-scroll-target="#exercise-12.6-incident-response-plan"><span class="header-section-number">14.11.6</span> Exercise 12.6: Incident Response Plan</a></li>
  </ul></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">14.12</span> 12.11 Further Reading</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">14.13</span> References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 12: Software Security</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">14.1</span> Learning Objectives</h2>
<p>By the end of this chapter, you will be able to:</p>
<ul>
<li>Explain the importance of security as a fundamental software quality attribute</li>
<li>Identify and mitigate the OWASP Top 10 web application vulnerabilities</li>
<li>Implement secure authentication and authorization mechanisms</li>
<li>Apply secure coding practices to prevent common vulnerabilities</li>
<li>Properly validate and sanitize user input to prevent injection attacks</li>
<li>Use encryption appropriately for data at rest and in transit</li>
<li>Configure security headers to protect against client-side attacks</li>
<li>Establish a vulnerability management process for dependencies</li>
<li>Design and execute security testing strategies</li>
<li>Respond effectively to security incidents</li>
</ul>
<hr>
</section>
<section id="the-imperative-of-software-security" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="the-imperative-of-software-security"><span class="header-section-number">14.2</span> 12.1 The Imperative of Software Security</h2>
<p>Security is not a feature you add at the end of development—it’s a fundamental quality that must be designed into software from the beginning. Every line of code you write, every architectural decision you make, and every third-party component you integrate affects the security posture of your application.</p>
<p>The consequences of security failures are severe and far-reaching. Data breaches expose sensitive personal information, leading to identity theft and financial fraud. Ransomware attacks halt business operations, sometimes permanently. Compromised systems become platforms for attacking others, spreading harm across the internet. Beyond the direct damages, organizations face regulatory penalties, lawsuits, and lasting reputational harm.</p>
<section id="the-cost-of-security-failures" class="level3" data-number="14.2.1">
<h3 data-number="14.2.1" class="anchored" data-anchor-id="the-cost-of-security-failures"><span class="header-section-number">14.2.1</span> 12.1.1 The Cost of Security Failures</h3>
<p>Consider some notable breaches that illustrate what can go wrong:</p>
<p><strong>Equifax (2017)</strong> exposed 147 million people’s Social Security numbers, birth dates, and addresses. The cause? An unpatched vulnerability in the Apache Struts framework that had a fix available two months before the breach. The company paid over $700 million in settlements and suffered immeasurable reputational damage.</p>
<p><strong>Capital One (2019)</strong> lost 100 million customer records including credit scores, payment history, and Social Security numbers. A misconfigured web application firewall allowed an attacker to execute a Server-Side Request Forgery attack, accessing data stored in Amazon S3. One configuration error led to one of the largest bank data breaches in history.</p>
<p><strong>SolarWinds (2020)</strong> demonstrated supply chain attacks at their worst. Attackers compromised the company’s build system, inserting malicious code into software updates. This malware was then distributed to 18,000 organizations including government agencies and Fortune 500 companies, all trusting they were installing legitimate updates.</p>
<p><strong>Log4Shell (2021)</strong> showed how a single vulnerability in a widely-used library can threaten the entire internet. A flaw in Log4j, a Java logging library, allowed remote code execution through log messages. Because Log4j is embedded in countless applications, the vulnerability affected millions of systems worldwide.</p>
<p>These weren’t attacks on small, under-resourced companies—they were sophisticated organizations with security teams and significant budgets. The lesson is clear: security requires constant vigilance at every level, and even one oversight can have catastrophic consequences.</p>
</section>
<section id="security-principles" class="level3" data-number="14.2.2">
<h3 data-number="14.2.2" class="anchored" data-anchor-id="security-principles"><span class="header-section-number">14.2.2</span> 12.1.2 Security Principles</h3>
<p>Before diving into specific vulnerabilities and mitigations, let’s establish foundational security principles that guide secure software development. These principles aren’t just theoretical guidelines—they inform every security decision throughout this chapter and your career.</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    CORE SECURITY PRINCIPLES                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  DEFENSE IN DEPTH                                                       │
│  Layer multiple security controls so that if one fails, others still    │
│  protect the system. Don't rely on a single security measure.           │
│                                                                         │
│  LEAST PRIVILEGE                                                        │
│  Grant only the minimum permissions necessary for a task. Users,        │
│  processes, and systems should have no more access than required.       │
│                                                                         │
│  FAIL SECURELY                                                          │
│  When errors occur, default to a secure state. Don't expose sensitive   │
│  information in error messages or leave systems in vulnerable states.   │
│                                                                         │
│  SEPARATION OF DUTIES                                                   │
│  Divide critical operations so no single person or component has        │
│  complete control. Require multiple parties for sensitive actions.      │
│                                                                         │
│  KEEP IT SIMPLE                                                         │
│  Complexity is the enemy of security. Simpler systems are easier to     │
│  understand, audit, and secure. Avoid unnecessary features.             │
│                                                                         │
│  TRUST NOTHING                                                          │
│  Treat all input as potentially malicious. Verify and validate data     │
│  from users, APIs, databases, and even internal services.               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p>Let’s explore each principle in more depth:</p>
<p><strong>Defense in Depth</strong> recognizes that no single security control is perfect. A firewall might be misconfigured. Input validation might miss an edge case. Authentication might have a flaw. By layering multiple controls, you create a system where an attacker must defeat several defenses, not just one. For example, protecting against SQL injection might involve: input validation at the API layer, parameterized queries in the database layer, least-privilege database accounts, and database activity monitoring. An attacker would need to bypass all four layers.</p>
<p><strong>Least Privilege</strong> limits the damage from any compromise. If your web application runs as the database administrator, a vulnerability in the web app gives attackers full database control. If instead the app uses an account that can only read and write specific tables, attackers gain much less access. Apply this principle everywhere: user accounts, API keys, service accounts, file permissions, and network access.</p>
<p><strong>Fail Securely</strong> means that when something goes wrong, the system should deny access rather than grant it. If authentication fails due to an error connecting to the identity provider, users should not be allowed in by default. Error messages should not reveal sensitive information like stack traces, database schemas, or internal IP addresses. A generic “Something went wrong” message for users with detailed logging server-side is the pattern to follow.</p>
<p><strong>Separation of Duties</strong> prevents any single point of compromise from being catastrophic. Deploying to production might require one person to write code, another to review it, and another to approve the deployment. This way, a single compromised account cannot push malicious code directly to production. Similarly, the system that stores encryption keys should be separate from the system storing encrypted data.</p>
<p><strong>Keep It Simple</strong> acknowledges that every feature is potential attack surface. Unused endpoints, deprecated functions, and unnecessary services all provide opportunities for attackers. The more complex a system, the harder it is to reason about its security properties. Prefer well-tested libraries over custom implementations, especially for security-critical functions like cryptography.</p>
<p><strong>Trust Nothing</strong> is sometimes called “Zero Trust” architecture. Traditional security assumed that once you were inside the network perimeter, you could be trusted. Modern security assumes that any component might be compromised and requires verification at every boundary. Even internal microservices should authenticate to each other and validate all inputs.</p>
</section>
<section id="the-security-mindset" class="level3" data-number="14.2.3">
<h3 data-number="14.2.3" class="anchored" data-anchor-id="the-security-mindset"><span class="header-section-number">14.2.3</span> 12.1.3 The Security Mindset</h3>
<p>Developing secure software requires thinking differently than typical feature development. Most programming teaches you to think about the “happy path”—what happens when users provide valid input and systems work correctly. Security requires thinking about the “adversarial path”—what happens when someone actively tries to make things go wrong.</p>
<p>This shift in mindset doesn’t come naturally to most developers. We want to trust our users, believe our systems work correctly, and assume inputs are well-formed. Security thinking inverts these assumptions:</p>
<p><strong>Instead of “How do I make this work?”</strong>, ask <strong>“How could this be abused?”</strong> Every feature has potential for misuse. A profile picture upload could be used to host malware. A search function could be used to extract sensitive data. A password reset could be used to take over accounts. Consider each feature from an attacker’s perspective.</p>
<p><strong>Instead of “What input do I expect?”</strong>, ask <strong>“What input could I receive?”</strong> Users might provide empty strings, extremely long strings, strings with special characters, or content designed to exploit interpreters. Form fields might be modified before submission. API requests might be crafted by tools rather than your frontend. Assume every input field is an attack vector.</p>
<p><strong>Instead of “How do I connect these components?”</strong>, ask <strong>“What if this connection is compromised?”</strong> Network communications can be intercepted, modified, or redirected. Services can be impersonated. Responses can be forged. Design systems that verify the integrity and authenticity of all communications.</p>
<p><strong>Instead of “How do I give users what they need?”</strong>, ask <strong>“What’s the minimum access required?”</strong> Every permission granted is a potential avenue of abuse. Instead of granting broad access and hoping it’s not misused, grant minimal access and expand only when necessary, with justification and audit trails.</p>
<p>This mindset doesn’t mean being paranoid—it means being appropriately cautious. Every security decision involves trade-offs between security, usability, and development cost. The goal is making informed decisions about which risks to accept, not achieving perfect security (which is impossible).</p>
<hr>
</section>
</section>
<section id="owasp-top-10-web-application-vulnerabilities" class="level2" data-number="14.3">
<h2 data-number="14.3" class="anchored" data-anchor-id="owasp-top-10-web-application-vulnerabilities"><span class="header-section-number">14.3</span> 12.2 OWASP Top 10 Web Application Vulnerabilities</h2>
<p>The <strong>Open Web Application Security Project (OWASP)</strong> maintains a regularly updated list of the most critical web application security risks. Understanding these vulnerabilities and their mitigations is essential for any developer building web applications.</p>
<p>The OWASP Top 10 represents a broad consensus about which vulnerabilities pose the greatest risks. It’s based on data from hundreds of organizations and reflects real-world attack patterns. The list is updated every few years as the threat landscape evolves. Let’s examine each vulnerability in depth.</p>
<section id="a01-broken-access-control" class="level3" data-number="14.3.1">
<h3 data-number="14.3.1" class="anchored" data-anchor-id="a01-broken-access-control"><span class="header-section-number">14.3.1</span> 12.2.1 A01: Broken Access Control</h3>
<p><strong>Broken Access Control</strong> occurs when users can access resources or perform actions beyond their intended permissions. This was the number one vulnerability in OWASP’s 2021 list, appearing in 94% of tested applications. It moved up from fifth place in 2017, reflecting both its prevalence and its severity.</p>
<p>Access control answers two fundamental questions: “Who is this user?” (authentication) and “What are they allowed to do?” (authorization). Broken access control vulnerabilities arise when authorization checks are missing, incorrectly implemented, or can be bypassed.</p>
<section id="understanding-access-control-failures" class="level4" data-number="14.3.1.1">
<h4 data-number="14.3.1.1" class="anchored" data-anchor-id="understanding-access-control-failures"><span class="header-section-number">14.3.1.1</span> Understanding Access Control Failures</h4>
<p>There are several common patterns of access control failure:</p>
<p><strong>Insecure Direct Object References (IDOR)</strong> occur when applications use user-controllable input to directly access objects. Imagine a URL like <code>/api/invoices/12345</code> that returns invoice #12345. If the application doesn’t verify that the current user is authorized to view that specific invoice, an attacker can simply try different invoice numbers to access other users’ data. This is surprisingly common—many applications assume that if a user knows an object’s ID, they must be authorized to access it.</p>
<p><strong>Privilege Escalation</strong> happens when users can gain permissions they shouldn’t have. Vertical escalation means a regular user gains administrator privileges. Horizontal escalation means a user accesses another user’s data at the same privilege level. Both indicate failures in authorization logic.</p>
<p><strong>Missing Function-Level Access Control</strong> occurs when applications have administrative or sensitive functions that exist but aren’t properly protected. An attacker might discover that while the admin panel link doesn’t appear for regular users, the <code>/admin</code> endpoint is still accessible if you know the URL. Security through obscurity—hiding features rather than protecting them—is not security at all.</p>
<p><strong>Metadata Manipulation</strong> involves attackers modifying tokens, cookies, hidden fields, or other data to elevate privileges. If a JWT contains a “role” claim that the client can modify, attackers can change their role from “user” to “admin.” Never trust client-controlled data for authorization decisions.</p>
</section>
<section id="implementing-proper-access-control" class="level4" data-number="14.3.1.2">
<h4 data-number="14.3.1.2" class="anchored" data-anchor-id="implementing-proper-access-control"><span class="header-section-number">14.3.1.2</span> Implementing Proper Access Control</h4>
<p>Secure access control requires several layers working together. Let’s walk through a comprehensive implementation, starting with authentication middleware that establishes user identity:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> jwt <span class="op">=</span> <span class="pp">require</span>(<span class="st">'jsonwebtoken'</span>)<span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> authenticate <span class="op">=</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Extract token from Authorization header</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> authHeader <span class="op">=</span> req<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">authorization</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>authHeader <span class="op">||</span> <span class="op">!</span>authHeader<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">'Bearer '</span>)) {</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> <span class="st">'Authentication required. Please provide a valid token.'</span> </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> authHeader<span class="op">.</span><span class="fu">substring</span>(<span class="dv">7</span>)<span class="op">;</span>  <span class="co">// Remove 'Bearer ' prefix</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify token signature and extract payload</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> decoded <span class="op">=</span> jwt<span class="op">.</span><span class="fu">verify</span>(token<span class="op">,</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">JWT_SECRET</span>)<span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load full user record from database</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Don't rely solely on token contents - verify user still exists and is active</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'users'</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> decoded<span class="op">.</span><span class="at">userId</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'is_active'</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>user) {</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> <span class="st">'User account not found or inactive.'</span> </span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attach user to request for downstream handlers</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    req<span class="op">.</span><span class="at">user</span> <span class="op">=</span> user<span class="op">;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">===</span> <span class="st">'TokenExpiredError'</span>) {</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Token has expired. Please log in again.'</span> })<span class="op">;</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">===</span> <span class="st">'JsonWebTokenError'</span>) {</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Invalid token.'</span> })<span class="op">;</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>(error)<span class="op">;</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This authentication middleware does more than just validate the token. It also verifies that the user account still exists and is active. This is important because a token might have been issued before an account was deactivated or deleted. Checking the database on every request adds overhead but ensures authorization decisions use current information.</p>
<p>With authentication established, we need authorization middleware to verify the user has permission for specific actions:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Middleware to verify resource ownership</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> authorizeOwner <span class="op">=</span> (resourceUserIdField <span class="op">=</span> <span class="st">'userId'</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> resourceUserId <span class="op">=</span> <span class="pp">parseInt</span>(req<span class="op">.</span><span class="at">params</span>[resourceUserIdField])<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Users can access their own resources</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span> <span class="op">===</span> resourceUserId) {</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Administrators can access any resource</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">role</span> <span class="op">===</span> <span class="st">'admin'</span>) {</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log unauthorized access attempts for security monitoring</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">'Authorization failure:'</span><span class="op">,</span> {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">attemptedBy</span><span class="op">:</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">attemptedResource</span><span class="op">:</span> resourceUserId<span class="op">,</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">path</span><span class="op">:</span> req<span class="op">.</span><span class="at">path</span><span class="op">,</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">403</span>)<span class="op">.</span><span class="fu">json</span>({ </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> <span class="st">'You do not have permission to access this resource.'</span> </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Middleware to require specific roles</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> requireRole <span class="op">=</span> (<span class="op">...</span>allowedRoles) <span class="kw">=&gt;</span> {</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>allowedRoles<span class="op">.</span><span class="fu">includes</span>(req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">role</span>)) {</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">'Role authorization failure:'</span><span class="op">,</span> {</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">user</span><span class="op">:</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">userRole</span><span class="op">:</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">role</span><span class="op">,</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">requiredRoles</span><span class="op">:</span> allowedRoles<span class="op">,</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        <span class="dt">path</span><span class="op">:</span> req<span class="op">.</span><span class="at">path</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">403</span>)<span class="op">.</span><span class="fu">json</span>({ </span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> <span class="st">'You do not have sufficient privileges for this action.'</span> </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>authorizeOwner</code> middleware handles the common case where users should only access their own resources. Rather than checking ownership in every route handler, we centralize this logic in middleware. The middleware also handles the administrative override case—admins can access any resource.</p>
<p>Notice that we log failed authorization attempts. This is crucial for security monitoring. A pattern of failed access attempts might indicate an attacker probing for vulnerabilities or a compromised account being used maliciously.</p>
<p>Now let’s see how these middleware functions protect actual routes:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// User can only access their own profile</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">'/api/users/:userId/profile'</span><span class="op">,</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  authenticate<span class="op">,</span>           <span class="co">// First, verify who they are</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">authorizeOwner</span>(<span class="st">'userId'</span>)<span class="op">,</span> <span class="co">// Then, verify they can access this resource</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'users'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">userId</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">'id'</span><span class="op">,</span> <span class="st">'name'</span><span class="op">,</span> <span class="st">'email'</span><span class="op">,</span> <span class="st">'created_at'</span>)  <span class="co">// Never return password_hash!</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>user) {</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'User not found'</span> })<span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">data</span><span class="op">:</span> user })<span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Only administrators can view all users</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">'/api/admin/users'</span><span class="op">,</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  authenticate<span class="op">,</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requireRole</span>(<span class="st">'admin'</span>)<span class="op">,</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'users'</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">'id'</span><span class="op">,</span> <span class="st">'name'</span><span class="op">,</span> <span class="st">'email'</span><span class="op">,</span> <span class="st">'role'</span><span class="op">,</span> <span class="st">'created_at'</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">orderBy</span>(<span class="st">'created_at'</span><span class="op">,</span> <span class="st">'desc'</span>)<span class="op">;</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">data</span><span class="op">:</span> users })<span class="op">;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each route explicitly declares its security requirements through middleware. This makes the security model visible and auditable. Anyone reviewing the code can immediately see what authentication and authorization is required for each endpoint.</p>
<p><strong>A critical principle</strong>: never trust client input for authorization-sensitive fields. When creating resources, the server should control who owns them:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating a task - server controls ownership</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/tasks'</span><span class="op">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  authenticate<span class="op">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validate</span>(taskSchema)<span class="op">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)<span class="op">.</span><span class="fu">insert</span>({</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> req<span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">title</span><span class="op">,</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">description</span><span class="op">:</span> req<span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">description</span><span class="op">,</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">user_id</span><span class="op">:</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span><span class="op">,</span>  <span class="co">// Always use authenticated user, never req.body.userId</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">'todo'</span><span class="op">,</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created_at</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">returning</span>(<span class="st">'*'</span>)<span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">201</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">data</span><span class="op">:</span> task[<span class="dv">0</span>] })<span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Even if the request body contains a <code>userId</code> field, we ignore it. The task belongs to whoever is authenticated, period. This prevents attackers from creating resources that belong to other users.</p>
</section>
</section>
<section id="a02-cryptographic-failures" class="level3" data-number="14.3.2">
<h3 data-number="14.3.2" class="anchored" data-anchor-id="a02-cryptographic-failures"><span class="header-section-number">14.3.2</span> 12.2.2 A02: Cryptographic Failures</h3>
<p>Previously known as “Sensitive Data Exposure,” this category covers failures related to cryptography—or lack thereof. This includes transmitting data in clear text, using weak cryptographic algorithms, improper key management, and insufficient protection of sensitive data.</p>
<section id="understanding-cryptographic-requirements" class="level4" data-number="14.3.2.1">
<h4 data-number="14.3.2.1" class="anchored" data-anchor-id="understanding-cryptographic-requirements"><span class="header-section-number">14.3.2.1</span> Understanding Cryptographic Requirements</h4>
<p>Different types of data require different cryptographic approaches:</p>
<p><strong>Data in Transit</strong> must be encrypted to prevent eavesdropping. Anyone on the network path between client and server—coffee shop WiFi operators, ISPs, or malicious actors who’ve compromised network equipment—can observe unencrypted traffic. HTTPS (TLS) protects data in transit by encrypting all communication between browsers and servers.</p>
<p><strong>Data at Rest</strong> refers to data stored on disk, in databases, or in backups. Even if attackers can’t intercept network traffic, they might gain access to storage through SQL injection, stolen backups, or physical theft. Sensitive data should be encrypted before storage.</p>
<p><strong>Passwords</strong> require special handling. Unlike other data, passwords should never be recoverable—not even by administrators. We use one-way hashing so that passwords can be verified without being stored.</p>
</section>
<section id="password-hashing-done-right" class="level4" data-number="14.3.2.2">
<h4 data-number="14.3.2.2" class="anchored" data-anchor-id="password-hashing-done-right"><span class="header-section-number">14.3.2.2</span> Password Hashing Done Right</h4>
<p>Passwords are the most commonly mishandled sensitive data. Let’s understand why proper password handling is complex and how to do it correctly.</p>
<p><strong>Why not just encrypt passwords?</strong> Because encryption is reversible—anyone with the key can decrypt them. If an attacker steals your database and encryption key (often stored nearby or in application configuration), they get all passwords in plain text. Hashing is one-way: you can verify that a password hashes to the same value, but you can’t reverse a hash to get the password.</p>
<p><strong>Why not use simple hashing like SHA-256?</strong> Because modern GPUs can compute billions of hashes per second. An attacker who steals hashed passwords can try every possible password until they find matches. A 6-character password has about 2 billion possibilities—that’s seconds of work for a modern GPU.</p>
<p><strong>What about adding a salt?</strong> Salting (adding random data to each password before hashing) prevents precomputed “rainbow table” attacks and ensures identical passwords hash differently. But fast hashing algorithms like SHA-256 are still vulnerable to brute force when salted.</p>
<p><strong>The solution is a deliberately slow hashing algorithm.</strong> bcrypt, scrypt, and Argon2 are designed to be computationally expensive. They include a configurable “work factor” that determines how much computation each hash requires. This makes brute force impractical—if each hash takes 250ms, trying a billion passwords takes 8 years.</p>
<p>Here’s how to implement password hashing properly:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bcrypt <span class="op">=</span> <span class="pp">require</span>(<span class="st">'bcrypt'</span>)<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Work factor of 12 means 2^12 = 4096 iterations</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">// This takes about 250ms on modern hardware</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Increase this as computers get faster</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> SALT_ROUNDS <span class="op">=</span> <span class="dv">12</span><span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">hashPassword</span>(plainPassword) {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// bcrypt generates a random salt and includes it in the output</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The result is a 60-character string containing:</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - Algorithm identifier ($2b$)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - Work factor (12)</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - Salt (22 characters)</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - Hash (31 characters)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> bcrypt<span class="op">.</span><span class="fu">hash</span>(plainPassword<span class="op">,</span> SALT_ROUNDS)<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">verifyPassword</span>(plainPassword<span class="op">,</span> storedHash) {</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// bcrypt extracts the salt from the stored hash,</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// hashes the provided password with that salt,</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// and compares the results in constant time</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> bcrypt<span class="op">.</span><span class="fu">compare</span>(plainPassword<span class="op">,</span> storedHash)<span class="op">;</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The beauty of bcrypt is that everything needed for verification is stored in the hash itself. You don’t need to store the salt separately or remember the work factor—it’s all encoded in the 60-character output string.</p>
<p><strong>Verification timing matters.</strong> The <code>bcrypt.compare</code> function uses constant-time comparison, meaning it takes the same amount of time whether the first character is wrong or the last character is wrong. Without this, attackers could measure response times to guess passwords character by character.</p>
</section>
<section id="encrypting-sensitive-data" class="level4" data-number="14.3.2.3">
<h4 data-number="14.3.2.3" class="anchored" data-anchor-id="encrypting-sensitive-data"><span class="header-section-number">14.3.2.3</span> Encrypting Sensitive Data</h4>
<p>For data that needs to be encrypted (not hashed), use modern authenticated encryption. “Authenticated” means the encryption also verifies that data hasn’t been tampered with—you can’t just decrypt, you also confirm the ciphertext hasn’t been modified.</p>
<p>AES-256-GCM (Advanced Encryption Standard, 256-bit key, Galois/Counter Mode) is the current industry standard:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> crypto <span class="op">=</span> <span class="pp">require</span>(<span class="st">'crypto'</span>)<span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ALGORITHM <span class="op">=</span> <span class="st">'aes-256-gcm'</span><span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> IV_LENGTH <span class="op">=</span> <span class="dv">12</span><span class="op">;</span>  <span class="co">// 96 bits recommended for GCM</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> AUTH_TAG_LENGTH <span class="op">=</span> <span class="dv">16</span><span class="op">;</span>  <span class="co">// 128 bits</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">encrypt</span>(plaintext<span class="op">,</span> key) {</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The initialization vector (IV) must be unique for each encryption</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// with the same key. GCM mode is catastrophically broken if you</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// reuse an IV with the same key - it can reveal the key itself.</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> iv <span class="op">=</span> crypto<span class="op">.</span><span class="fu">randomBytes</span>(IV_LENGTH)<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create cipher using authenticated encryption mode</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cipher <span class="op">=</span> crypto<span class="op">.</span><span class="fu">createCipheriv</span>(ALGORITHM<span class="op">,</span> key<span class="op">,</span> iv)<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Encrypt the data</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> encrypted <span class="op">=</span> cipher<span class="op">.</span><span class="fu">update</span>(plaintext<span class="op">,</span> <span class="st">'utf8'</span><span class="op">,</span> <span class="st">'hex'</span>)<span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  encrypted <span class="op">+=</span> cipher<span class="op">.</span><span class="fu">final</span>(<span class="st">'hex'</span>)<span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get the authentication tag - this ensures integrity</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> authTag <span class="op">=</span> cipher<span class="op">.</span><span class="fu">getAuthTag</span>()<span class="op">;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Return everything needed for decryption</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// IV + AuthTag + Ciphertext</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> iv<span class="op">.</span><span class="fu">toString</span>(<span class="st">'hex'</span>) <span class="op">+</span> authTag<span class="op">.</span><span class="fu">toString</span>(<span class="st">'hex'</span>) <span class="op">+</span> encrypted<span class="op">;</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">decrypt</span>(encryptedData<span class="op">,</span> key) {</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extract components from the combined string</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> iv <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">from</span>(encryptedData<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> IV_LENGTH <span class="op">*</span> <span class="dv">2</span>)<span class="op">,</span> <span class="st">'hex'</span>)<span class="op">;</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> authTag <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">from</span>(</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    encryptedData<span class="op">.</span><span class="fu">slice</span>(IV_LENGTH <span class="op">*</span> <span class="dv">2</span><span class="op">,</span> IV_LENGTH <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> AUTH_TAG_LENGTH <span class="op">*</span> <span class="dv">2</span>)<span class="op">,</span> </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'hex'</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ciphertext <span class="op">=</span> encryptedData<span class="op">.</span><span class="fu">slice</span>(IV_LENGTH <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> AUTH_TAG_LENGTH <span class="op">*</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create decipher and set authentication tag</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> decipher <span class="op">=</span> crypto<span class="op">.</span><span class="fu">createDecipheriv</span>(ALGORITHM<span class="op">,</span> key<span class="op">,</span> iv)<span class="op">;</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  decipher<span class="op">.</span><span class="fu">setAuthTag</span>(authTag)<span class="op">;</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Decrypt - this will throw if authentication fails</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">// (i.e., if the ciphertext has been tampered with)</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> decrypted <span class="op">=</span> decipher<span class="op">.</span><span class="fu">update</span>(ciphertext<span class="op">,</span> <span class="st">'hex'</span><span class="op">,</span> <span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  decrypted <span class="op">+=</span> decipher<span class="op">.</span><span class="fu">final</span>(<span class="st">'utf8'</span>)<span class="op">;</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> decrypted<span class="op">;</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The authentication tag is crucial. Without it, an attacker who intercepts encrypted data could modify it, and you’d decrypt garbage without knowing the data was tampered with. With GCM’s authentication tag, any modification—even a single bit flip—causes decryption to fail.</p>
<p><strong>Key management is often harder than encryption itself.</strong> Where do you store the encryption key? If it’s in your application code, anyone with code access has the key. If it’s in an environment variable, anyone with server access has it. Production systems typically use dedicated key management services (AWS KMS, HashiCorp Vault, Azure Key Vault) that provide hardware-protected key storage, access auditing, and key rotation.</p>
</section>
</section>
<section id="a03-injection" class="level3" data-number="14.3.3">
<h3 data-number="14.3.3" class="anchored" data-anchor-id="a03-injection"><span class="header-section-number">14.3.3</span> 12.2.3 A03: Injection</h3>
<p><strong>Injection</strong> attacks occur when untrusted data is sent to an interpreter as part of a command or query. The interpreter can’t distinguish between intended commands and attacker-supplied data, so it executes whatever it receives. SQL injection, command injection, LDAP injection, and XPath injection are all variants of this fundamental problem.</p>
<p>Injection remains one of the most dangerous and common vulnerability classes. Despite being well-understood with straightforward solutions, injection vulnerabilities continue to appear in new applications and cause major breaches.</p>
<section id="understanding-sql-injection" class="level4" data-number="14.3.3.1">
<h4 data-number="14.3.3.1" class="anchored" data-anchor-id="understanding-sql-injection"><span class="header-section-number">14.3.3.1</span> Understanding SQL Injection</h4>
<p>SQL injection occurs when user input becomes part of a SQL query without proper handling. Let’s trace through exactly how this works:</p>
<p>Consider a login function that checks credentials:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// VULNERABLE CODE - DO NOT USE</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">checkLogin</span>(email<span class="op">,</span> password) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> query <span class="op">=</span> <span class="vs">`SELECT * FROM users WHERE email = '</span><span class="sc">${</span>email<span class="sc">}</span><span class="vs">' AND password = '</span><span class="sc">${</span>password<span class="sc">}</span><span class="vs">'`</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">raw</span>(query)<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">.</span><span class="at">rows</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For a normal user entering <code>alice@example.com</code> and <code>secretpassword</code>, the query becomes:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> users <span class="kw">WHERE</span> email <span class="op">=</span> <span class="st">'alice@example.com'</span> <span class="kw">AND</span> <span class="kw">password</span> <span class="op">=</span> <span class="st">'secretpassword'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This works fine. But what if someone enters the email <code>' OR '1'='1' --</code>? The query becomes:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> users <span class="kw">WHERE</span> email <span class="op">=</span> <span class="st">''</span> <span class="kw">OR</span> <span class="st">'1'</span><span class="op">=</span><span class="st">'1'</span> <span class="co">--' AND password = '...'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s break this down:</p>
<ul>
<li>The attacker’s <code>'</code> closes the email string</li>
<li><code>OR '1'='1'</code> adds a condition that’s always true</li>
<li><code>--</code> is a SQL comment, making the rest of the query (including the password check) irrelevant</li>
</ul>
<p>The query now returns all users, and the attacker logs in as the first user in the database—often an administrator.</p>
<p>It gets worse. An attacker could enter:</p>
<pre><code>'; DROP TABLE users; --</code></pre>
<p>This closes the original query, adds a new command to delete the users table, and comments out the rest. The application would dutifully execute this, destroying all user data.</p>
<p>More sophisticated attacks extract data gradually:</p>
<pre><code>' UNION SELECT password_hash FROM users WHERE email = 'admin@example.com' --</code></pre>
<p>This UNION attack combines results from the original query with data from a completely different query, potentially exposing sensitive information through the application’s normal output.</p>
</section>
<section id="preventing-sql-injection" class="level4" data-number="14.3.3.2">
<h4 data-number="14.3.3.2" class="anchored" data-anchor-id="preventing-sql-injection"><span class="header-section-number">14.3.3.2</span> Preventing SQL Injection</h4>
<p>The solution is <strong>parameterized queries</strong> (also called prepared statements). Instead of building a string with user input, you write a query template with placeholders, and the database driver safely substitutes values:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// SECURE: Using parameterized queries</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">checkLogin</span>(email<span class="op">,</span> password) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The ? placeholders are filled by the driver, which properly escapes values</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">raw</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SELECT * FROM users WHERE email = ? AND password_hash = ?'</span><span class="op">,</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    [email<span class="op">,</span> password]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">.</span><span class="at">rows</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With parameterized queries, the database treats parameters as literal data values, never as SQL code. Even if someone enters <code>' OR '1'='1' --</code> as their email, the database searches for a user with that literal email address (which doesn’t exist) rather than interpreting it as SQL syntax.</p>
<p>Modern query builders make parameterized queries the default:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Using Knex query builder - automatically parameterized</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">getUserByEmail</span>(email) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">db</span>(<span class="st">'users'</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">where</span>(<span class="st">'email'</span><span class="op">,</span> email)  <span class="co">// Knex parameterizes this automatically</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Complex queries remain safe</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">searchTasks</span>(userId<span class="op">,</span> searchTerm<span class="op">,</span> status) {</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">where</span>(<span class="st">'user_id'</span><span class="op">,</span> userId)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">where</span>(<span class="st">'title'</span><span class="op">,</span> <span class="st">'like'</span><span class="op">,</span> <span class="vs">`%</span><span class="sc">${</span>searchTerm<span class="sc">}</span><span class="vs">%`</span>)  <span class="co">// Still parameterized</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">modify</span>((query) <span class="kw">=&gt;</span> {</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (status) {</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        query<span class="op">.</span><span class="fu">where</span>(<span class="st">'status'</span><span class="op">,</span> status)<span class="op">;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">orderBy</span>(<span class="st">'created_at'</span><span class="op">,</span> <span class="st">'desc'</span>)<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The key insight: <strong>never build query strings through concatenation with user input</strong>. Always use parameterized queries or a query builder that parameterizes automatically.</p>
</section>
<section id="command-injection" class="level4" data-number="14.3.3.3">
<h4 data-number="14.3.3.3" class="anchored" data-anchor-id="command-injection"><span class="header-section-number">14.3.3.3</span> Command Injection</h4>
<p>The same principle applies to operating system commands. If user input becomes part of a shell command, attackers can inject additional commands:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// VULNERABLE: User controls part of shell command</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/ping'</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { host } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exec</span>(<span class="vs">`ping -c 1 </span><span class="sc">${</span>host<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> (error<span class="op">,</span> stdout) <span class="kw">=&gt;</span> {</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">send</span>(stdout)<span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Attack: host = "example.com; cat /etc/passwd"</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Executes: ping -c 1 example.com; cat /etc/passwd</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The semicolon ends the first command, and everything after is a new command. The attacker could read sensitive files, install malware, or take complete control of the server.</p>
<p>Prevention follows the same pattern—don’t interpolate user input into commands:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// SECURE: Arguments passed as array, not interpolated into string</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { execFile } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'child_process'</span>)<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/ping'</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { host } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Validate input format</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="ss">/</span><span class="sc">^[a-zA-Z0-9.-]+$</span><span class="ss">/</span><span class="op">.</span><span class="fu">test</span>(host)) {</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">400</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Invalid host format'</span> })<span class="op">;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// execFile doesn't invoke a shell, and arguments are passed separately</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">execFile</span>(<span class="st">'ping'</span><span class="op">,</span> [<span class="st">'-c'</span><span class="op">,</span> <span class="st">'1'</span><span class="op">,</span> host]<span class="op">,</span> (error<span class="op">,</span> stdout) <span class="kw">=&gt;</span> {</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">send</span>(stdout)<span class="op">;</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using <code>execFile</code> instead of <code>exec</code> avoids shell invocation entirely. Arguments are passed directly to the program, not through a shell interpreter, so shell metacharacters like <code>;</code>, <code>|</code>, and <code>&amp;&amp;</code> have no special meaning.</p>
<p>Even better: avoid shell commands entirely when libraries exist. Instead of shelling out to <code>ping</code>, use a Node.js library that implements ICMP directly.</p>
</section>
</section>
<section id="a04-insecure-design" class="level3" data-number="14.3.4">
<h3 data-number="14.3.4" class="anchored" data-anchor-id="a04-insecure-design"><span class="header-section-number">14.3.4</span> 12.2.4 A04: Insecure Design</h3>
<p><strong>Insecure Design</strong> is a newer OWASP category recognizing that some vulnerabilities stem from missing or ineffective security controls at the design phase. You can’t fix insecure design with perfect implementation—the architecture itself must be secure.</p>
<p>This category differs from implementation bugs. A SQL injection vulnerability might be a coding mistake (implementation bug), but a password reset flow that doesn’t rate-limit or verify ownership is a design flaw. Even a “perfect” implementation of a flawed design remains vulnerable.</p>
<section id="design-level-security-thinking" class="level4" data-number="14.3.4.1">
<h4 data-number="14.3.4.1" class="anchored" data-anchor-id="design-level-security-thinking"><span class="header-section-number">14.3.4.1</span> Design-Level Security Thinking</h4>
<p>Consider these scenarios that represent design failures rather than implementation bugs:</p>
<p><strong>A movie theater booking system</strong> allows unlimited reservation attempts. An attacker writes a script that reserves all seats for popular showings, then cancels them just before the payment deadline. Legitimate customers can never book. The implementation might be flawless, but the design failed to consider this abuse pattern.</p>
<p><strong>A banking application</strong> displays full account numbers in transaction histories. Even though access is authenticated and encrypted, customer service representatives who handle support calls can see and potentially misuse this data. The design failed to apply data minimization principles.</p>
<p><strong>An API</strong> uses sequential integer IDs for sensitive resources. Even with proper authentication, attackers can infer information about system activity (how many orders, how many users) by observing ID ranges. This information leakage wasn’t considered during design.</p>
</section>
<section id="secure-design-for-password-reset" class="level4" data-number="14.3.4.2">
<h4 data-number="14.3.4.2" class="anchored" data-anchor-id="secure-design-for-password-reset"><span class="header-section-number">14.3.4.2</span> Secure Design for Password Reset</h4>
<p>Let’s walk through designing a secure password reset flow. This is a common feature that’s often implemented insecurely because the threat model isn’t fully considered during design.</p>
<p><strong>Threat model considerations:</strong></p>
<ul>
<li>Attackers want to take over accounts by resetting passwords they shouldn’t control</li>
<li>Email isn’t encrypted; reset links might be intercepted</li>
<li>Attackers might try to brute-force reset tokens</li>
<li>Attackers might try to enumerate which email addresses are registered</li>
<li>Attackers might flood targets with reset emails (harassment)</li>
<li>Reset tokens might leak through referrer headers or browser history</li>
</ul>
<p><strong>Design decisions that address these threats:</strong></p>
<ol type="1">
<li><strong>Rate limiting</strong> prevents brute-force attacks and email flooding</li>
<li><strong>Consistent responses</strong> prevent email enumeration</li>
<li><strong>Cryptographically random tokens</strong> can’t be predicted</li>
<li><strong>Token hashing</strong> in database means stolen database doesn’t expose valid tokens</li>
<li><strong>Short expiration</strong> limits attack window</li>
<li><strong>Single-use tokens</strong> prevent replay attacks</li>
<li><strong>Session invalidation</strong> after password change removes attacker access</li>
</ol>
<p>Here’s a secure implementation incorporating these design decisions:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> crypto <span class="op">=</span> <span class="pp">require</span>(<span class="st">'crypto'</span>)<span class="op">;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Rate limiting at multiple levels</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> requestResetLimiter <span class="op">=</span> <span class="fu">rateLimit</span>({</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">windowMs</span><span class="op">:</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">,</span>  <span class="co">// 1 hour</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span>                     <span class="co">// 3 requests per IP per hour</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">message</span><span class="op">:</span> { <span class="dt">error</span><span class="op">:</span> <span class="st">'Too many requests. Please try again later.'</span> }</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> resetTokenLimiter <span class="op">=</span> <span class="fu">rateLimit</span>({</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">windowMs</span><span class="op">:</span> <span class="dv">15</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">,</span>  <span class="co">// 15 minutes</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span>                     <span class="co">// 5 attempts to use token</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">message</span><span class="op">:</span> { <span class="dt">error</span><span class="op">:</span> <span class="st">'Too many attempts. Please request a new reset link.'</span> }</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The rate limiting operates at two levels: requesting resets and attempting to use reset tokens. This prevents both email flooding and token brute-forcing.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/auth/forgot-password'</span><span class="op">,</span> requestResetLimiter<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { email } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// IMPORTANT: Always return the same response regardless of whether</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// the email exists. This prevents email enumeration attacks.</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> genericResponse <span class="op">=</span> { </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">message</span><span class="op">:</span> <span class="st">'If an account exists with this email, you will receive a reset link.'</span> </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'email'</span><span class="op">,</span> email<span class="op">.</span><span class="fu">toLowerCase</span>())<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>user) {</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add artificial delay to match timing of successful requests</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(r <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(r<span class="op">,</span> <span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">json</span>(genericResponse)<span class="op">;</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The same response for existing and non-existing emails is critical. Without this, attackers could use the password reset to check which email addresses are registered. The artificial delay ensures consistent timing—without it, responses for non-existent emails would be slightly faster, leaking information.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Generate cryptographically secure token</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 32 bytes = 256 bits of entropy - infeasible to brute force</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> resetToken <span class="op">=</span> crypto<span class="op">.</span><span class="fu">randomBytes</span>(<span class="dv">32</span>)<span class="op">.</span><span class="fu">toString</span>(<span class="st">'hex'</span>)<span class="op">;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Store HASH of token, not the token itself</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If database is compromised, attacker still can't use the hashes</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> tokenHash <span class="op">=</span> crypto<span class="op">.</span><span class="fu">createHash</span>(<span class="st">'sha256'</span>)<span class="op">.</span><span class="fu">update</span>(resetToken)<span class="op">.</span><span class="fu">digest</span>(<span class="st">'hex'</span>)<span class="op">;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'password_resets'</span>)<span class="op">.</span><span class="fu">insert</span>({</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">user_id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">token_hash</span><span class="op">:</span> tokenHash<span class="op">,</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">expires_at</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>(<span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span>)<span class="op">,</span>  <span class="co">// 1 hour</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">created_at</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Send unhashed token in email</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">sendEmail</span>({</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">to</span><span class="op">:</span> user<span class="op">.</span><span class="at">email</span><span class="op">,</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">subject</span><span class="op">:</span> <span class="st">'Password Reset Request'</span><span class="op">,</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">html</span><span class="op">:</span> <span class="vs">`</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;p&gt;Click below to reset your password. This link expires in 1 hour.&lt;/p&gt;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;a href="https://yourapp.com/reset-password?token=</span><span class="sc">${</span>resetToken<span class="sc">}</span><span class="vs">"&gt;</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="vs">        Reset Password</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/a&gt;</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;p&gt;If you didn't request this, you can safely ignore this email.&lt;/p&gt;</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>(genericResponse)<span class="op">;</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We store a hash of the token, not the token itself. This means if attackers somehow access the database (through SQL injection, backup theft, or insider threat), they can’t use the stored hashes—they need the actual token from the email. This is the same principle as password hashing: the database never contains the secret itself.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/auth/reset-password'</span><span class="op">,</span> resetTokenLimiter<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { token<span class="op">,</span> newPassword } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Hash the provided token to compare with stored hash</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> tokenHash <span class="op">=</span> crypto<span class="op">.</span><span class="fu">createHash</span>(<span class="st">'sha256'</span>)<span class="op">.</span><span class="fu">update</span>(token)<span class="op">.</span><span class="fu">digest</span>(<span class="st">'hex'</span>)<span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> resetRequest <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'password_resets'</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">where</span>(<span class="st">'token_hash'</span><span class="op">,</span> tokenHash)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">where</span>(<span class="st">'expires_at'</span><span class="op">,</span> <span class="st">'&gt;'</span><span class="op">,</span> <span class="kw">new</span> <span class="bu">Date</span>())</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">where</span>(<span class="st">'used_at'</span><span class="op">,</span> <span class="kw">null</span>)  <span class="co">// Single-use check</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>resetRequest) {</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">400</span>)<span class="op">.</span><span class="fu">json</span>({ </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> <span class="st">'Invalid or expired reset link.'</span> </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The query checks three things: the token matches, it hasn’t expired, and it hasn’t been used. All three must be true.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Validate new password meets requirements</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> passwordErrors <span class="op">=</span> <span class="fu">validatePasswordStrength</span>(newPassword)<span class="op">;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (passwordErrors<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">400</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> passwordErrors[<span class="dv">0</span>] })<span class="op">;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> passwordHash <span class="op">=</span> <span class="cf">await</span> bcrypt<span class="op">.</span><span class="fu">hash</span>(newPassword<span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use transaction to ensure all changes succeed or none do</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> db<span class="op">.</span><span class="fu">transaction</span>(<span class="kw">async</span> (trx) <span class="kw">=&gt;</span> {</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update password</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">trx</span>(<span class="st">'users'</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> resetRequest<span class="op">.</span><span class="at">user_id</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">update</span>({ <span class="dt">password_hash</span><span class="op">:</span> passwordHash })<span class="op">;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mark token as used (single-use enforcement)</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">trx</span>(<span class="st">'password_resets'</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> resetRequest<span class="op">.</span><span class="at">id</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">update</span>({ <span class="dt">used_at</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>() })<span class="op">;</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Invalidate ALL sessions for this user</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If attacker had access, they're now locked out</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">trx</span>(<span class="st">'sessions'</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'user_id'</span><span class="op">,</span> resetRequest<span class="op">.</span><span class="at">user_id</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">delete</span>()<span class="op">;</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">trx</span>(<span class="st">'refresh_tokens'</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'user_id'</span><span class="op">,</span> resetRequest<span class="op">.</span><span class="at">user_id</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">update</span>({ <span class="dt">revoked_at</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>() })<span class="op">;</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">message</span><span class="op">:</span> <span class="st">'Password updated successfully. Please log in.'</span> })<span class="op">;</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The session invalidation is a key security feature. If an attacker had compromised the account and the legitimate user recovers it via password reset, all of the attacker’s sessions are terminated. Without this, the attacker would remain logged in even after the password change.</p>
</section>
</section>
<section id="a05-security-misconfiguration" class="level3" data-number="14.3.5">
<h3 data-number="14.3.5" class="anchored" data-anchor-id="a05-security-misconfiguration"><span class="header-section-number">14.3.5</span> 12.2.5 A05: Security Misconfiguration</h3>
<p><strong>Security Misconfiguration</strong> is the most commonly seen vulnerability. It results from insecure default configurations, incomplete or ad hoc configurations, open cloud storage, misconfigured HTTP headers, verbose error messages containing sensitive information, or unnecessary services enabled.</p>
<p>This vulnerability is particularly insidious because many applications are vulnerable by default. Security must be actively configured; it’s rarely automatic.</p>
<section id="common-misconfiguration-patterns" class="level4" data-number="14.3.5.1">
<h4 data-number="14.3.5.1" class="anchored" data-anchor-id="common-misconfiguration-patterns"><span class="header-section-number">14.3.5.1</span> Common Misconfiguration Patterns</h4>
<p><strong>Default Credentials</strong> remain unchanged in production. Database systems ship with well-known default passwords. Administrative interfaces use “admin/admin.” Cloud services provide sample keys. These defaults are documented publicly, making exploitation trivial.</p>
<p><strong>Debug Mode in Production</strong> exposes detailed error messages, stack traces, and sometimes interactive debuggers. What helps developers troubleshoot also helps attackers understand your system internals. Django’s debug mode shows complete settings including database credentials. Node.js detailed errors reveal file paths and code structure.</p>
<p><strong>Unnecessary Services</strong> increase attack surface. Sample applications installed with web servers become entry points. Unused API endpoints remain accessible. Administrative interfaces meant for internal use are exposed to the internet. Every feature is a potential vulnerability.</p>
<p><strong>Missing Security Headers</strong> leave browsers without security instructions. Without Content-Security-Policy, browsers execute any script. Without Strict-Transport-Security, users can be downgraded to HTTP. Without X-Frame-Options, your site can be embedded in malicious frames.</p>
<p><strong>Overly Permissive CORS</strong> allows any website to make authenticated requests to your API. If <code>Access-Control-Allow-Origin: *</code> is combined with <code>Access-Control-Allow-Credentials: true</code>, any website can act as the user.</p>
</section>
<section id="secure-configuration" class="level4" data-number="14.3.5.2">
<h4 data-number="14.3.5.2" class="anchored" data-anchor-id="secure-configuration"><span class="header-section-number">14.3.5.2</span> Secure Configuration</h4>
<p>A properly configured Express.js application addresses these issues systematically:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">'express'</span>)<span class="op">;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> helmet <span class="op">=</span> <span class="pp">require</span>(<span class="st">'helmet'</span>)<span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()<span class="op">;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> isProduction <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">'production'</span><span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Helmet sets many security headers with sensible defaults</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">helmet</span>())<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Helmet is a collection of middleware that sets security-related HTTP headers. With one line, you get reasonable defaults for X-Content-Type-Options, X-Frame-Options, Strict-Transport-Security, and more. Let’s customize it for our needs:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">helmet</span>({</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Content Security Policy - controls which resources can load</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">contentSecurityPolicy</span><span class="op">:</span> {</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">directives</span><span class="op">:</span> {</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">defaultSrc</span><span class="op">:</span> [<span class="st">"'self'"</span>]<span class="op">,</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">scriptSrc</span><span class="op">:</span> [<span class="st">"'self'"</span>]<span class="op">,</span>  <span class="co">// Only scripts from our domain</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">styleSrc</span><span class="op">:</span> [<span class="st">"'self'"</span><span class="op">,</span> <span class="st">"'unsafe-inline'"</span>]<span class="op">,</span>  <span class="co">// Styles from our domain</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">imgSrc</span><span class="op">:</span> [<span class="st">"'self'"</span><span class="op">,</span> <span class="st">"data:"</span><span class="op">,</span> <span class="st">"https:"</span>]<span class="op">,</span>  <span class="co">// Images from anywhere over HTTPS</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">connectSrc</span><span class="op">:</span> [<span class="st">"'self'"</span><span class="op">,</span> <span class="st">"https://api.ourapp.com"</span>]<span class="op">,</span>  <span class="co">// API connections</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontSrc</span><span class="op">:</span> [<span class="st">"'self'"</span>]<span class="op">,</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">objectSrc</span><span class="op">:</span> [<span class="st">"'none'"</span>]<span class="op">,</span>  <span class="co">// No Flash, Java applets, etc.</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">frameAncestors</span><span class="op">:</span> [<span class="st">"'none'"</span>]<span class="op">,</span>  <span class="co">// Can't be embedded in frames</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">upgradeInsecureRequests</span><span class="op">:</span> []<span class="op">,</span>  <span class="co">// Upgrade HTTP to HTTPS</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Force HTTPS for one year, including subdomains</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">hsts</span><span class="op">:</span> {</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxAge</span><span class="op">:</span> <span class="dv">31536000</span><span class="op">,</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">includeSubDomains</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">preload</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Content-Security-Policy (CSP) deserves special attention. It tells browsers which resources are allowed to load and execute. Even if an attacker injects a script tag through XSS, the browser won’t execute it if scripts from that source aren’t allowed by CSP. This is defense in depth—CSP protects against XSS even when input sanitization fails.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">// CORS configuration - allow only specific origins</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> corsOptions <span class="op">=</span> {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">origin</span><span class="op">:</span> isProduction </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">?</span> [<span class="st">'https://ourapp.com'</span><span class="op">,</span> <span class="st">'https://www.ourapp.com'</span>]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span> [<span class="st">'http://localhost:3000'</span>]<span class="op">,</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">methods</span><span class="op">:</span> [<span class="st">'GET'</span><span class="op">,</span> <span class="st">'POST'</span><span class="op">,</span> <span class="st">'PUT'</span><span class="op">,</span> <span class="st">'PATCH'</span><span class="op">,</span> <span class="st">'DELETE'</span>]<span class="op">,</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">allowedHeaders</span><span class="op">:</span> [<span class="st">'Content-Type'</span><span class="op">,</span> <span class="st">'Authorization'</span>]<span class="op">,</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">credentials</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>  <span class="co">// Allow cookies</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxAge</span><span class="op">:</span> <span class="dv">86400</span><span class="op">,</span>  <span class="co">// Cache preflight for 24 hours</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>(corsOptions))<span class="op">;</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Don't reveal technology stack</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">disable</span>(<span class="st">'x-powered-by'</span>)<span class="op">;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Limit request body size to prevent DoS</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(express<span class="op">.</span><span class="fu">json</span>({ <span class="dt">limit</span><span class="op">:</span> <span class="st">'10kb'</span> }))<span class="op">;</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(express<span class="op">.</span><span class="fu">urlencoded</span>({ <span class="dt">extended</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">limit</span><span class="op">:</span> <span class="st">'10kb'</span> }))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The CORS configuration explicitly lists allowed origins rather than using wildcards. The <code>x-powered-by</code> header is disabled because revealing “Express” (or “PHP” or “ASP.NET”) helps attackers identify which vulnerabilities might apply. Body size limits prevent attackers from overwhelming the server with enormous payloads.</p>
<p>Error handling must balance developer needs with security:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Error handling middleware</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Always log full error details for debugging</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'Error:'</span><span class="op">,</span> {</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">message</span><span class="op">:</span> err<span class="op">.</span><span class="at">message</span><span class="op">,</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">stack</span><span class="op">:</span> err<span class="op">.</span><span class="at">stack</span><span class="op">,</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">path</span><span class="op">:</span> req<span class="op">.</span><span class="at">path</span><span class="op">,</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> req<span class="op">.</span><span class="at">method</span><span class="op">,</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ip</span><span class="op">:</span> req<span class="op">.</span><span class="at">ip</span><span class="op">,</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">user</span><span class="op">:</span> req<span class="op">.</span><span class="at">user</span><span class="op">?.</span><span class="at">id</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine what to send to client</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> statusCode <span class="op">=</span> err<span class="op">.</span><span class="at">statusCode</span> <span class="op">||</span> <span class="dv">500</span><span class="op">;</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (isProduction) {</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// In production, never expose internals</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> safeMessage <span class="op">=</span> statusCode <span class="op">&gt;=</span> <span class="dv">500</span> </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> <span class="st">'An unexpected error occurred'</span>  <span class="co">// Generic for server errors</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> err<span class="op">.</span><span class="at">message</span><span class="op">;</span>  <span class="co">// Client errors are usually safe to show</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(statusCode)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> { <span class="dt">message</span><span class="op">:</span> safeMessage }</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// In development, show everything for debugging</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(statusCode)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> err<span class="op">.</span><span class="at">message</span><span class="op">,</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stack</span><span class="op">:</span> err<span class="op">.</span><span class="at">stack</span><span class="op">,</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">details</span><span class="op">:</span> err<span class="op">.</span><span class="at">details</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In production, server errors (500s) get a generic message. We don’t want to tell attackers that “PostgreSQL connection failed to 10.0.3.42:5432” or “Cannot read property ‘id’ of undefined at /app/services/user.js:47.” These details help attackers understand our infrastructure and code. In development, we show everything because debugging trumps security concerns.</p>
</section>
</section>
<section id="a06-vulnerable-and-outdated-components" class="level3" data-number="14.3.6">
<h3 data-number="14.3.6" class="anchored" data-anchor-id="a06-vulnerable-and-outdated-components"><span class="header-section-number">14.3.6</span> 12.2.6 A06: Vulnerable and Outdated Components</h3>
<p>Modern applications rely heavily on third-party code. A typical Node.js application has hundreds of dependencies, each with their own dependencies (transitive dependencies). Any of these might contain security vulnerabilities.</p>
<section id="the-scale-of-the-problem" class="level4" data-number="14.3.6.1">
<h4 data-number="14.3.6.1" class="anchored" data-anchor-id="the-scale-of-the-problem"><span class="header-section-number">14.3.6.1</span> The Scale of the Problem</h4>
<p>Consider the mathematics: if your application has 500 dependencies and each has a 1% chance of having a vulnerability, the probability that at least one is vulnerable is over 99%. When vulnerabilities are discovered (and they’re discovered constantly), you’re in a race with attackers to patch before exploitation.</p>
<p>Real-world examples illustrate the severity:</p>
<p><strong>Log4Shell (2021)</strong> was a critical vulnerability in Log4j, a Java logging library. The flaw allowed remote code execution—an attacker could take complete control of any system running vulnerable Log4j by sending a specially crafted log message. Because Log4j is ubiquitous in Java applications, the impact was enormous: hundreds of millions of devices were vulnerable.</p>
<p><strong>event-stream (2018)</strong> showed supply chain attacks in JavaScript. An attacker contributed to a popular npm package, gained maintainer access, and added a dependency that contained malicious code targeting Bitcoin wallets. The malicious code was hidden in minified JavaScript and went unnoticed for months.</p>
<p><strong>left-pad (2016)</strong> demonstrated fragility in dependency chains. When a developer unpublished a popular 11-line npm package after a dispute, thousands of builds worldwide broke, including major projects like React and Babel. While not a security incident per se, it showed how deeply nested dependencies create systemic risk.</p>
</section>
<section id="managing-dependency-security" class="level4" data-number="14.3.6.2">
<h4 data-number="14.3.6.2" class="anchored" data-anchor-id="managing-dependency-security"><span class="header-section-number">14.3.6.2</span> Managing Dependency Security</h4>
<p>The first step is knowing what you depend on. Generate a software bill of materials:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List all dependencies and their versions</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> list <span class="at">--all</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Output includes the dependency tree:</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># taskflow-api@1.0.0</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ├── bcrypt@5.1.0</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co"># │   ├── @mapbox/node-pre-gyp@1.0.10</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># │   │   ├── detect-libc@2.0.1</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># │   │   ├── https-proxy-agent@5.0.1</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co"># │   │   │   └── ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This tree can be hundreds or thousands of lines. That’s hundreds or thousands of potential vulnerabilities.</p>
<p>Automated scanning catches known vulnerabilities:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Built-in npm audit</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> audit</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Output shows vulnerabilities by severity:</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                        Manual Review</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">#              Critical  High  Moderate  Low</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   Dependency    0       2       5       3</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Run `npm audit fix` to attempt automatic fixes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>npm audit</code> checks your dependencies against a database of known vulnerabilities. It’s free, fast, and should be run regularly—ideally on every CI/CD build.</p>
<p>For more comprehensive scanning, tools like Snyk provide additional features:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/security.yml</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Security Scan</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">,</span><span class="at"> develop</span><span class="kw">]</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">cron</span><span class="kw">:</span><span class="at"> </span><span class="st">'0 0 * * *'</span><span class="co">  # Daily scan catches newly disclosed vulnerabilities</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">dependency-scan</span><span class="kw">:</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run npm audit</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm audit --audit-level=high</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run Snyk scan</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> snyk/actions/node@master</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">SNYK_TOKEN</span><span class="kw">:</span><span class="at"> ${{ secrets.SNYK_TOKEN }}</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">args</span><span class="kw">:</span><span class="at"> --severity-threshold=high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The daily scheduled scan is important. A dependency that was safe yesterday might have a vulnerability disclosed today. Continuous scanning catches these new vulnerabilities quickly.</p>
<p><strong>Keeping dependencies updated</strong> is the most effective mitigation:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># See which packages have updates available</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> outdated</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Package         Current  Wanted  Latest</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># express         4.17.1   4.17.3  4.18.2</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># lodash          4.17.19  4.17.21 4.17.21</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># jsonwebtoken    8.5.1    8.5.1   9.0.0</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Update to latest compatible versions (respects semver in package.json)</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> update</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Update major versions (may have breaking changes)</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install express@latest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Balance security with stability. Patch versions (4.17.1 → 4.17.3) are usually safe to apply immediately. Minor versions might add features but shouldn’t break anything. Major versions may have breaking changes requiring code updates. In production systems, test updates in staging before deploying.</p>
</section>
</section>
<section id="a07-identification-and-authentication-failures" class="level3" data-number="14.3.7">
<h3 data-number="14.3.7" class="anchored" data-anchor-id="a07-identification-and-authentication-failures"><span class="header-section-number">14.3.7</span> 12.2.7 A07: Identification and Authentication Failures</h3>
<p>Authentication verifies identity: “Who are you?” This seemingly simple question has many opportunities for failure. Weak passwords, exposed credentials, session hijacking, and brute force attacks all exploit authentication weaknesses.</p>
<section id="password-policies" class="level4" data-number="14.3.7.1">
<h4 data-number="14.3.7.1" class="anchored" data-anchor-id="password-policies"><span class="header-section-number">14.3.7.1</span> Password Policies</h4>
<p>The first defense is ensuring users create strong passwords. However, password policies have evolved significantly. Traditional policies requiring uppercase, lowercase, numbers, and symbols every 90 days have been shown to result in weaker passwords (users write them down or create predictable patterns like <code>Summer2024!</code>).</p>
<p>Modern guidance from NIST (National Institute of Standards and Technology) recommends:</p>
<ul>
<li>Minimum 8 characters (longer is better; consider 12+ character minimum)</li>
<li>Check against breached password databases</li>
<li>No arbitrary complexity requirements</li>
<li>No forced rotation unless compromise is suspected</li>
<li>Allow paste (enables password managers)</li>
</ul>
<p>Implementing breached password checking:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> crypto <span class="op">=</span> <span class="pp">require</span>(<span class="st">'crypto'</span>)<span class="op">;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> https <span class="op">=</span> <span class="pp">require</span>(<span class="st">'https'</span>)<span class="op">;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">isPasswordBreached</span>(password) {</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Hash the password with SHA-1 (required by HaveIBeenPwned API)</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> hash <span class="op">=</span> crypto<span class="op">.</span><span class="fu">createHash</span>(<span class="st">'sha1'</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">update</span>(password)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">digest</span>(<span class="st">'hex'</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">toUpperCase</span>()<span class="op">;</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Send only first 5 characters to the API (k-anonymity)</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// This means the API never sees the full hash</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> prefix <span class="op">=</span> hash<span class="op">.</span><span class="fu">substring</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> suffix <span class="op">=</span> hash<span class="op">.</span><span class="fu">substring</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Query the HaveIBeenPwned API</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`https://api.pwnedpasswords.com/range/</span><span class="sc">${</span>prefix<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> text <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Response contains all hash suffixes with that prefix</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if our suffix is in the list</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> lines <span class="op">=</span> text<span class="op">.</span><span class="fu">split</span>(<span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)<span class="op">;</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> line <span class="kw">of</span> lines) {</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> [hashSuffix<span class="op">,</span> count] <span class="op">=</span> line<span class="op">.</span><span class="fu">split</span>(<span class="st">':'</span>)<span class="op">;</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (hashSuffix <span class="op">===</span> suffix) {</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>  <span class="co">// Password has been breached</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This uses the HaveIBeenPwned API with k-anonymity: we only send the first 5 characters of the hash, so the service never learns the actual password. If a password appears in any data breach, users should choose a different one.</p>
</section>
<section id="brute-force-protection" class="level4" data-number="14.3.7.2">
<h4 data-number="14.3.7.2" class="anchored" data-anchor-id="brute-force-protection"><span class="header-section-number">14.3.7.2</span> Brute Force Protection</h4>
<p>Without protection, attackers can try thousands of passwords per second. Rate limiting makes brute force impractical:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> loginAttempts <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span>  <span class="co">// In production, use Redis for distributed systems</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">checkBruteForce</span>(email<span class="op">,</span> ip) {</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> key <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>email<span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>ip<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attempts <span class="op">=</span> loginAttempts<span class="op">.</span><span class="fu">get</span>(key) <span class="op">||</span> { <span class="dt">count</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">blockedUntil</span><span class="op">:</span> <span class="kw">null</span> }<span class="op">;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if currently blocked</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (attempts<span class="op">.</span><span class="at">blockedUntil</span> <span class="op">&amp;&amp;</span> attempts<span class="op">.</span><span class="at">blockedUntil</span> <span class="op">&gt;</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()) {</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> waitMinutes <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">ceil</span>((attempts<span class="op">.</span><span class="at">blockedUntil</span> <span class="op">-</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()) <span class="op">/</span> <span class="dv">60000</span>)<span class="op">;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Too many attempts. Try again in </span><span class="sc">${</span>waitMinutes<span class="sc">}</span><span class="vs"> minutes.`</span>)<span class="op">;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> attempts<span class="op">;</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">recordLoginAttempt</span>(email<span class="op">,</span> ip<span class="op">,</span> success) {</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> key <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>email<span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>ip<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (success) {</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear attempts on successful login</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    loginAttempts<span class="op">.</span><span class="fu">delete</span>(key)<span class="op">;</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Increment failed attempts</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> attempts <span class="op">=</span> loginAttempts<span class="op">.</span><span class="fu">get</span>(key) <span class="op">||</span> { <span class="dt">count</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">blockedUntil</span><span class="op">:</span> <span class="kw">null</span> }<span class="op">;</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>  attempts<span class="op">.</span><span class="at">count</span><span class="op">++;</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Progressive lockout: longer blocks for more attempts</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (attempts<span class="op">.</span><span class="at">count</span> <span class="op">&gt;=</span> <span class="dv">10</span>) {</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    attempts<span class="op">.</span><span class="at">blockedUntil</span> <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span>  <span class="co">// 1 hour</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (attempts<span class="op">.</span><span class="at">count</span> <span class="op">&gt;=</span> <span class="dv">5</span>) {</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    attempts<span class="op">.</span><span class="at">blockedUntil</span> <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="dv">15</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span>  <span class="co">// 15 minutes</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (attempts<span class="op">.</span><span class="at">count</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    attempts<span class="op">.</span><span class="at">blockedUntil</span> <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="dv">1</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span>  <span class="co">// 1 minute</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>  loginAttempts<span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> attempts)<span class="op">;</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Progressive lockout increases the delay with each failed attempt. Three failures get a 1-minute block; five failures get 15 minutes; ten failures get an hour. This allows for genuine typos while making brute force impractical.</p>
</section>
<section id="secure-session-management" class="level4" data-number="14.3.7.3">
<h4 data-number="14.3.7.3" class="anchored" data-anchor-id="secure-session-management"><span class="header-section-number">14.3.7.3</span> Secure Session Management</h4>
<p>After authentication, sessions maintain logged-in state. Session tokens must be unpredictable, securely stored, and properly invalidated.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Secure cookie settings for session tokens</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sessionCookie <span class="op">=</span> {</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">httpOnly</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>    <span class="co">// JavaScript cannot access the cookie</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">secure</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>      <span class="co">// Only sent over HTTPS</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sameSite</span><span class="op">:</span> <span class="st">'strict'</span><span class="op">,</span> <span class="co">// Not sent with cross-site requests</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxAge</span><span class="op">:</span> <span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">,</span>  <span class="co">// 24 hours</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">path</span><span class="op">:</span> <span class="st">'/'</span><span class="op">,</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>HttpOnly</strong> is crucial for defense against XSS. Even if an attacker injects JavaScript that executes in the browser, that script cannot read httpOnly cookies. Without this flag, <code>document.cookie</code> exposes session tokens to attackers.</p>
<p><strong>Secure</strong> ensures cookies are only sent over HTTPS. Without this, session tokens would be transmitted in clear text over HTTP connections, vulnerable to eavesdropping.</p>
<p><strong>SameSite: strict</strong> prevents the browser from sending the cookie with any cross-origin request. This largely eliminates Cross-Site Request Forgery (CSRF) attacks because the attacker’s site can’t make authenticated requests on the user’s behalf.</p>
</section>
</section>
<section id="a08-software-and-data-integrity-failures" class="level3" data-number="14.3.8">
<h3 data-number="14.3.8" class="anchored" data-anchor-id="a08-software-and-data-integrity-failures"><span class="header-section-number">14.3.8</span> 12.2.8 A08: Software and Data Integrity Failures</h3>
<p>This category covers failures to protect against unauthorized modifications to code or data. CI/CD pipeline compromises, malicious package updates, and insecure deserialization fall under this heading.</p>
<section id="supply-chain-security" class="level4" data-number="14.3.8.1">
<h4 data-number="14.3.8.1" class="anchored" data-anchor-id="supply-chain-security"><span class="header-section-number">14.3.8.1</span> Supply Chain Security</h4>
<p>Your application’s security depends on every component in its supply chain: source code management, build systems, dependency sources, and deployment pipelines. A compromise anywhere affects the final product.</p>
<p><strong>Secure your CI/CD pipeline:</strong></p>
<ul>
<li>Require code review for all changes</li>
<li>Sign commits with GPG keys</li>
<li>Use pinned dependency versions (lock files)</li>
<li>Verify checksums of downloaded artifacts</li>
<li>Limit who can modify build configurations</li>
<li>Audit pipeline access and changes</li>
</ul>
<p><strong>Verify dependency integrity:</strong></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">package-lock.json</span> <span class="er">includes</span> <span class="er">integrity</span> <span class="er">hashes</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"packages"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"node_modules/express"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"version"</span><span class="fu">:</span> <span class="st">"4.18.2"</span><span class="fu">,</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"resolved"</span><span class="fu">:</span> <span class="st">"https://registry.npmjs.org/express/-/express-4.18.2.tgz"</span><span class="fu">,</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"integrity"</span><span class="fu">:</span> <span class="st">"sha512-5/PsL6iGPdfQ/lKM1UuielYgv3BUoJfz1aUwU9vHZ+J7gyvwdQXFEBIEIaxeGf0GIcreATNyBExtalisDbuMqQ=="</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>integrity</code> field contains a hash of the package. npm automatically verifies this hash when installing. If someone tampers with the package on the registry, the hash won’t match and installation fails.</p>
<p><strong>Always commit your lock file</strong> (<code>package-lock.json</code>, <code>yarn.lock</code>). Without it, builds might install different dependency versions at different times, potentially introducing vulnerable or malicious versions.</p>
</section>
<section id="unsafe-deserialization" class="level4" data-number="14.3.8.2">
<h4 data-number="14.3.8.2" class="anchored" data-anchor-id="unsafe-deserialization"><span class="header-section-number">14.3.8.2</span> Unsafe Deserialization</h4>
<p>Deserialization—converting data formats back into objects—can be dangerous when the data comes from untrusted sources. Some serialization formats allow embedded code that executes during deserialization.</p>
<p>This is particularly dangerous in languages like PHP, Python, and Ruby where serialization formats can include arbitrary objects with code that executes on instantiation. In JavaScript, the primary risk comes from libraries that extend JSON with code execution capabilities:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">// DANGEROUS: Libraries that deserialize with code execution</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> nodeSerialize <span class="op">=</span> <span class="pp">require</span>(<span class="st">'node-serialize'</span>)<span class="op">;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/data'</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// This can execute arbitrary code!</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> nodeSerialize<span class="op">.</span><span class="fu">unserialize</span>(req<span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">payload</span>)<span class="op">;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>(data)<span class="op">;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Attack payload: Functions embedded in serialized data</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">// get executed during deserialization</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>The solution is simple: use safe formats.</strong> JSON.parse() is safe—it creates data structures but never executes code. Never use serialization formats that support code execution for untrusted data.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">// SAFE: JSON.parse only creates data, never executes code</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/data'</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(req<span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">payload</span>)<span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Still validate the structure!</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> validated <span class="op">=</span> dataSchema<span class="op">.</span><span class="fu">validate</span>(data)<span class="op">;</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (validated<span class="op">.</span><span class="at">error</span>) {</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">400</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Invalid data format'</span> })<span class="op">;</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>(validated<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Even with safe deserialization, always validate that the resulting data structure matches expectations. Validation catches malformed data whether it results from attacks or bugs.</p>
</section>
</section>
<section id="a09-security-logging-and-monitoring-failures" class="level3" data-number="14.3.9">
<h3 data-number="14.3.9" class="anchored" data-anchor-id="a09-security-logging-and-monitoring-failures"><span class="header-section-number">14.3.9</span> 12.2.9 A09: Security Logging and Monitoring Failures</h3>
<p>Without proper logging and monitoring, attacks go undetected. Organizations average 287 days to identify and contain a breach—faster detection significantly reduces damage.</p>
<section id="what-to-log" class="level4" data-number="14.3.9.1">
<h4 data-number="14.3.9.1" class="anchored" data-anchor-id="what-to-log"><span class="header-section-number">14.3.9.1</span> What to Log</h4>
<p>Security-relevant events require logging:</p>
<p><strong>Authentication events</strong>: Every login attempt (successful and failed), logout, password change, and account lockout. Failed logins indicate attacks; unusual successful logins might be account compromise.</p>
<p><strong>Authorization failures</strong>: When users try to access resources they shouldn’t. A pattern of failures might indicate an attacker probing for vulnerabilities or testing stolen credentials.</p>
<p><strong>Input validation failures</strong>: Unusual inputs often indicate attack attempts. Logging these helps identify attacks in progress and understand attacker techniques.</p>
<p><strong>Administrative actions</strong>: Any action by privileged users should be auditable. If an insider goes rogue or an admin account is compromised, you need to know what they did.</p>
<p><strong>Errors and exceptions</strong>: Application errors might indicate attacks. SQL errors could mean injection attempts. Parsing errors might signal malformed attack payloads.</p>
</section>
<section id="how-to-log-securely" class="level4" data-number="14.3.9.2">
<h4 data-number="14.3.9.2" class="anchored" data-anchor-id="how-to-log-securely"><span class="header-section-number">14.3.9.2</span> How to Log Securely</h4>
<p>Logging itself introduces security concerns:</p>
<p><strong>Don’t log sensitive data.</strong> Never log passwords, credit card numbers, or personal information. If logs are exposed, they shouldn’t contain exploitable data.</p>
<p><strong>Include context.</strong> Who took the action? From what IP address? What were they trying to do? Timestamp everything. Context turns logs from noise into intelligence.</p>
<p><strong>Protect log integrity.</strong> Attackers who compromise a system often try to delete logs covering their tracks. Write logs to a separate system they can’t access. Consider append-only storage.</p>
<p><strong>Make logs searchable.</strong> Logs are useless if you can’t find relevant entries. Use structured logging (JSON format) and centralized log management.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> winston <span class="op">=</span> <span class="pp">require</span>(<span class="st">'winston'</span>)<span class="op">;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> securityLogger <span class="op">=</span> winston<span class="op">.</span><span class="fu">createLogger</span>({</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">level</span><span class="op">:</span> <span class="st">'info'</span><span class="op">,</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> winston<span class="op">.</span><span class="at">format</span><span class="op">.</span><span class="fu">combine</span>(</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    winston<span class="op">.</span><span class="at">format</span><span class="op">.</span><span class="fu">timestamp</span>()<span class="op">,</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    winston<span class="op">.</span><span class="at">format</span><span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  )<span class="op">,</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">transports</span><span class="op">:</span> [</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> winston<span class="op">.</span><span class="at">transports</span><span class="op">.</span><span class="fu">File</span>({ <span class="dt">filename</span><span class="op">:</span> <span class="st">'security.log'</span> })</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">logSecurityEvent</span>(eventType<span class="op">,</span> userId<span class="op">,</span> details) {</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  securityLogger<span class="op">.</span><span class="fu">info</span>({</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    eventType<span class="op">,</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    userId<span class="op">,</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">,</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span>details<span class="op">,</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Never include passwords, tokens, or other secrets!</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage examples</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="fu">logSecurityEvent</span>(<span class="st">'LOGIN_SUCCESS'</span><span class="op">,</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span> { <span class="dt">ip</span><span class="op">:</span> req<span class="op">.</span><span class="at">ip</span> })<span class="op">;</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="fu">logSecurityEvent</span>(<span class="st">'LOGIN_FAILURE'</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> { <span class="dt">email</span><span class="op">:</span> email<span class="op">,</span> <span class="dt">ip</span><span class="op">:</span> req<span class="op">.</span><span class="at">ip</span><span class="op">,</span> <span class="dt">reason</span><span class="op">:</span> <span class="st">'invalid_password'</span> })<span class="op">;</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="fu">logSecurityEvent</span>(<span class="st">'AUTHORIZATION_FAILURE'</span><span class="op">,</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> req<span class="op">.</span><span class="at">path</span><span class="op">,</span> <span class="dt">method</span><span class="op">:</span> req<span class="op">.</span><span class="at">method</span> })<span class="op">;</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="fu">logSecurityEvent</span>(<span class="st">'RATE_LIMIT_EXCEEDED'</span><span class="op">,</span> req<span class="op">.</span><span class="at">user</span><span class="op">?.</span><span class="at">id</span><span class="op">,</span> { <span class="dt">endpoint</span><span class="op">:</span> req<span class="op">.</span><span class="at">path</span><span class="op">,</span> <span class="dt">ip</span><span class="op">:</span> req<span class="op">.</span><span class="at">ip</span> })<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="monitoring-and-alerting" class="level4" data-number="14.3.9.3">
<h4 data-number="14.3.9.3" class="anchored" data-anchor-id="monitoring-and-alerting"><span class="header-section-number">14.3.9.3</span> Monitoring and Alerting</h4>
<p>Logs are only valuable if someone reviews them. Automated monitoring catches issues humans would miss:</p>
<p><strong>Alert on anomalies:</strong></p>
<ul>
<li>Sudden spike in failed logins</li>
<li>Login from unusual geographic location</li>
<li>Activity at unusual times</li>
<li>Many authorization failures from one user</li>
<li>Requests matching known attack patterns</li>
</ul>
<p><strong>Set up dashboards:</strong></p>
<ul>
<li>Authentication metrics over time</li>
<li>Error rates by category</li>
<li>Top IP addresses hitting rate limits</li>
<li>Geographic distribution of requests</li>
</ul>
<p>The goal is detecting attacks in progress or immediately after, not discovering them months later during an audit.</p>
</section>
</section>
<section id="a10-server-side-request-forgery-ssrf" class="level3" data-number="14.3.10">
<h3 data-number="14.3.10" class="anchored" data-anchor-id="a10-server-side-request-forgery-ssrf"><span class="header-section-number">14.3.10</span> 12.2.10 A10: Server-Side Request Forgery (SSRF)</h3>
<p><strong>SSRF</strong> occurs when an attacker can make the server perform requests to unintended locations. This exploits the server’s network position and credentials to access resources the attacker couldn’t reach directly.</p>
<section id="understanding-ssrf" class="level4" data-number="14.3.10.1">
<h4 data-number="14.3.10.1" class="anchored" data-anchor-id="understanding-ssrf"><span class="header-section-number">14.3.10.1</span> Understanding SSRF</h4>
<p>Modern applications often fetch external resources on behalf of users: previewing URLs, importing data, webhooks, and integrations. If users control the URL, they might direct requests to internal systems:</p>
<p><strong>Attack scenario:</strong> Your application has a feature to preview website thumbnails. Users provide a URL, your server fetches it, and returns a preview.</p>
<p>Normal use: <code>url=https://example.com</code></p>
<p>Attack: <code>url=http://169.254.169.254/latest/meta-data/</code></p>
<p>This special IP address (169.254.169.254) is the AWS metadata service, only accessible from within AWS. External attackers can’t reach it, but your server can. The metadata service exposes sensitive information including temporary IAM credentials. An attacker exploiting SSRF can steal these credentials and access your AWS resources.</p>
<p>Other SSRF targets:</p>
<ul>
<li>Internal services: <code>http://internal-api:8080/admin</code></li>
<li>Local services: <code>http://localhost:6379/</code> (Redis)</li>
<li>Cloud metadata: <code>http://metadata.google.internal/</code> (GCP)</li>
<li>File access: <code>file:///etc/passwd</code> (if file:// protocol is supported)</li>
</ul>
</section>
<section id="preventing-ssrf" class="level4" data-number="14.3.10.2">
<h4 data-number="14.3.10.2" class="anchored" data-anchor-id="preventing-ssrf"><span class="header-section-number">14.3.10.2</span> Preventing SSRF</h4>
<p>The core principle: <strong>never let users completely control URLs your server fetches.</strong> Various mitigations apply depending on your use case:</p>
<p><strong>Allowlist approach</strong>: Only permit specific domains. If your feature integrates with GitHub, only allow <code>github.com</code> URLs:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ALLOWED_DOMAINS <span class="op">=</span> [<span class="st">'github.com'</span><span class="op">,</span> <span class="st">'api.github.com'</span><span class="op">,</span> <span class="st">'raw.githubusercontent.com'</span>]<span class="op">;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">validateUrl</span>(userUrl) {</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> parsed <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(userUrl)<span class="op">;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>ALLOWED_DOMAINS<span class="op">.</span><span class="fu">includes</span>(parsed<span class="op">.</span><span class="at">hostname</span>)) {</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Domain not allowed'</span>)<span class="op">;</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> parsed<span class="op">;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Blocklist approach</strong>: When you need to allow arbitrary URLs but must block internal resources:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">safeFetch</span>(userUrl) {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> parsed <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(userUrl)<span class="op">;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Block non-HTTP protocols</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>[<span class="st">'http:'</span><span class="op">,</span> <span class="st">'https:'</span>]<span class="op">.</span><span class="fu">includes</span>(parsed<span class="op">.</span><span class="at">protocol</span>)) {</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Only HTTP(S) allowed'</span>)<span class="op">;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Block known internal hostnames</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> blockedHostnames <span class="op">=</span> [</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'localhost'</span><span class="op">,</span> <span class="st">'127.0.0.1'</span><span class="op">,</span> <span class="st">'0.0.0.0'</span><span class="op">,</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'169.254.169.254'</span><span class="op">,</span>  <span class="co">// AWS metadata</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'metadata.google.internal'</span><span class="op">,</span>  <span class="co">// GCP metadata</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10.'</span><span class="op">,</span> <span class="st">'172.16.'</span><span class="op">,</span> <span class="st">'192.168.'</span>  <span class="co">// Private ranges (check with startsWith)</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> blocked <span class="kw">of</span> blockedHostnames) {</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (parsed<span class="op">.</span><span class="at">hostname</span><span class="op">.</span><span class="fu">startsWith</span>(blocked) <span class="op">||</span> parsed<span class="op">.</span><span class="at">hostname</span> <span class="op">===</span> blocked) {</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Access to internal resources not allowed'</span>)<span class="op">;</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Resolve hostname and verify IP isn't internal</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> dns <span class="op">=</span> <span class="pp">require</span>(<span class="st">'dns'</span>)<span class="op">.</span><span class="at">promises</span><span class="op">;</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> addresses <span class="op">=</span> <span class="cf">await</span> dns<span class="op">.</span><span class="fu">resolve4</span>(parsed<span class="op">.</span><span class="at">hostname</span>)<span class="op">;</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> ip <span class="kw">of</span> addresses) {</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">isPrivateIP</span>(ip)) {</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Domain resolves to internal IP'</span>)<span class="op">;</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Finally safe to fetch</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">fetch</span>(userUrl<span class="op">,</span> { </span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">timeout</span><span class="op">:</span> <span class="dv">5000</span><span class="op">,</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">follow</span><span class="op">:</span> <span class="dv">0</span>  <span class="co">// Don't follow redirects (could redirect to internal)</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The DNS resolution check is crucial. An attacker might control <code>evil.com</code> which resolves to <code>127.0.0.1</code>. Checking the hostname isn’t enough; you must verify the resolved IP address isn’t internal.</p>
<hr>
</section>
</section>
</section>
<section id="input-validation-and-sanitization" class="level2" data-number="14.4">
<h2 data-number="14.4" class="anchored" data-anchor-id="input-validation-and-sanitization"><span class="header-section-number">14.4</span> 12.3 Input Validation and Sanitization</h2>
<p>Every piece of data from outside your system is potentially malicious. This includes form inputs, query parameters, headers, file uploads, and even data from your own database (which might have been compromised through another vector).</p>
<p>Input validation ensures data meets expected criteria before processing. Sanitization transforms potentially dangerous data into a safe form. Both are essential, and they serve different purposes.</p>
<section id="validation-strategies" class="level3" data-number="14.4.1">
<h3 data-number="14.4.1" class="anchored" data-anchor-id="validation-strategies"><span class="header-section-number">14.4.1</span> 12.3.1 Validation Strategies</h3>
<p><strong>Allowlisting</strong> (also called whitelisting) accepts only known good input. Define exactly what’s allowed; reject everything else. This is the most secure approach but requires knowing all valid inputs:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Only allow alphanumeric characters and limited punctuation</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> USERNAME_PATTERN <span class="op">=</span> <span class="ss">/</span><span class="sc">^[a-zA-Z0-9_-]{3,30}$</span><span class="ss">/</span><span class="op">;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="op">!</span>USERNAME_PATTERN<span class="op">.</span><span class="fu">test</span>(username)) {</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Username must be 3-30 alphanumeric characters'</span>)<span class="op">;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Blocklisting</strong> (blacklisting) rejects known bad input. This is weaker because you must anticipate every malicious input. Attackers often find bypasses by encoding, case variations, or Unicode tricks:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">// WEAK: Block &lt;script&gt; tags</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (input<span class="op">.</span><span class="fu">includes</span>(<span class="st">'&lt;script&gt;'</span>)) {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Invalid input'</span>)<span class="op">;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Bypass: &lt;SCRIPT&gt;, &lt;scr&lt;script&gt;ipt&gt;, &lt;script , etc.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Type conversion</strong> ensures data is the expected type. JavaScript’s loose typing means “123” might work where a number is expected, but “123abc” might cause unexpected behavior:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Convert to expected type, reject if conversion fails</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> userId <span class="op">=</span> <span class="pp">parseInt</span>(req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="pp">isNaN</span>(userId) <span class="op">||</span> userId <span class="op">&lt;=</span> <span class="dv">0</span>) {</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Invalid user ID'</span>)<span class="op">;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Range and length checking</strong> ensures values fall within acceptable bounds:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Age must be reasonable</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (age <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> age <span class="op">&gt;</span> <span class="dv">150</span>) {</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Age must be between 0 and 150'</span>)<span class="op">;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Title has length limits</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (title<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">||</span> title<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">200</span>) {</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Title must be 1-200 characters'</span>)<span class="op">;</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="comprehensive-validation-with-joi" class="level3" data-number="14.4.2">
<h3 data-number="14.4.2" class="anchored" data-anchor-id="comprehensive-validation-with-joi"><span class="header-section-number">14.4.2</span> 12.3.2 Comprehensive Validation with Joi</h3>
<p>Rather than writing ad-hoc validation code throughout your application, use a validation library that provides a declarative, comprehensive approach:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Joi <span class="op">=</span> <span class="pp">require</span>(<span class="st">'joi'</span>)<span class="op">;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Define validation schemas once, use everywhere</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> schemas <span class="op">=</span> {</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">userRegistration</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">object</span>({</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">email</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">email</span>()</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">max</span>(<span class="dv">254</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">required</span>()</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">messages</span>({</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'string.email'</span><span class="op">:</span> <span class="st">'Please enter a valid email address'</span><span class="op">,</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'any.required'</span><span class="op">:</span> <span class="st">'Email is required'</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">password</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">min</span>(<span class="dv">12</span>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">max</span>(<span class="dv">128</span>)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">required</span>()<span class="op">,</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">max</span>(<span class="dv">100</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">pattern</span>(<span class="ss">/</span><span class="sc">^[\p{L}\s'-]+$</span><span class="ss">/u</span>)  <span class="co">// Unicode letters, spaces, hyphens, apostrophes</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">required</span>()</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">taskCreate</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">object</span>({</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">max</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">required</span>()<span class="op">,</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">description</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">max</span>(<span class="dv">10000</span>)<span class="op">.</span><span class="fu">allow</span>(<span class="st">''</span>)<span class="op">,</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">priority</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">number</span>()<span class="op">.</span><span class="fu">integer</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">max</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">default</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">dueDate</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">date</span>()<span class="op">.</span><span class="fu">iso</span>()<span class="op">.</span><span class="fu">greater</span>(<span class="st">'now'</span>)<span class="op">.</span><span class="fu">allow</span>(<span class="kw">null</span>)</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each schema documents exactly what valid input looks like. The <code>.messages()</code> method provides user-friendly error messages. Default values fill in missing optional fields.</p>
<p>Create middleware that validates requests automatically:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">validate</span>(schemaName) {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> schema <span class="op">=</span> schemas[schemaName]<span class="op">;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { error<span class="op">,</span> value } <span class="op">=</span> schema<span class="op">.</span><span class="fu">validate</span>(req<span class="op">.</span><span class="at">body</span><span class="op">,</span> {</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">abortEarly</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span>    <span class="co">// Return ALL errors, not just first</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stripUnknown</span><span class="op">:</span> <span class="kw">true</span>    <span class="co">// Remove fields not in schema</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error) {</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">422</span>)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> <span class="st">'Validation failed'</span><span class="op">,</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">details</span><span class="op">:</span> error<span class="op">.</span><span class="at">details</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> ({</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">field</span><span class="op">:</span> d<span class="op">.</span><span class="at">path</span><span class="op">.</span><span class="fu">join</span>(<span class="st">'.'</span>)<span class="op">,</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">message</span><span class="op">:</span> d<span class="op">.</span><span class="at">message</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Replace body with validated, sanitized version</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    req<span class="op">.</span><span class="at">body</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply to routes</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/users'</span><span class="op">,</span> <span class="fu">validate</span>(<span class="st">'userRegistration'</span>)<span class="op">,</span> createUser)<span class="op">;</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/tasks'</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="fu">validate</span>(<span class="st">'taskCreate'</span>)<span class="op">,</span> createTask)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>stripUnknown: true</code> option is a security feature. It removes any fields not defined in the schema, preventing attackers from injecting unexpected data. Even if your code doesn’t use those fields, they might be passed to libraries that do.</p>
</section>
<section id="output-encoding" class="level3" data-number="14.4.3">
<h3 data-number="14.4.3" class="anchored" data-anchor-id="output-encoding"><span class="header-section-number">14.4.3</span> 12.3.3 Output Encoding</h3>
<p>Validation ensures input is safe for processing. <strong>Output encoding</strong> ensures data is safe for the context where it’s displayed. The same data might need different encoding for HTML, JavaScript, URL parameters, or SQL.</p>
<p>For HTML context, characters like <code>&lt;</code>, <code>&gt;</code>, and <code>&amp;</code> have special meaning and must be encoded:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> he <span class="op">=</span> <span class="pp">require</span>(<span class="st">'he'</span>)<span class="op">;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">// User input that might contain HTML</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> userComment <span class="op">=</span> <span class="st">'&lt;script&gt;alert("xss")&lt;/script&gt;Hello!'</span><span class="op">;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Encode for safe HTML display</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> safeComment <span class="op">=</span> he<span class="op">.</span><span class="fu">encode</span>(userComment)<span class="op">;</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Result: &amp;lt;script&amp;gt;alert(&amp;quot;xss&amp;quot;)&amp;lt;/script&amp;gt;Hello!</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Browser displays literally: &lt;script&gt;alert("xss")&lt;/script&gt;Hello!</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Instead of executing the script</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Modern frontend frameworks like React handle this automatically—JSX expressions are encoded by default. The danger comes when you deliberately bypass this protection:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode jsx code-with-copy"><code class="sourceCode javascriptreact"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">// SAFE: React automatically encodes</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div&gt;</span><span class="va">{</span>userComment<span class="va">}</span><span class="kw">&lt;/div&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">// DANGEROUS: Deliberately inserting HTML</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="ot">dangerouslySetInnerHTML</span><span class="op">=</span><span class="va">{</span>{<span class="dt">__html</span><span class="op">:</span> userComment}<span class="va">}</span> <span class="kw">/&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you must allow some HTML (rich text editors, markdown), use a library that sanitizes to an allowlist of safe tags:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DOMPurify <span class="op">=</span> <span class="pp">require</span>(<span class="st">'dompurify'</span>)<span class="op">;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { JSDOM } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'jsdom'</span>)<span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="bu">window</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">JSDOM</span>(<span class="st">''</span>)<span class="op">.</span><span class="at">window</span><span class="op">;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> purify <span class="op">=</span> <span class="fu">DOMPurify</span>(<span class="bu">window</span>)<span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Allow only safe tags, remove everything else</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> safeHtml <span class="op">=</span> purify<span class="op">.</span><span class="fu">sanitize</span>(userHtml<span class="op">,</span> {</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ALLOWED_TAGS</span><span class="op">:</span> [<span class="st">'b'</span><span class="op">,</span> <span class="st">'i'</span><span class="op">,</span> <span class="st">'em'</span><span class="op">,</span> <span class="st">'strong'</span><span class="op">,</span> <span class="st">'a'</span><span class="op">,</span> <span class="st">'p'</span><span class="op">,</span> <span class="st">'br'</span>]<span class="op">,</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ALLOWED_ATTR</span><span class="op">:</span> [<span class="st">'href'</span><span class="op">,</span> <span class="st">'title'</span>]</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="security-headers" class="level2" data-number="14.5">
<h2 data-number="14.5" class="anchored" data-anchor-id="security-headers"><span class="header-section-number">14.5</span> 12.4 Security Headers</h2>
<p>HTTP security headers instruct browsers to enable security features. They provide defense against many client-side attacks with minimal implementation effort. However, headers only work if configured correctly—misconfigured headers can break your application or give false confidence.</p>
<section id="content-security-policy" class="level3" data-number="14.5.1">
<h3 data-number="14.5.1" class="anchored" data-anchor-id="content-security-policy"><span class="header-section-number">14.5.1</span> 12.4.1 Content Security Policy</h3>
<p><strong>Content-Security-Policy (CSP)</strong> is the most powerful security header. It controls which resources the browser is allowed to load and execute. Even if an attacker injects malicious content through XSS, CSP can prevent it from executing.</p>
<p>CSP works by specifying allowed sources for different resource types:</p>
<pre class="http"><code>Content-Security-Policy: 
  default-src 'self';
  script-src 'self' https://cdn.example.com;
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
  connect-src 'self' https://api.example.com;
  frame-ancestors 'none';</code></pre>
<p>Let’s understand each directive:</p>
<p><strong>default-src ‘self’</strong> sets the default policy for all resource types: only load resources from the same origin as the page. Other directives override this default for specific types.</p>
<p><strong>script-src</strong> controls JavaScript execution. <code>'self'</code> allows scripts from your domain. Adding <code>https://cdn.example.com</code> allows scripts from that specific CDN. Notably, <code>'unsafe-inline'</code> is NOT included—inline scripts (including injected XSS payloads) won’t execute.</p>
<p><strong>style-src</strong> controls CSS. <code>'unsafe-inline'</code> is often needed for styles because many frameworks inject inline styles. This is less dangerous than inline scripts but still weakens CSP.</p>
<p><strong>img-src</strong> allows images from same origin, data URIs (for embedded images), and any HTTPS source. Images are generally low risk, so this permissive policy is often acceptable.</p>
<p><strong>connect-src</strong> controls AJAX/Fetch requests. Only same origin and your API are allowed. An injected script couldn’t exfiltrate data to an attacker’s server.</p>
<p><strong>frame-ancestors ‘none’</strong> prevents your page from being embedded in iframes. This protects against clickjacking attacks.</p>
<p><strong>The challenge with CSP</strong> is that strict policies break many applications. Inline event handlers (<code>onclick="..."</code>), inline styles, and dynamically generated scripts all violate strict CSP. Implementing CSP often requires refactoring:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- VIOLATES CSP: Inline event handler --&gt;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">"handleClick()"</span><span class="dt">&gt;</span>Click<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- CSP-COMPLIANT: Event listener in separate script --&gt;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> id</span><span class="op">=</span><span class="st">"myButton"</span><span class="dt">&gt;</span>Click<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/js/handlers.js"</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Start with report-only mode</strong> to identify violations without breaking functionality:</p>
<pre class="http"><code>Content-Security-Policy-Report-Only: default-src 'self'; report-uri /csp-report</code></pre>
<p>Browsers send violation reports to your endpoint instead of blocking resources. Review reports, fix violations, then enable enforcement.</p>
</section>
<section id="other-essential-headers" class="level3" data-number="14.5.2">
<h3 data-number="14.5.2" class="anchored" data-anchor-id="other-essential-headers"><span class="header-section-number">14.5.2</span> 12.4.2 Other Essential Headers</h3>
<p><strong>Strict-Transport-Security (HSTS)</strong> forces HTTPS connections:</p>
<pre class="http"><code>Strict-Transport-Security: max-age=31536000; includeSubDomains; preload</code></pre>
<p>Once a browser sees this header, it will only make HTTPS requests to your domain for one year (<code>max-age</code>). Even if users type <code>http://</code>, the browser upgrades to HTTPS before sending the request. This prevents SSL stripping attacks where attackers intercept the initial HTTP request.</p>
<p><strong>X-Content-Type-Options</strong> prevents MIME type sniffing:</p>
<pre class="http"><code>X-Content-Type-Options: nosniff</code></pre>
<p>Without this, browsers might execute a file as JavaScript even if it’s served with a different Content-Type. An attacker could upload a file that looks like JavaScript, and the browser might execute it despite a <code>Content-Type: image/png</code> header.</p>
<p><strong>X-Frame-Options</strong> provides clickjacking protection (superseded by CSP’s frame-ancestors but still useful for older browsers):</p>
<pre class="http"><code>X-Frame-Options: DENY</code></pre>
<p><strong>Referrer-Policy</strong> controls how much information is sent in the Referer header:</p>
<pre class="http"><code>Referrer-Policy: strict-origin-when-cross-origin</code></pre>
<p>This sends the full URL for same-origin requests but only the origin (scheme + domain) for cross-origin requests. This prevents leaking sensitive URL parameters to third parties.</p>
<hr>
</section>
</section>
<section id="security-testing" class="level2" data-number="14.6">
<h2 data-number="14.6" class="anchored" data-anchor-id="security-testing"><span class="header-section-number">14.6</span> 12.5 Security Testing</h2>
<p>Security testing verifies that your application is protected against known vulnerabilities. It should be integrated into your development process, not treated as a one-time activity before release.</p>
<section id="types-of-security-testing" class="level3" data-number="14.6.1">
<h3 data-number="14.6.1" class="anchored" data-anchor-id="types-of-security-testing"><span class="header-section-number">14.6.1</span> 12.5.1 Types of Security Testing</h3>
<p>Different testing approaches find different types of vulnerabilities:</p>
<p><strong>Static Application Security Testing (SAST)</strong> analyzes source code without executing it. SAST tools look for patterns associated with vulnerabilities: string concatenation in SQL queries, use of dangerous functions, hardcoded credentials. SAST runs early in development (even in IDEs) and finds vulnerabilities before code runs.</p>
<p>Limitations: SAST produces false positives (flagging safe code as vulnerable) and false negatives (missing vulnerabilities that depend on runtime behavior). It can’t find configuration issues or vulnerabilities in the running environment.</p>
<p><strong>Dynamic Application Security Testing (DAST)</strong> tests the running application from outside. DAST tools send malicious requests and observe responses, finding vulnerabilities like SQL injection, XSS, and misconfiguration. DAST finds real, exploitable vulnerabilities but runs later in development (requires a running application).</p>
<p>Limitations: DAST only tests what it can reach through the interface. Code paths that aren’t exercised won’t be tested. It also can’t see into the application—a vulnerability might be exploited without the test knowing.</p>
<p><strong>Software Composition Analysis (SCA)</strong> focuses on third-party dependencies. SCA tools match your dependencies against databases of known vulnerabilities. Given that most code in modern applications comes from libraries, this is crucial.</p>
<p><strong>Penetration Testing</strong> is manual testing by security experts who think like attackers. Penetration testers find complex vulnerabilities that automated tools miss: business logic flaws, chained vulnerabilities, and creative attack paths. This is the most thorough but most expensive testing.</p>
</section>
<section id="integrating-security-testing-into-cicd" class="level3" data-number="14.6.2">
<h3 data-number="14.6.2" class="anchored" data-anchor-id="integrating-security-testing-into-cicd"><span class="header-section-number">14.6.2</span> 12.5.2 Integrating Security Testing into CI/CD</h3>
<p>Automated security testing should run on every code change:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/security.yml</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Security</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">,</span><span class="at"> develop</span><span class="kw">]</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pull_request</span><span class="kw">:</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">]</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">cron</span><span class="kw">:</span><span class="at"> </span><span class="st">'0 0 * * *'</span><span class="co">  # Daily for new vulnerability discoveries</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">sast</span><span class="kw">:</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run Semgrep</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> returntocorp/semgrep-action@v1</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">config</span><span class="kw">:</span><span class="at"> p/security-audit p/secrets p/owasp-top-ten</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">sca</span><span class="kw">:</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm ci</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm audit --audit-level=high</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">security-tests</span><span class="kw">:</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm ci</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm run test:security</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The daily schedule catches newly disclosed vulnerabilities in dependencies. A library that was safe yesterday might have a CVE published today.</p>
</section>
<section id="writing-security-tests" class="level3" data-number="14.6.3">
<h3 data-number="14.6.3" class="anchored" data-anchor-id="writing-security-tests"><span class="header-section-number">14.6.3</span> 12.5.3 Writing Security Tests</h3>
<p>Security tests verify specific security controls work as intended:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">'Authentication Security'</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">'rejects requests without authentication'</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">request</span>(app)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">'/api/tasks'</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">401</span>)<span class="op">;</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">'rejects invalid tokens'</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">request</span>(app)</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">'/api/tasks'</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">set</span>(<span class="st">'Authorization'</span><span class="op">,</span> <span class="st">'Bearer invalid.token.here'</span>)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">401</span>)<span class="op">;</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">'rate limits login attempts'</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Make many failed login attempts</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> attempts <span class="op">=</span> <span class="bu">Array</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">fill</span>()<span class="op">.</span><span class="fu">map</span>(() <span class="kw">=&gt;</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">request</span>(app)</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">post</span>(<span class="st">'/api/auth/login'</span>)</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">send</span>({ <span class="dt">email</span><span class="op">:</span> <span class="st">'test@test.com'</span><span class="op">,</span> <span class="dt">password</span><span class="op">:</span> <span class="st">'wrong'</span> })</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> responses <span class="op">=</span> <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(attempts)<span class="op">;</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> rateLimited <span class="op">=</span> responses<span class="op">.</span><span class="fu">filter</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">429</span>)<span class="op">;</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(rateLimited<span class="op">.</span><span class="at">length</span>)<span class="op">.</span><span class="fu">toBeGreaterThan</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">'Authorization Security'</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">'users cannot access other users data'</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user1Token <span class="op">=</span> <span class="cf">await</span> <span class="fu">getAuthToken</span>(<span class="st">'user1@test.com'</span>)<span class="op">;</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user2Id <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">request</span>(app)</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="vs">`/api/users/</span><span class="sc">${</span>user2Id<span class="sc">}</span><span class="vs">/profile`</span>)</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">set</span>(<span class="st">'Authorization'</span><span class="op">,</span> <span class="vs">`Bearer </span><span class="sc">${</span>user1Token<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">403</span>)<span class="op">;</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">'non-admins cannot access admin endpoints'</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> userToken <span class="op">=</span> <span class="cf">await</span> <span class="fu">getAuthToken</span>(<span class="st">'user@test.com'</span>)<span class="op">;</span></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">request</span>(app)</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">'/api/admin/users'</span>)</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">set</span>(<span class="st">'Authorization'</span><span class="op">,</span> <span class="vs">`Bearer </span><span class="sc">${</span>userToken<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">403</span>)<span class="op">;</span></span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">'Input Validation'</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">'SQL injection is prevented'</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> <span class="cf">await</span> <span class="fu">getAuthToken</span>()<span class="op">;</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attempt SQL injection</span></span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">request</span>(app)</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">'/api/tasks'</span>)</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">query</span>({ <span class="dt">search</span><span class="op">:</span> <span class="st">"'; DROP TABLE tasks; --"</span> })</span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">set</span>(<span class="st">'Authorization'</span><span class="op">,</span> <span class="vs">`Bearer </span><span class="sc">${</span>token<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">200</span>)<span class="op">;</span></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify table still exists by making another request</span></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">request</span>(app)</span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">'/api/tasks'</span>)</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">set</span>(<span class="st">'Authorization'</span><span class="op">,</span> <span class="vs">`Bearer </span><span class="sc">${</span>token<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">200</span>)<span class="op">;</span></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These tests serve as regression prevention. If someone accidentally removes a security check, the tests fail.</p>
<hr>
</section>
</section>
<section id="incident-response" class="level2" data-number="14.7">
<h2 data-number="14.7" class="anchored" data-anchor-id="incident-response"><span class="header-section-number">14.7</span> 12.6 Incident Response</h2>
<p>Despite best efforts, security incidents happen. Having a plan ensures you respond effectively, minimizing damage and recovery time. The time to plan is before an incident, not during one.</p>
<section id="incident-response-phases" class="level3" data-number="14.7.1">
<h3 data-number="14.7.1" class="anchored" data-anchor-id="incident-response-phases"><span class="header-section-number">14.7.1</span> 12.6.1 Incident Response Phases</h3>
<p>Security professionals follow a structured incident response process:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    INCIDENT RESPONSE PHASES                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. PREPARATION                                                         │
│     Before incidents occur:                                             │
│     • Document response procedures                                      │
│     • Establish communication channels                                  │
│     • Train team members                                                │
│     • Set up monitoring and alerting                                    │
│     • Maintain contact lists (legal, PR, executives)                    │
│                                                                         │
│  2. IDENTIFICATION                                                      │
│     Detecting and confirming an incident:                               │
│     • Monitor alerts and anomalies                                      │
│     • Assess scope and severity                                         │
│     • Document initial findings                                         │
│     • Classify incident type                                            │
│                                                                         │
│  3. CONTAINMENT                                                         │
│     Limiting damage:                                                    │
│     • Short-term: Stop immediate damage                                 │
│     • Long-term: Implement temporary fixes                              │
│     • Preserve evidence for analysis                                    │
│                                                                         │
│  4. ERADICATION                                                         │
│     Removing the threat:                                                │
│     • Remove attacker access                                            │
│     • Patch vulnerabilities                                             │
│     • Reset compromised credentials                                     │
│     • Verify complete removal                                           │
│                                                                         │
│  5. RECOVERY                                                            │
│     Returning to normal:                                                │
│     • Restore systems to normal operation                               │
│     • Monitor for signs of persistent compromise                        │
│     • Gradually return to full service                                  │
│                                                                         │
│  6. LESSONS LEARNED                                                     │
│     Improving for the future:                                           │
│     • Conduct post-incident review                                      │
│     • Document timeline and actions                                     │
│     • Identify improvement opportunities                                │
│     • Update procedures and controls                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
</section>
<section id="containment-actions" class="level3" data-number="14.7.2">
<h3 data-number="14.7.2" class="anchored" data-anchor-id="containment-actions"><span class="header-section-number">14.7.2</span> 12.6.2 Containment Actions</h3>
<p>When an incident is confirmed, quick containment limits damage. Some actions can be automated for faster response:</p>
<p><strong>Account compromise</strong>: Immediately invalidate all sessions for the compromised account. Reset the password. Check for unauthorized changes made by the account.</p>
<p><strong>Suspicious IP activity</strong>: Block the IP at the firewall or WAF level. Review all requests from that IP to understand the attack.</p>
<p><strong>Vulnerable code deployed</strong>: Roll back to the previous version. If rollback isn’t possible, take the affected feature offline while fixing.</p>
<p><strong>Database breach</strong>: Rotate all database credentials. Review access logs. Determine what data was accessed.</p>
<p>The key principle: <strong>prioritize stopping the bleeding over understanding the wound.</strong> Containment comes first; investigation can happen after the immediate threat is neutralized.</p>
</section>
<section id="communication" class="level3" data-number="14.7.3">
<h3 data-number="14.7.3" class="anchored" data-anchor-id="communication"><span class="header-section-number">14.7.3</span> 12.6.3 Communication</h3>
<p>During incidents, clear communication is essential:</p>
<p><strong>Internal communication</strong>: Keep stakeholders informed through a dedicated channel. Provide regular updates even if there’s no progress—silence creates anxiety and speculation.</p>
<p><strong>External communication</strong> (if required): Work with legal and PR teams. Be honest but measured. Don’t speculate about unconfirmed details. Comply with breach notification requirements.</p>
<p><strong>Documentation</strong>: Keep detailed notes of what’s happening, what actions are taken, and why. This serves the lessons learned phase and potential legal proceedings.</p>
<hr>
</section>
</section>
<section id="chapter-summary" class="level2" data-number="14.8">
<h2 data-number="14.8" class="anchored" data-anchor-id="chapter-summary"><span class="header-section-number">14.8</span> 12.7 Chapter Summary</h2>
<p>Software security is a continuous process that must be integrated into every phase of development. This chapter covered the essential knowledge and practices for building secure applications.</p>
<p>Key takeaways:</p>
<p><strong>Security principles</strong> like defense in depth, least privilege, and fail securely guide all security decisions. Adopting a security mindset means constantly asking “How could this be abused?” before “How do I make this work?”</p>
<p><strong>The OWASP Top 10</strong> represents the most critical web application vulnerabilities. Understanding and mitigating these risks—broken access control, cryptographic failures, injection, insecure design, security misconfiguration, vulnerable components, authentication failures, software integrity failures, logging failures, and SSRF—prevents the majority of attacks.</p>
<p><strong>Authentication and authorization</strong> must be implemented correctly with no shortcuts. Use proven libraries, hash passwords with bcrypt, implement rate limiting, and manage sessions securely with httpOnly, secure, and sameSite cookie flags.</p>
<p><strong>Input validation</strong> treats all external data as potentially malicious. Validate data type, length, format, and range. Use allowlisting over blocklisting. Sanitize output for the appropriate context.</p>
<p><strong>Security headers</strong> provide defense against many client-side attacks with minimal implementation effort. Content-Security-Policy is particularly powerful, effectively preventing XSS even when other defenses fail.</p>
<p><strong>Security testing</strong> should be automated and continuous. Static analysis, dependency scanning, dynamic testing, and manual penetration testing all play important roles. Integrate security testing into CI/CD pipelines.</p>
<p><strong>Incident response</strong> planning ensures you’re prepared when security incidents occur. The phases of preparation, identification, containment, eradication, recovery, and lessons learned provide a structured approach to handling incidents.</p>
<p>Security is everyone’s responsibility. Every developer should understand security basics and incorporate security thinking into their daily work. Perfect security is impossible, but thoughtful security dramatically reduces risk.</p>
<hr>
</section>
<section id="key-terms" class="level2" data-number="14.9">
<h2 data-number="14.9" class="anchored" data-anchor-id="key-terms"><span class="header-section-number">14.9</span> 12.8 Key Terms</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Term</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>OWASP</strong></td>
<td>Open Web Application Security Project—nonprofit producing security standards and tools</td>
</tr>
<tr class="even">
<td><strong>SQL Injection</strong></td>
<td>Attack that inserts malicious SQL code through user input</td>
</tr>
<tr class="odd">
<td><strong>XSS</strong></td>
<td>Cross-Site Scripting—injecting malicious scripts into web pages</td>
</tr>
<tr class="even">
<td><strong>CSRF</strong></td>
<td>Cross-Site Request Forgery—tricking users into performing unintended actions</td>
</tr>
<tr class="odd">
<td><strong>SSRF</strong></td>
<td>Server-Side Request Forgery—making servers request unintended URLs</td>
</tr>
<tr class="even">
<td><strong>IDOR</strong></td>
<td>Insecure Direct Object Reference—accessing objects by manipulating identifiers</td>
</tr>
<tr class="odd">
<td><strong>bcrypt</strong></td>
<td>Password hashing algorithm designed to be computationally expensive</td>
</tr>
<tr class="even">
<td><strong>JWT</strong></td>
<td>JSON Web Token—compact, self-contained token for authentication</td>
</tr>
<tr class="odd">
<td><strong>CSP</strong></td>
<td>Content Security Policy—header controlling resource loading in browsers</td>
</tr>
<tr class="even">
<td><strong>HSTS</strong></td>
<td>HTTP Strict Transport Security—forces HTTPS connections</td>
</tr>
<tr class="odd">
<td><strong>SAST</strong></td>
<td>Static Application Security Testing—analyzing source code for vulnerabilities</td>
</tr>
<tr class="even">
<td><strong>DAST</strong></td>
<td>Dynamic Application Security Testing—testing running applications</td>
</tr>
<tr class="odd">
<td><strong>SCA</strong></td>
<td>Software Composition Analysis—scanning third-party dependencies for vulnerabilities</td>
</tr>
<tr class="even">
<td><strong>Defense in Depth</strong></td>
<td>Layering multiple security controls so failure of one doesn’t compromise security</td>
</tr>
<tr class="odd">
<td><strong>Least Privilege</strong></td>
<td>Granting only the minimum permissions necessary for a task</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="review-questions" class="level2" data-number="14.10">
<h2 data-number="14.10" class="anchored" data-anchor-id="review-questions"><span class="header-section-number">14.10</span> 12.9 Review Questions</h2>
<ol type="1">
<li><p>Explain the principle of defense in depth. How would you apply it to protect against SQL injection?</p></li>
<li><p>What is the difference between authentication and authorization? Give an example of a failure in each.</p></li>
<li><p>Why should passwords be hashed rather than encrypted? What properties make bcrypt suitable for password hashing?</p></li>
<li><p>Explain how parameterized queries prevent SQL injection. Why is input validation alone insufficient?</p></li>
<li><p>Describe the purpose of Content-Security-Policy. How does it help prevent XSS attacks even when input validation fails?</p></li>
<li><p>What is the difference between SAST and DAST? What types of vulnerabilities is each best at finding?</p></li>
<li><p>Explain SSRF attacks and why they’re particularly dangerous in cloud environments.</p></li>
<li><p>How does rate limiting protect against brute force attacks? What factors should you consider when setting limits?</p></li>
<li><p>What should be included in security logging? What should NOT be logged?</p></li>
<li><p>Describe the phases of incident response. Why is the “lessons learned” phase important?</p></li>
</ol>
<hr>
</section>
<section id="hands-on-exercises" class="level2" data-number="14.11">
<h2 data-number="14.11" class="anchored" data-anchor-id="hands-on-exercises"><span class="header-section-number">14.11</span> 12.10 Hands-On Exercises</h2>
<section id="exercise-12.1-security-audit" class="level3" data-number="14.11.1">
<h3 data-number="14.11.1" class="anchored" data-anchor-id="exercise-12.1-security-audit"><span class="header-section-number">14.11.1</span> Exercise 12.1: Security Audit</h3>
<p>Conduct a security review of your project:</p>
<ol type="1">
<li>Review authentication implementation (password hashing algorithm, session management)</li>
<li>Audit authorization logic (access control checks on all endpoints)</li>
<li>Check input validation (all user inputs validated)</li>
<li>Examine error handling (no sensitive data in error messages)</li>
<li>Document findings with severity ratings and remediation steps</li>
</ol>
</section>
<section id="exercise-12.2-implement-owasp-protections" class="level3" data-number="14.11.2">
<h3 data-number="14.11.2" class="anchored" data-anchor-id="exercise-12.2-implement-owasp-protections"><span class="header-section-number">14.11.2</span> Exercise 12.2: Implement OWASP Protections</h3>
<p>Add protections against common vulnerabilities:</p>
<ol type="1">
<li>Implement parameterized queries throughout your database layer</li>
<li>Add input validation using Joi or Zod for all endpoints</li>
<li>Configure security headers using Helmet</li>
<li>Add rate limiting to authentication endpoints</li>
<li>Implement CSRF protection if using session cookies</li>
</ol>
</section>
<section id="exercise-12.3-security-testing-suite" class="level3" data-number="14.11.3">
<h3 data-number="14.11.3" class="anchored" data-anchor-id="exercise-12.3-security-testing-suite"><span class="header-section-number">14.11.3</span> Exercise 12.3: Security Testing Suite</h3>
<p>Create automated security tests:</p>
<ol type="1">
<li>Test authentication bypass attempts (missing token, invalid token, expired token)</li>
<li>Test authorization boundaries (accessing other users’ data, admin endpoints)</li>
<li>Test input validation (SQL injection payloads, XSS payloads, oversized inputs)</li>
<li>Verify security headers are present in responses</li>
<li>Test rate limiting behavior</li>
</ol>
</section>
<section id="exercise-12.4-dependency-security-pipeline" class="level3" data-number="14.11.4">
<h3 data-number="14.11.4" class="anchored" data-anchor-id="exercise-12.4-dependency-security-pipeline"><span class="header-section-number">14.11.4</span> Exercise 12.4: Dependency Security Pipeline</h3>
<p>Set up automated dependency scanning:</p>
<ol type="1">
<li>Configure npm audit to run in CI/CD</li>
<li>Set up Snyk or similar tool for deeper scanning</li>
<li>Create policy document for handling discovered vulnerabilities</li>
<li>Implement automated alerts for new critical vulnerabilities</li>
<li>Document process for evaluating and updating dependencies</li>
</ol>
</section>
<section id="exercise-12.5-security-logging-implementation" class="level3" data-number="14.11.5">
<h3 data-number="14.11.5" class="anchored" data-anchor-id="exercise-12.5-security-logging-implementation"><span class="header-section-number">14.11.5</span> Exercise 12.5: Security Logging Implementation</h3>
<p>Add comprehensive security logging:</p>
<ol type="1">
<li>Log all authentication events (login success/failure, logout, password changes)</li>
<li>Log authorization failures with context</li>
<li>Log input validation failures with request details (not sensitive data)</li>
<li>Create alerts for suspicious patterns (multiple failures, unusual times)</li>
<li>Set up log aggregation and create security dashboard</li>
</ol>
</section>
<section id="exercise-12.6-incident-response-plan" class="level3" data-number="14.11.6">
<h3 data-number="14.11.6" class="anchored" data-anchor-id="exercise-12.6-incident-response-plan"><span class="header-section-number">14.11.6</span> Exercise 12.6: Incident Response Plan</h3>
<p>Create an incident response plan for your project:</p>
<ol type="1">
<li>Define incident severity levels with examples</li>
<li>Document containment procedures for common incident types</li>
<li>Create communication templates for stakeholders</li>
<li>Establish escalation paths and contact information</li>
<li>Design post-incident review template</li>
</ol>
<hr>
</section>
</section>
<section id="further-reading" class="level2" data-number="14.12">
<h2 data-number="14.12" class="anchored" data-anchor-id="further-reading"><span class="header-section-number">14.12</span> 12.11 Further Reading</h2>
<p><strong>Books:</strong></p>
<ul>
<li>Stuttard, D. &amp; Pinto, M. (2011). <em>The Web Application Hacker’s Handbook</em> (2nd Edition). Wiley.</li>
<li>McDonald, M. (2020). <em>Web Security for Developers</em>. No Starch Press.</li>
<li>Hoffman, A. (2020). <em>Web Application Security</em>. O’Reilly Media.</li>
</ul>
<p><strong>Online Resources:</strong></p>
<ul>
<li>OWASP Top 10: https://owasp.org/Top10/</li>
<li>OWASP Cheat Sheet Series: https://cheatsheetseries.owasp.org/</li>
<li>PortSwigger Web Security Academy: https://portswigger.net/web-security</li>
<li>Mozilla Web Security Guidelines: https://infosec.mozilla.org/guidelines/web_security</li>
</ul>
<hr>
</section>
<section id="references" class="level2" data-number="14.13">
<h2 data-number="14.13" class="anchored" data-anchor-id="references"><span class="header-section-number">14.13</span> References</h2>
<p>OWASP Foundation. (2021). OWASP Top 10:2021. Retrieved from https://owasp.org/Top10/</p>
<p>NIST. (2017). Digital Identity Guidelines. Special Publication 800-63B.</p>
<p>MITRE. (2023). Common Weakness Enumeration (CWE). Retrieved from https://cwe.mitre.org/</p>
<p>Mozilla. (2023). Mozilla Web Security Guidelines. Retrieved from https://infosec.mozilla.org/guidelines/web_security</p>
<p>National Institute of Standards and Technology. (2018). Framework for Improving Critical Infrastructure Cybersecurity. Version 1.1.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/11-cloud-services.html" class="pagination-link" aria-label="Chapter 11: Cloud Services and Deployment">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 11: Cloud Services and Deployment</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/13-maintenance-evolution.html" class="pagination-link" aria-label="Chapter 13: Software Maintenance and Evolution">
        <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 13: Software Maintenance and Evolution</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>