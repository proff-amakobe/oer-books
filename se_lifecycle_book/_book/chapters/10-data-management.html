<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; Chapter 10: Data Management and APIs – The Complete Software Engineering Lifecycle</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/11-cloud-services.html" rel="next">
<link href="../chapters/09-cicd.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-9b98f18118eee809be1c051eb5cc78e4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/10-data-management.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 10: Data Management and APIs</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">The Complete Software Engineering Lifecycle</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Complete Software Engineering Lifecycle</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../acknowledgments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Acknowledgments</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 1: Introduction to Software Engineering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-requirements-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Chapter 2: Requirements Engineering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-systems-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 3: Systems Modeling and UML</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-software-architecture.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 4: Software Architecture and Design Patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-ui-ux.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 5: UI/UX Design and Prototyping</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-agile-methodologies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 6: Agile Methodologies and Project Management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-version-control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Chapter 7: Version Control Workflows</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-cicd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 9: Continuous Integration and Continuous Deployment</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/10-data-management.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 10: Data Management and APIs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/11-cloud-services.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 11: Cloud Services and Deployment</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/12-security.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Chapter 12: Software Security</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/13-maintenance-evolution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Chapter 13: Software Maintenance and Evolution</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/14-ethics-professionalism.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Chapter 14: Professional Practice and Ethics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/15-final-project-integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Chapter 15: Final Project Integration and Course Synthesis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/glossary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Glossary</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives"><span class="header-section-number">12.1</span> Learning Objectives</a></li>
  <li><a href="#the-role-of-data-in-software-systems" id="toc-the-role-of-data-in-software-systems" class="nav-link" data-scroll-target="#the-role-of-data-in-software-systems"><span class="header-section-number">12.2</span> 10.1 The Role of Data in Software Systems</a>
  <ul class="collapse">
  <li><a href="#data-architecture-overview" id="toc-data-architecture-overview" class="nav-link" data-scroll-target="#data-architecture-overview"><span class="header-section-number">12.2.1</span> 10.1.1 Data Architecture Overview</a></li>
  <li><a href="#key-data-management-concerns" id="toc-key-data-management-concerns" class="nav-link" data-scroll-target="#key-data-management-concerns"><span class="header-section-number">12.2.2</span> 10.1.2 Key Data Management Concerns</a></li>
  </ul></li>
  <li><a href="#relational-databases" id="toc-relational-databases" class="nav-link" data-scroll-target="#relational-databases"><span class="header-section-number">12.3</span> 10.2 Relational Databases</a>
  <ul class="collapse">
  <li><a href="#core-concepts" id="toc-core-concepts" class="nav-link" data-scroll-target="#core-concepts"><span class="header-section-number">12.3.1</span> 10.2.1 Core Concepts</a></li>
  <li><a href="#sql-fundamentals" id="toc-sql-fundamentals" class="nav-link" data-scroll-target="#sql-fundamentals"><span class="header-section-number">12.3.2</span> 10.2.2 SQL Fundamentals</a></li>
  <li><a href="#database-normalization" id="toc-database-normalization" class="nav-link" data-scroll-target="#database-normalization"><span class="header-section-number">12.3.3</span> 10.2.3 Database Normalization</a></li>
  <li><a href="#transactions-and-acid-properties" id="toc-transactions-and-acid-properties" class="nav-link" data-scroll-target="#transactions-and-acid-properties"><span class="header-section-number">12.3.4</span> 10.2.4 Transactions and ACID Properties</a></li>
  </ul></li>
  <li><a href="#nosql-databases" id="toc-nosql-databases" class="nav-link" data-scroll-target="#nosql-databases"><span class="header-section-number">12.4</span> 10.3 NoSQL Databases</a>
  <ul class="collapse">
  <li><a href="#types-of-nosql-databases" id="toc-types-of-nosql-databases" class="nav-link" data-scroll-target="#types-of-nosql-databases"><span class="header-section-number">12.4.1</span> 10.3.1 Types of NoSQL Databases</a></li>
  <li><a href="#document-databases-mongodb" id="toc-document-databases-mongodb" class="nav-link" data-scroll-target="#document-databases-mongodb"><span class="header-section-number">12.4.2</span> 10.3.2 Document Databases (MongoDB)</a></li>
  <li><a href="#key-value-stores-redis" id="toc-key-value-stores-redis" class="nav-link" data-scroll-target="#key-value-stores-redis"><span class="header-section-number">12.4.3</span> 10.3.3 Key-Value Stores (Redis)</a></li>
  <li><a href="#choosing-between-sql-and-nosql" id="toc-choosing-between-sql-and-nosql" class="nav-link" data-scroll-target="#choosing-between-sql-and-nosql"><span class="header-section-number">12.4.4</span> 10.3.4 Choosing Between SQL and NoSQL</a></li>
  </ul></li>
  <li><a href="#restful-api-design" id="toc-restful-api-design" class="nav-link" data-scroll-target="#restful-api-design"><span class="header-section-number">12.5</span> 10.4 RESTful API Design</a>
  <ul class="collapse">
  <li><a href="#rest-principles" id="toc-rest-principles" class="nav-link" data-scroll-target="#rest-principles"><span class="header-section-number">12.5.1</span> 10.4.1 REST Principles</a></li>
  <li><a href="#resource-oriented-design" id="toc-resource-oriented-design" class="nav-link" data-scroll-target="#resource-oriented-design"><span class="header-section-number">12.5.2</span> 10.4.2 Resource-Oriented Design</a></li>
  <li><a href="#http-methods-and-crud-operations" id="toc-http-methods-and-crud-operations" class="nav-link" data-scroll-target="#http-methods-and-crud-operations"><span class="header-section-number">12.5.3</span> 10.4.3 HTTP Methods and CRUD Operations</a></li>
  <li><a href="#http-status-codes" id="toc-http-status-codes" class="nav-link" data-scroll-target="#http-status-codes"><span class="header-section-number">12.5.4</span> 10.4.4 HTTP Status Codes</a></li>
  <li><a href="#implementing-a-restful-api" id="toc-implementing-a-restful-api" class="nav-link" data-scroll-target="#implementing-a-restful-api"><span class="header-section-number">12.5.5</span> 10.4.5 Implementing a RESTful API</a></li>
  <li><a href="#response-structure" id="toc-response-structure" class="nav-link" data-scroll-target="#response-structure"><span class="header-section-number">12.5.6</span> 10.4.6 Response Structure</a></li>
  </ul></li>
  <li><a href="#graphql" id="toc-graphql" class="nav-link" data-scroll-target="#graphql"><span class="header-section-number">12.6</span> 10.5 GraphQL</a>
  <ul class="collapse">
  <li><a href="#the-problem-graphql-solves" id="toc-the-problem-graphql-solves" class="nav-link" data-scroll-target="#the-problem-graphql-solves"><span class="header-section-number">12.6.1</span> 10.5.1 The Problem GraphQL Solves</a></li>
  <li><a href="#graphql-schema" id="toc-graphql-schema" class="nav-link" data-scroll-target="#graphql-schema"><span class="header-section-number">12.6.2</span> 10.5.2 GraphQL Schema</a></li>
  <li><a href="#writing-graphql-queries" id="toc-writing-graphql-queries" class="nav-link" data-scroll-target="#writing-graphql-queries"><span class="header-section-number">12.6.3</span> 10.5.3 Writing GraphQL Queries</a></li>
  <li><a href="#graphql-mutations" id="toc-graphql-mutations" class="nav-link" data-scroll-target="#graphql-mutations"><span class="header-section-number">12.6.4</span> 10.5.4 GraphQL Mutations</a></li>
  <li><a href="#implementing-graphql-resolvers" id="toc-implementing-graphql-resolvers" class="nav-link" data-scroll-target="#implementing-graphql-resolvers"><span class="header-section-number">12.6.5</span> 10.5.5 Implementing GraphQL Resolvers</a></li>
  <li><a href="#the-n1-problem-and-dataloader" id="toc-the-n1-problem-and-dataloader" class="nav-link" data-scroll-target="#the-n1-problem-and-dataloader"><span class="header-section-number">12.6.6</span> 10.5.6 The N+1 Problem and DataLoader</a></li>
  </ul></li>
  <li><a href="#api-documentation" id="toc-api-documentation" class="nav-link" data-scroll-target="#api-documentation"><span class="header-section-number">12.7</span> 10.6 API Documentation</a>
  <ul class="collapse">
  <li><a href="#openapi-specification" id="toc-openapi-specification" class="nav-link" data-scroll-target="#openapi-specification"><span class="header-section-number">12.7.1</span> 10.6.1 OpenAPI Specification</a></li>
  <li><a href="#serving-documentation" id="toc-serving-documentation" class="nav-link" data-scroll-target="#serving-documentation"><span class="header-section-number">12.7.2</span> 10.6.2 Serving Documentation</a></li>
  </ul></li>
  <li><a href="#data-validation" id="toc-data-validation" class="nav-link" data-scroll-target="#data-validation"><span class="header-section-number">12.8</span> 10.7 Data Validation</a>
  <ul class="collapse">
  <li><a href="#validation-with-joi" id="toc-validation-with-joi" class="nav-link" data-scroll-target="#validation-with-joi"><span class="header-section-number">12.8.1</span> 10.7.1 Validation with Joi</a></li>
  <li><a href="#centralized-error-handling" id="toc-centralized-error-handling" class="nav-link" data-scroll-target="#centralized-error-handling"><span class="header-section-number">12.8.2</span> 10.7.2 Centralized Error Handling</a></li>
  </ul></li>
  <li><a href="#api-security" id="toc-api-security" class="nav-link" data-scroll-target="#api-security"><span class="header-section-number">12.9</span> 10.8 API Security</a>
  <ul class="collapse">
  <li><a href="#authentication-with-jwt" id="toc-authentication-with-jwt" class="nav-link" data-scroll-target="#authentication-with-jwt"><span class="header-section-number">12.9.1</span> 10.8.1 Authentication with JWT</a></li>
  <li><a href="#rate-limiting" id="toc-rate-limiting" class="nav-link" data-scroll-target="#rate-limiting"><span class="header-section-number">12.9.2</span> 10.8.2 Rate Limiting</a></li>
  </ul></li>
  <li><a href="#caching-strategies" id="toc-caching-strategies" class="nav-link" data-scroll-target="#caching-strategies"><span class="header-section-number">12.10</span> 10.9 Caching Strategies</a>
  <ul class="collapse">
  <li><a href="#cache-aside-pattern" id="toc-cache-aside-pattern" class="nav-link" data-scroll-target="#cache-aside-pattern"><span class="header-section-number">12.10.1</span> 10.9.1 Cache-Aside Pattern</a></li>
  <li><a href="#cache-invalidation-challenges" id="toc-cache-invalidation-challenges" class="nav-link" data-scroll-target="#cache-invalidation-challenges"><span class="header-section-number">12.10.2</span> 10.9.2 Cache Invalidation Challenges</a></li>
  </ul></li>
  <li><a href="#chapter-summary" id="toc-chapter-summary" class="nav-link" data-scroll-target="#chapter-summary"><span class="header-section-number">12.11</span> 10.10 Chapter Summary</a></li>
  <li><a href="#key-terms" id="toc-key-terms" class="nav-link" data-scroll-target="#key-terms"><span class="header-section-number">12.12</span> 10.11 Key Terms</a></li>
  <li><a href="#review-questions" id="toc-review-questions" class="nav-link" data-scroll-target="#review-questions"><span class="header-section-number">12.13</span> 10.12 Review Questions</a></li>
  <li><a href="#hands-on-exercises" id="toc-hands-on-exercises" class="nav-link" data-scroll-target="#hands-on-exercises"><span class="header-section-number">12.14</span> 10.13 Hands-On Exercises</a>
  <ul class="collapse">
  <li><a href="#exercise-10.1-database-design" id="toc-exercise-10.1-database-design" class="nav-link" data-scroll-target="#exercise-10.1-database-design"><span class="header-section-number">12.14.1</span> Exercise 10.1: Database Design</a></li>
  <li><a href="#exercise-10.2-sql-query-practice" id="toc-exercise-10.2-sql-query-practice" class="nav-link" data-scroll-target="#exercise-10.2-sql-query-practice"><span class="header-section-number">12.14.2</span> Exercise 10.2: SQL Query Practice</a></li>
  <li><a href="#exercise-10.3-rest-api-implementation" id="toc-exercise-10.3-rest-api-implementation" class="nav-link" data-scroll-target="#exercise-10.3-rest-api-implementation"><span class="header-section-number">12.14.3</span> Exercise 10.3: REST API Implementation</a></li>
  <li><a href="#exercise-10.4-api-documentation" id="toc-exercise-10.4-api-documentation" class="nav-link" data-scroll-target="#exercise-10.4-api-documentation"><span class="header-section-number">12.14.4</span> Exercise 10.4: API Documentation</a></li>
  <li><a href="#exercise-10.5-caching-implementation" id="toc-exercise-10.5-caching-implementation" class="nav-link" data-scroll-target="#exercise-10.5-caching-implementation"><span class="header-section-number">12.14.5</span> Exercise 10.5: Caching Implementation</a></li>
  <li><a href="#exercise-10.6-graphql-alternative" id="toc-exercise-10.6-graphql-alternative" class="nav-link" data-scroll-target="#exercise-10.6-graphql-alternative"><span class="header-section-number">12.14.6</span> Exercise 10.6: GraphQL Alternative</a></li>
  </ul></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">12.15</span> 10.14 Further Reading</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">12.16</span> References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Chapter 10: Data Management and APIs</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">12.1</span> Learning Objectives</h2>
<p>By the end of this chapter, you will be able to:</p>
<ul>
<li>Design relational database schemas using normalization principles</li>
<li>Write SQL queries for data manipulation and retrieval</li>
<li>Compare relational and NoSQL databases and choose appropriately for different use cases</li>
<li>Design RESTful APIs following industry best practices</li>
<li>Implement CRUD operations with proper HTTP methods and status codes</li>
<li>Create GraphQL schemas and resolvers for flexible data fetching</li>
<li>Document APIs using OpenAPI/Swagger specifications</li>
<li>Implement data validation and meaningful error handling</li>
<li>Apply caching strategies to improve API performance</li>
<li>Secure APIs with authentication and authorization</li>
</ul>
<hr>
</section>
<section id="the-role-of-data-in-software-systems" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="the-role-of-data-in-software-systems"><span class="header-section-number">12.2</span> 10.1 The Role of Data in Software Systems</h2>
<p>Data is the lifeblood of modern applications. Every action a user takes—creating an account, posting a message, completing a task—generates data that must be stored, organized, and retrieved efficiently. The decisions you make about data management ripple through every aspect of your application, affecting performance, scalability, maintainability, and user experience.</p>
<p>Consider a task management application like the one we’re building throughout this course. When a user creates a task, that data must persist beyond the current session. When they log in from a different device, their tasks should appear. When they share a project with teammates, everyone needs to see the same information. These seemingly simple requirements demand careful thought about how data flows through your system.</p>
<section id="data-architecture-overview" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1" class="anchored" data-anchor-id="data-architecture-overview"><span class="header-section-number">12.2.1</span> 10.1.1 Data Architecture Overview</h3>
<p>Before diving into specific technologies, it’s important to understand how data typically moves through a modern application. The architecture below represents a common pattern you’ll encounter in production systems:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    APPLICATION DATA ARCHITECTURE                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                         ┌─────────────┐                                 │
│                         │   Clients   │                                 │
│                         │ (Web, Mobile)│                                │
│                         └──────┬──────┘                                 │
│                                │                                        │
│                                ▼                                        │
│                         ┌─────────────┐                                 │
│                         │     API     │                                 │
│                         │   Layer     │                                 │
│                         └──────┬──────┘                                 │
│                                │                                        │
│              ┌─────────────────┼─────────────────┐                      │
│              │                 │                 │                      │
│              ▼                 ▼                 ▼                      │
│       ┌───────────┐     ┌───────────┐     ┌───────────┐                │
│       │  Primary  │     │   Cache   │     │  Search   │                │
│       │ Database  │     │  (Redis)  │     │(Elastic)  │                │
│       │(PostgreSQL)│    └───────────┘     └───────────┘                │
│       └───────────┘                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p>In this architecture, clients (web browsers, mobile apps) never communicate directly with databases. Instead, they interact with an API layer that serves as a gatekeeper. This separation provides several benefits: the API can validate requests before they reach the database, enforce business rules, handle authentication, and present a consistent interface regardless of how data is stored internally.</p>
<p>The primary database (often PostgreSQL, MySQL, or a similar relational database) serves as the authoritative source of truth. This is where your critical business data lives—user accounts, orders, transactions, and other information that must be accurate and durable.</p>
<p>Auxiliary data stores serve specialized purposes. A cache like Redis stores frequently-accessed data in memory for lightning-fast retrieval. A search engine like Elasticsearch provides sophisticated full-text search capabilities that would be slow or impossible with a traditional database. Many production systems use multiple data stores, each optimized for specific access patterns—a strategy called “polyglot persistence.”</p>
</section>
<section id="key-data-management-concerns" class="level3" data-number="12.2.2">
<h3 data-number="12.2.2" class="anchored" data-anchor-id="key-data-management-concerns"><span class="header-section-number">12.2.2</span> 10.1.2 Key Data Management Concerns</h3>
<p>As you design your data layer, keep these fundamental concerns in mind:</p>
<p><strong>Data Integrity</strong> ensures that data is accurate, consistent, and trustworthy. When a user transfers money between accounts, the total balance must remain constant—you can’t create or destroy money through a software bug. Database constraints, validations, and transactions protect integrity by enforcing rules about what data can exist and how it can change.</p>
<p><strong>Data Security</strong> protects sensitive information from unauthorized access. User passwords must be hashed, not stored in plain text. Personal information must be encrypted. Access must be controlled so users can only see and modify their own data. Security isn’t an afterthought—it must be designed into your data layer from the beginning.</p>
<p><strong>Data Availability</strong> ensures that data is accessible when needed. If your database server crashes, can users still access the application? Replication (maintaining copies on multiple servers), backups (regular snapshots for disaster recovery), and failover mechanisms (automatic switching to backup systems) ensure availability.</p>
<p><strong>Data Scalability</strong> means handling growing data volumes and request rates without degrading performance. When your application grows from 100 users to 100,000 users, your data layer must scale accordingly. Indexing (creating data structures for fast lookups), sharding (distributing data across multiple servers), and caching (storing frequently-accessed data in fast memory) enable scalability.</p>
<p><strong>Data Consistency</strong> keeps data synchronized across systems. If a user updates their profile, that change should be visible everywhere immediately—or if not immediately, then eventually and predictably. Different applications have different consistency requirements, and understanding these trade-offs is essential for making good architectural decisions.</p>
<hr>
</section>
</section>
<section id="relational-databases" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="relational-databases"><span class="header-section-number">12.3</span> 10.2 Relational Databases</h2>
<p><strong>Relational databases</strong> have been the foundation of data management since Edgar Codd introduced the relational model in 1970. They organize data into tables with rows and columns, using relationships to connect related data. Despite the rise of NoSQL alternatives, relational databases remain the most common choice for applications with structured data and complex querying needs.</p>
<section id="core-concepts" class="level3" data-number="12.3.1">
<h3 data-number="12.3.1" class="anchored" data-anchor-id="core-concepts"><span class="header-section-number">12.3.1</span> 10.2.1 Core Concepts</h3>
<p>To work effectively with relational databases, you need to understand several foundational concepts. Let’s explore each one:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    RELATIONAL DATABASE CONCEPTS                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  TABLE (Relation)                                                       │
│  • Collection of related data organized into rows and columns           │
│  • Has a defined schema specifying column names and types               │
│  • Similar to a spreadsheet, but with strict typing                     │
│                                                                         │
│  COLUMN (Attribute)                                                     │
│  • Single piece of data with a specific meaning                         │
│  • Has a name (like "email") and data type (like VARCHAR)               │
│  • May have constraints (NOT NULL, UNIQUE, CHECK)                       │
│                                                                         │
│  ROW (Record/Tuple)                                                     │
│  • Single instance representing one entity                              │
│  • Contains values for each column defined in the table                 │
│  • Each row should be uniquely identifiable                             │
│                                                                         │
│  PRIMARY KEY                                                            │
│  • Column (or columns) that uniquely identifies each row                │
│  • Cannot contain NULL values                                           │
│  • Most commonly an auto-incrementing integer ID                        │
│                                                                         │
│  FOREIGN KEY                                                            │
│  • Column that references the primary key of another table              │
│  • Creates relationships between tables                                 │
│  • Enforces referential integrity (can't reference non-existent data)   │
│                                                                         │
│  INDEX                                                                  │
│  • Data structure that speeds up data retrieval                         │
│  • Like a book's index—helps find information quickly                   │
│  • Trade-off: faster reads but slower writes (index must be updated)    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p><strong>A Table</strong> is the fundamental unit of data organization. Think of it as a spreadsheet where each column has a specific data type. A <code>users</code> table might have columns for <code>id</code> (integer), <code>email</code> (text), <code>name</code> (text), and <code>created_at</code> (timestamp). Unlike spreadsheets, databases enforce these types strictly—you can’t accidentally put a name in the email column.</p>
<p><strong>Primary Keys</strong> solve the problem of identity. How do you refer to a specific user? Names aren’t unique (there might be multiple “John Smith” users), and emails can change. Instead, we assign each row a unique identifier—typically an auto-incrementing integer. This ID becomes the row’s permanent address within the database.</p>
<p><strong>Foreign Keys</strong> create connections between tables. If each task belongs to a user, the tasks table includes a <code>user_id</code> column containing the ID of the user who owns that task. This creates a relationship: you can find all tasks belonging to a user, or find the user who owns a particular task.</p>
<p>Let’s visualize these concepts with a concrete example from our task management application:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  users                          tasks                                   │
│  ┌──────────────────────┐       ┌──────────────────────────────┐       │
│  │ id (PK)              │       │ id (PK)                      │       │
│  │ email                │       │ title                        │       │
│  │ name                 │◄──────│ user_id (FK)                 │       │
│  │ password_hash        │       │ project_id (FK)              │       │
│  │ created_at           │       │ status                       │       │
│  │ updated_at           │       │ priority                     │       │
│  └──────────────────────┘       │ due_date                     │       │
│                                 │ created_at                   │       │
│  projects                       │ updated_at                   │       │
│  ┌──────────────────────┐       └──────────────────────────────┘       │
│  │ id (PK)              │                    │                         │
│  │ name                 │◄───────────────────┘                         │
│  │ description          │                                              │
│  │ owner_id (FK)        │───────► users.id                             │
│  │ created_at           │                                              │
│  └──────────────────────┘                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p>This diagram shows three tables and their relationships. The arrows indicate foreign key references—the direction points from the referencing table to the referenced table. Notice that:</p>
<ul>
<li>Each task has a <code>user_id</code> pointing to a user (the task’s assignee)</li>
<li>Each task optionally has a <code>project_id</code> pointing to a project</li>
<li>Each project has an <code>owner_id</code> pointing to a user (the project owner)</li>
</ul>
<p>These relationships create a web of connected data. A single query can traverse these connections to answer complex questions like “Show me all tasks in projects owned by users who joined this year.”</p>
</section>
<section id="sql-fundamentals" class="level3" data-number="12.3.2">
<h3 data-number="12.3.2" class="anchored" data-anchor-id="sql-fundamentals"><span class="header-section-number">12.3.2</span> 10.2.2 SQL Fundamentals</h3>
<p><strong>Structured Query Language (SQL)</strong> is the standard language for interacting with relational databases. Despite being over 50 years old, SQL remains essential because it provides a powerful, declarative way to describe what data you want without specifying how to retrieve it. The database engine optimizes query execution automatically.</p>
<p>SQL divides into two main categories: Data Definition Language (DDL) for creating and modifying database structure, and Data Manipulation Language (DML) for working with the data itself.</p>
<section id="data-definition-language-ddl" class="level4" data-number="12.3.2.1">
<h4 data-number="12.3.2.1" class="anchored" data-anchor-id="data-definition-language-ddl"><span class="header-section-number">12.3.2.1</span> Data Definition Language (DDL)</h4>
<p>DDL statements define the structure of your database—creating tables, adding columns, establishing constraints. These statements typically run during application setup or migrations, not during normal operation.</p>
<p>Let’s create the tables for our task management application. We’ll start with the users table:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> users (</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    email <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    name <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    password_hash <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This statement creates a table with six columns. Let’s understand each element:</p>
<ul>
<li><code>SERIAL PRIMARY KEY</code> creates an auto-incrementing integer that uniquely identifies each row. PostgreSQL automatically assigns values (1, 2, 3, …) when you insert new rows.</li>
<li><code>VARCHAR(255)</code> means variable-length text up to 255 characters. We use this for emails and names.</li>
<li><code>UNIQUE</code> ensures no two users can have the same email address. The database rejects insertions that would create duplicates.</li>
<li><code>NOT NULL</code> means this column must have a value—you can’t create a user without an email.</li>
<li><code>DEFAULT CURRENT_TIMESTAMP</code> automatically sets the creation time when a row is inserted.</li>
</ul>
<p>Now let’s create the projects table, which references users:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> projects (</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    name <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    description TEXT,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    owner_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>REFERENCES users(id)</code> clause creates a foreign key relationship. This tells the database that <code>owner_id</code> must contain a valid user ID—you can’t create a project owned by a non-existent user. The <code>ON DELETE CASCADE</code> clause specifies what happens when the referenced user is deleted: all their projects are automatically deleted too. This maintains referential integrity—you’ll never have orphaned projects pointing to deleted users.</p>
<p>Finally, the tasks table with multiple relationships and constraints:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> tasks (</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    title <span class="dt">VARCHAR</span>(<span class="dv">200</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    description TEXT,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    user_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    project_id <span class="dt">INTEGER</span> <span class="kw">REFERENCES</span> projects(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">SET</span> <span class="kw">NULL</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    status <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">DEFAULT</span> <span class="st">'todo'</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">CHECK</span> (status <span class="kw">IN</span> (<span class="st">'todo'</span>, <span class="st">'in_progress'</span>, <span class="st">'review'</span>, <span class="st">'done'</span>)),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    priority <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">0</span> <span class="kw">CHECK</span> (priority <span class="kw">BETWEEN</span> <span class="dv">0</span> <span class="kw">AND</span> <span class="dv">4</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    due_date <span class="dt">DATE</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This table introduces several new concepts. The <code>CHECK</code> constraint validates data before insertion—status must be one of the four allowed values, and priority must be between 0 and 4. The database enforces these rules automatically, preventing invalid data from entering your system.</p>
<p>Notice that <code>project_id</code> has a different deletion behavior: <code>ON DELETE SET NULL</code>. If a project is deleted, tasks aren’t deleted—instead, their <code>project_id</code> becomes NULL, indicating they’re no longer associated with any project. This design decision reflects business logic: deleting a project shouldn’t destroy the work recorded in its tasks.</p>
<p>After creating tables, we typically add indexes to speed up common queries:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_tasks_user_id <span class="kw">ON</span> tasks(user_id);</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_tasks_project_id <span class="kw">ON</span> tasks(project_id);</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_tasks_status <span class="kw">ON</span> tasks(status);</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_tasks_due_date <span class="kw">ON</span> tasks(due_date);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each index creates a data structure (typically a B-tree) that allows the database to find rows quickly without scanning the entire table. The <code>idx_tasks_user_id</code> index makes queries like “find all tasks for user 123” fast, even with millions of tasks.</p>
<p>However, indexes aren’t free. Each index consumes storage space and must be updated whenever data changes. Too many indexes slow down insertions and updates. The general rule: index columns that appear frequently in WHERE clauses or JOIN conditions.</p>
</section>
<section id="data-manipulation-language-dml" class="level4" data-number="12.3.2.2">
<h4 data-number="12.3.2.2" class="anchored" data-anchor-id="data-manipulation-language-dml"><span class="header-section-number">12.3.2.2</span> Data Manipulation Language (DML)</h4>
<p>DML statements work with the data itself: inserting new records, querying existing records, updating values, and deleting rows. These are the statements your application executes during normal operation.</p>
<p><strong>Inserting Data</strong></p>
<p>The INSERT statement adds new rows to a table:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> users (email, name, password_hash)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="st">'alice@example.com'</span>, <span class="st">'Alice Johnson'</span>, <span class="st">'$2b$10$...'</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice that we don’t specify <code>id</code>, <code>created_at</code>, or <code>updated_at</code>—these columns have defaults. The database automatically assigns the next available ID and current timestamp.</p>
<p>You can insert multiple rows in a single statement, which is more efficient than separate INSERT statements:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> tasks (title, description, user_id, project_id, status, priority, due_date)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Design homepage mockup'</span>, <span class="st">'Create wireframes and mockups'</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="st">'in_progress'</span>, <span class="dv">2</span>, <span class="st">'2024-12-15'</span>),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Implement navigation'</span>, <span class="st">'Build responsive nav component'</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="st">'todo'</span>, <span class="dv">1</span>, <span class="st">'2024-12-20'</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Write content'</span>, <span class="st">'Draft copy for main pages'</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="st">'todo'</span>, <span class="dv">1</span>, <span class="st">'2024-12-18'</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This single statement creates three tasks atomically—either all three are created or none are. This atomicity becomes important when you need to ensure data consistency.</p>
<p><strong>Querying Data</strong></p>
<p>The SELECT statement retrieves data from tables. It’s the most commonly used SQL statement and offers tremendous flexibility.</p>
<p>The simplest query retrieves all columns from a table:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> users;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In practice, you should specify the columns you need rather than using <code>*</code>. This makes your code clearer and can improve performance:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, name, email <span class="kw">FROM</span> users;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The WHERE clause filters results to rows matching specific conditions:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> tasks <span class="kw">WHERE</span> status <span class="op">=</span> <span class="st">'todo'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can combine multiple conditions with AND and OR:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> tasks </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> status <span class="op">=</span> <span class="st">'in_progress'</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> priority <span class="op">&gt;=</span> <span class="dv">2</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> due_date <span class="op">&lt;</span> <span class="st">'2024-12-31'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This query finds high-priority tasks that are in progress and due before year’s end. The database evaluates all conditions and returns only rows that satisfy all of them.</p>
<p>Sorting with ORDER BY arranges results in a specific order:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> tasks <span class="kw">ORDER</span> <span class="kw">BY</span> due_date <span class="kw">ASC</span>, priority <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This sorts tasks by due date (earliest first), and for tasks with the same due date, by priority (highest first). The ASC and DESC keywords specify ascending or descending order.</p>
<p>For large result sets, LIMIT and OFFSET enable pagination:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> tasks <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">id</span> <span class="kw">LIMIT</span> <span class="dv">10</span> OFFSET <span class="dv">20</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This retrieves tasks 21-30 (skip 20, take 10). Combined with ORDER BY, this pattern enables “page 3 of results” functionality in your application.</p>
<p><strong>Updating Data</strong></p>
<p>The UPDATE statement modifies existing rows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> tasks </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> status <span class="op">=</span> <span class="st">'done'</span>, updated_at <span class="op">=</span> <span class="fu">CURRENT_TIMESTAMP</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The WHERE clause is critical—without it, UPDATE affects every row in the table. Always include WHERE unless you intentionally want to update all rows.</p>
<p>You can use expressions in updates:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> tasks </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> priority <span class="op">=</span> priority <span class="op">+</span> <span class="dv">1</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> due_date <span class="op">&lt;</span> <span class="fu">CURRENT_DATE</span> <span class="kw">AND</span> status <span class="op">!=</span> <span class="st">'done'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This increases the priority of all overdue, incomplete tasks. The database evaluates <code>priority + 1</code> for each matching row.</p>
<p><strong>Deleting Data</strong></p>
<p>The DELETE statement removes rows:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> tasks <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Like UPDATE, DELETE without WHERE removes all rows—a dangerous operation. Most applications prefer “soft deletes” (marking rows as deleted rather than actually removing them) to preserve data and enable recovery.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> tasks </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> status <span class="op">=</span> <span class="st">'done'</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> updated_at <span class="op">&lt;</span> NOW() <span class="op">-</span> <span class="dt">INTERVAL</span> <span class="st">'30 days'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This cleanup query removes completed tasks older than 30 days. The <code>INTERVAL</code> syntax is PostgreSQL-specific; other databases have different date arithmetic syntax.</p>
</section>
<section id="joining-tables" class="level4" data-number="12.3.2.3">
<h4 data-number="12.3.2.3" class="anchored" data-anchor-id="joining-tables"><span class="header-section-number">12.3.2.3</span> Joining Tables</h4>
<p>The real power of relational databases emerges when you combine data from multiple tables. JOIN operations connect rows based on related columns.</p>
<p>An INNER JOIN returns only rows that have matches in both tables:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    t.<span class="kw">id</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    t.title,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    t.status,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    u.name <span class="kw">AS</span> assignee,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    p.name <span class="kw">AS</span> project_name</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> tasks t</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> users u <span class="kw">ON</span> t.user_id <span class="op">=</span> u.<span class="kw">id</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> projects p <span class="kw">ON</span> t.project_id <span class="op">=</span> p.<span class="kw">id</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s break down this query. We’re selecting from the <code>tasks</code> table (aliased as <code>t</code> for brevity). The first JOIN connects tasks to users: for each task, find the user whose ID matches the task’s user_id. The second JOIN connects to projects similarly.</p>
<p>The <code>AS</code> keyword creates column aliases—the results will show “assignee” and “project_name” rather than ambiguous “name” columns.</p>
<p>Important: INNER JOIN excludes tasks that don’t have a matching project (where project_id is NULL). If you want to include those tasks, use LEFT JOIN instead:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    u.name,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(t.<span class="kw">id</span>) <span class="kw">AS</span> task_count</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> users u</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> tasks t <span class="kw">ON</span> u.<span class="kw">id</span> <span class="op">=</span> t.user_id</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> u.<span class="kw">id</span>, u.name;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A LEFT JOIN returns all rows from the left table (users) regardless of whether they have matching rows in the right table (tasks). Users with no tasks appear in results with NULL values for task columns. This query counts how many tasks each user has—including users with zero tasks.</p>
<p>The GROUP BY clause is essential here. Without it, the query would fail because we’re mixing aggregate (COUNT) and non-aggregate (name) columns. GROUP BY tells the database to compute one result row per user.</p>
<p>Here’s a more complex example that generates project statistics:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    p.name <span class="kw">AS</span> project,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> t.status <span class="op">=</span> <span class="st">'done'</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">END</span>) <span class="kw">AS</span> completed,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> t.status <span class="op">!=</span> <span class="st">'done'</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">END</span>) <span class="kw">AS</span> remaining,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(t.<span class="kw">id</span>) <span class="kw">AS</span> total</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> projects p</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> tasks t <span class="kw">ON</span> p.<span class="kw">id</span> <span class="op">=</span> t.project_id</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> p.<span class="kw">id</span>, p.name</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> total <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This query demonstrates conditional aggregation using CASE expressions. For each project, we count tasks in different categories. The CASE expression returns 1 when the condition is true and NULL otherwise; COUNT ignores NULLs, so we effectively count only matching rows.</p>
</section>
<section id="aggregations-and-subqueries" class="level4" data-number="12.3.2.4">
<h4 data-number="12.3.2.4" class="anchored" data-anchor-id="aggregations-and-subqueries"><span class="header-section-number">12.3.2.4</span> Aggregations and Subqueries</h4>
<p>Aggregate functions compute values across multiple rows. The most common aggregates are:</p>
<ul>
<li><code>COUNT(*)</code> - number of rows</li>
<li><code>SUM(column)</code> - total of values</li>
<li><code>AVG(column)</code> - average value</li>
<li><code>MIN(column)</code> and <code>MAX(column)</code> - smallest and largest values</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total_tasks,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> status <span class="op">=</span> <span class="st">'done'</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">END</span>) <span class="kw">AS</span> completed_tasks,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">AVG</span>(estimated_hours) <span class="kw">AS</span> avg_estimate,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SUM</span>(estimated_hours) <span class="kw">AS</span> total_hours</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> tasks;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This query computes overall statistics for all tasks. Note that AVG ignores NULL values—if some tasks don’t have estimated_hours, they’re excluded from the average calculation.</p>
<p>GROUP BY creates separate aggregations for each group:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    status,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> <span class="fu">count</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">AVG</span>(priority) <span class="kw">AS</span> avg_priority</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> tasks</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> status;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This produces one row per status value, showing how many tasks are in each status and their average priority.</p>
<p>The HAVING clause filters groups (as opposed to WHERE, which filters individual rows):</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    user_id,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> task_count</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> tasks</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> user_id</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;</span> <span class="dv">5</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This finds users with more than 5 tasks. The filtering happens after grouping—you can’t use aggregate functions in WHERE clauses.</p>
<p><strong>Subqueries</strong> embed one query inside another:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> tasks</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> user_id <span class="kw">IN</span> (</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> users <span class="kw">WHERE</span> email <span class="kw">LIKE</span> <span class="st">'%@company.com'</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The inner query finds all user IDs with company email addresses. The outer query then finds all tasks belonging to those users. This is equivalent to a JOIN but sometimes reads more naturally.</p>
<p><strong>Common Table Expressions (CTEs)</strong> provide a cleaner way to write complex queries:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> task_stats <span class="kw">AS</span> (</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>        user_id,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total_tasks,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">COUNT</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> status <span class="op">=</span> <span class="st">'done'</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">END</span>) <span class="kw">AS</span> completed_tasks</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> tasks</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> user_id</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    u.name,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    ts.total_tasks,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    ts.completed_tasks,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ROUND</span>(ts.completed_tasks:<span class="ch">:DECIMAL</span> <span class="op">/</span> <span class="fu">NULLIF</span>(ts.total_tasks, <span class="dv">0</span>) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>) <span class="kw">AS</span> completion_rate</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> users u</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> task_stats ts <span class="kw">ON</span> u.<span class="kw">id</span> <span class="op">=</span> ts.user_id</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> completion_rate <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The WITH clause defines a temporary result set (task_stats) that we can reference in the main query. This improves readability for complex queries and can sometimes improve performance by allowing the database to materialize intermediate results.</p>
<p>The <code>NULLIF(ts.total_tasks, 0)</code> prevents division by zero—if a user has zero tasks, the expression returns NULL instead of causing an error.</p>
</section>
</section>
<section id="database-normalization" class="level3" data-number="12.3.3">
<h3 data-number="12.3.3" class="anchored" data-anchor-id="database-normalization"><span class="header-section-number">12.3.3</span> 10.2.3 Database Normalization</h3>
<p><strong>Normalization</strong> is the process of organizing data to minimize redundancy and dependency. Redundant data wastes storage and, more importantly, creates opportunities for inconsistency. If a customer’s address is stored in multiple places, updating it requires changing multiple records—miss one, and your data becomes inconsistent.</p>
<p>Normalization follows a series of “normal forms,” each building on the previous:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    NORMALIZATION FORMS                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  FIRST NORMAL FORM (1NF)                                                │
│  • Each column contains atomic (indivisible) values                     │
│  • No repeating groups or arrays within a single column                 │
│  • Each row is unique (has a primary key)                               │
│                                                                         │
│  SECOND NORMAL FORM (2NF)                                               │
│  • Meets all 1NF requirements                                           │
│  • All non-key columns depend on the entire primary key                 │
│  • No partial dependencies (relevant for composite keys)                │
│                                                                         │
│  THIRD NORMAL FORM (3NF)                                                │
│  • Meets all 2NF requirements                                           │
│  • No transitive dependencies                                           │
│  • Non-key columns depend only on the primary key, not on each other    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p>Let’s see normalization in action. Imagine we start with this denormalized orders table:</p>
<pre><code>BEFORE (Denormalized - Violates 1NF, 2NF, 3NF):
┌────────────────────────────────────────────────────────────────────────┐
│ orders                                                                 │
├──────────┬────────────┬─────────────────┬──────────┬──────────────────┤
│ order_id │ customer   │ customer_email  │ products │ product_prices   │
├──────────┼────────────┼─────────────────┼──────────┼──────────────────┤
│ 1        │ Alice      │ alice@email.com │ A, B, C  │ 10, 20, 30       │
│ 2        │ Alice      │ alice@email.com │ B, D     │ 20, 40           │
│ 3        │ Bob        │ bob@email.com   │ A        │ 10               │
└──────────┴────────────┴─────────────────┴──────────┴──────────────────┘</code></pre>
<p>This structure has multiple problems:</p>
<p><strong>1NF Violation</strong>: The products column contains multiple values (“A, B, C”). This makes it impossible to query efficiently—how do you find all orders containing product B? You’d need string manipulation, which is slow and error-prone.</p>
<p><strong>2NF Violation</strong>: Customer information (name, email) is repeated for every order. If Alice changes her email, you must update multiple rows. Miss one, and her email is inconsistent across orders.</p>
<p><strong>3NF Violation</strong>: Customer email depends on customer name, not on order_id. This is a “transitive dependency”—email depends on customer, which depends on order. Such dependencies cause update anomalies.</p>
<p>The normalized design separates concerns into distinct tables:</p>
<pre><code>AFTER (Normalized to 3NF):

customers                    products
┌────────────┬───────────┐   ┌────────────┬───────┬───────┐
│ id (PK)    │ email     │   │ id (PK)    │ name  │ price │
├────────────┼───────────┤   ├────────────┼───────┼───────┤
│ 1          │ alice@... │   │ 1          │ A     │ 10    │
│ 2          │ bob@...   │   │ 2          │ B     │ 20    │
└────────────┴───────────┘   │ 3          │ C     │ 30    │
                             │ 4          │ D     │ 40    │
orders                       └────────────┴───────┴───────┘
┌────────────┬─────────────┐
│ id (PK)    │ customer_id │  order_items (junction table)
├────────────┼─────────────┤  ┌──────────┬────────────┬──────────┐
│ 1          │ 1           │  │ order_id │ product_id │ quantity │
│ 2          │ 1           │  ├──────────┼────────────┼──────────┤
│ 3          │ 2           │  │ 1        │ 1          │ 1        │
└────────────┴─────────────┘  │ 1        │ 2          │ 1        │
                              │ 1        │ 3          │ 1        │
                              │ 2        │ 2          │ 1        │
                              │ 2        │ 4          │ 1        │
                              │ 3        │ 1          │ 1        │
                              └──────────┴────────────┴──────────┘</code></pre>
<p>Now each piece of information is stored exactly once. Customer data lives in the customers table. Product data lives in the products table. Orders reference customers by ID. The order_items “junction table” connects orders to products, enabling a many-to-many relationship (an order can contain many products; a product can appear in many orders).</p>
<p>To recreate the original denormalized view, we join the tables:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    o.<span class="kw">id</span> <span class="kw">AS</span> order_id,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    c.name <span class="kw">AS</span> customer,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    c.email,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    STRING_AGG(p.name, <span class="st">', '</span>) <span class="kw">AS</span> products,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SUM</span>(oi.price_at_time <span class="op">*</span> oi.quantity) <span class="kw">AS</span> total</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> orders o</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> customers c <span class="kw">ON</span> o.customer_id <span class="op">=</span> c.<span class="kw">id</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> order_items oi <span class="kw">ON</span> o.<span class="kw">id</span> <span class="op">=</span> oi.order_id</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> products p <span class="kw">ON</span> oi.product_id <span class="op">=</span> p.<span class="kw">id</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> o.<span class="kw">id</span>, c.name, c.email;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This query joins all four tables to produce a result similar to our original denormalized structure. The STRING_AGG function concatenates product names into a comma-separated list.</p>
<p>Notice the <code>price_at_time</code> column in order_items. This is a deliberate denormalization—we store the price at the time of purchase rather than referencing the products table. Why? Product prices change over time, but an order’s total should remain constant. This is an example of intentional denormalization for business requirements.</p>
</section>
<section id="transactions-and-acid-properties" class="level3" data-number="12.3.4">
<h3 data-number="12.3.4" class="anchored" data-anchor-id="transactions-and-acid-properties"><span class="header-section-number">12.3.4</span> 10.2.4 Transactions and ACID Properties</h3>
<p>Real-world operations often require multiple database changes that must succeed or fail together. Consider transferring money between bank accounts: you must debit one account AND credit another. If the system crashes between these operations, money would vanish or appear from nowhere.</p>
<p><strong>Transactions</strong> solve this problem by grouping operations into atomic units. The database guarantees that either all operations in a transaction complete successfully, or none of them do.</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    ACID PROPERTIES                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ATOMICITY                                                              │
│  All operations complete successfully, or none do. There's no partial   │
│  state—you can't have "half a transaction." If anything fails, all      │
│  changes are rolled back as if the transaction never happened.          │
│                                                                         │
│  CONSISTENCY                                                            │
│  A transaction brings the database from one valid state to another.     │
│  All constraints and rules remain satisfied. You can't end up with      │
│  invalid data, even if the transaction is interrupted.                  │
│                                                                         │
│  ISOLATION                                                              │
│  Concurrent transactions don't interfere with each other. Each          │
│  transaction sees a consistent snapshot of the database. Two users      │
│  booking the last airplane seat can't both succeed.                     │
│                                                                         │
│  DURABILITY                                                             │
│  Once a transaction commits, it stays committed—even if the server      │
│  crashes immediately afterward. The database writes to stable storage   │
│  before confirming the commit.                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p>Here’s a transaction that transfers money between accounts:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> accounts </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">-</span> <span class="dv">100</span> </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span> <span class="kw">AND</span> balance <span class="op">&gt;=</span> <span class="dv">100</span>;</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> accounts </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">+</span> <span class="dv">100</span> </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">2</span>;</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> transfers (from_account, to_account, amount, created_at)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">100</span>, <span class="fu">CURRENT_TIMESTAMP</span>);</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The BEGIN TRANSACTION statement starts a new transaction. All subsequent operations are part of this transaction. The COMMIT statement finalizes the transaction, making all changes permanent. If anything goes wrong before COMMIT, you can issue ROLLBACK to undo all changes.</p>
<p>The WHERE clause <code>balance &gt;= 100</code> is crucial—it prevents overdrafts. If the account doesn’t have sufficient funds, no rows are updated, and your application code should check this and roll back the transaction.</p>
<p>In application code, transaction management typically looks like this:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">transferFunds</span>(fromAccountId<span class="op">,</span> toAccountId<span class="op">,</span> amount) {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Start a transaction</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> trx <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">transaction</span>()<span class="op">;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attempt to debit source account</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The WHERE clause ensures sufficient balance</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> debited <span class="op">=</span> <span class="cf">await</span> <span class="fu">trx</span>(<span class="st">'accounts'</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> fromAccountId)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'balance'</span><span class="op">,</span> <span class="st">'&gt;='</span><span class="op">,</span> amount)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">decrement</span>(<span class="st">'balance'</span><span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if debit succeeded (row was updated)</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (debited <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Insufficient funds'</span>)<span class="op">;</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Credit destination account</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">trx</span>(<span class="st">'accounts'</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> toAccountId)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">increment</span>(<span class="st">'balance'</span><span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Record the transfer for audit trail</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">trx</span>(<span class="st">'transfers'</span>)<span class="op">.</span><span class="fu">insert</span>({</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">from_account</span><span class="op">:</span> fromAccountId<span class="op">,</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">to_account</span><span class="op">:</span> toAccountId<span class="op">,</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>      amount<span class="op">,</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created_at</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All operations succeeded—commit the transaction</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> trx<span class="op">.</span><span class="fu">commit</span>()<span class="op">;</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">success</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">;</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Something went wrong—rollback all changes</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> trx<span class="op">.</span><span class="fu">rollback</span>()<span class="op">;</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code demonstrates several important patterns. First, we create a transaction object (<code>trx</code>) and use it for all database operations. This ensures all operations are part of the same transaction. Second, we check the result of the debit operation—if no rows were updated (insufficient funds), we throw an error. Third, we wrap everything in try/catch to ensure we roll back on any error. Finally, we only commit after all operations succeed.</p>
<p>The beauty of transactions is that you don’t need to write cleanup code for each failure scenario. No matter where the error occurs—after the debit but before the credit, or after recording the transfer—the rollback undoes everything atomically.</p>
<hr>
</section>
</section>
<section id="nosql-databases" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="nosql-databases"><span class="header-section-number">12.4</span> 10.3 NoSQL Databases</h2>
<p>While relational databases excel at structured data with complex relationships, they’re not the best tool for every situation. <strong>NoSQL databases</strong> emerged to address specific use cases where relational databases struggle: massive scale, flexible schemas, high write throughput, or specialized data models.</p>
<p>The term “NoSQL” originally meant “No SQL,” but it’s now commonly understood as “Not Only SQL”—acknowledging that these databases complement rather than replace relational databases.</p>
<section id="types-of-nosql-databases" class="level3" data-number="12.4.1">
<h3 data-number="12.4.1" class="anchored" data-anchor-id="types-of-nosql-databases"><span class="header-section-number">12.4.1</span> 10.3.1 Types of NoSQL Databases</h3>
<p>NoSQL databases fall into four main categories, each optimized for different use cases:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    NOSQL DATABASE TYPES                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  DOCUMENT STORES                                                        │
│  Store data as JSON-like documents with flexible, nested structures.    │
│  Each document can have different fields—no fixed schema required.      │
│  Best for: Content management, user profiles, product catalogs         │
│  Examples: MongoDB, CouchDB, Firestore                                  │
│                                                                         │
│  KEY-VALUE STORES                                                       │
│  The simplest model: a key maps to a value. Values can be anything—     │
│  strings, numbers, or serialized objects. Extremely fast for lookups.   │
│  Best for: Caching, sessions, feature flags, real-time data            │
│  Examples: Redis, Memcached, Amazon DynamoDB                           │
│                                                                         │
│  COLUMN-FAMILY STORES                                                   │
│  Store data in columns rather than rows, enabling efficient queries     │
│  over specific columns across billions of rows.                         │
│  Best for: Analytics, time-series data, IoT sensor data                │
│  Examples: Apache Cassandra, HBase, ScyllaDB                           │
│                                                                         │
│  GRAPH DATABASES                                                        │
│  Store entities (nodes) and relationships (edges) as first-class        │
│  citizens. Optimized for traversing connections between data.           │
│  Best for: Social networks, recommendations, fraud detection           │
│  Examples: Neo4j, Amazon Neptune, ArangoDB                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
</section>
<section id="document-databases-mongodb" class="level3" data-number="12.4.2">
<h3 data-number="12.4.2" class="anchored" data-anchor-id="document-databases-mongodb"><span class="header-section-number">12.4.2</span> 10.3.2 Document Databases (MongoDB)</h3>
<p>Document databases store data as self-contained documents, typically in JSON or a binary JSON variant (BSON). Unlike relational tables with fixed columns, documents can have varying structures. This flexibility makes document databases excellent for evolving schemas and hierarchical data.</p>
<p>Here’s how a user might be represented in MongoDB:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"_id"</span><span class="op">:</span> <span class="fu">ObjectId</span>(<span class="st">"507f1f77bcf86cd799439011"</span>)<span class="op">,</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"email"</span><span class="op">:</span> <span class="st">"alice@example.com"</span><span class="op">,</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"name"</span><span class="op">:</span> <span class="st">"Alice Johnson"</span><span class="op">,</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"profile"</span><span class="op">:</span> {</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"avatar"</span><span class="op">:</span> <span class="st">"https://example.com/avatars/alice.jpg"</span><span class="op">,</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bio"</span><span class="op">:</span> <span class="st">"Software developer"</span><span class="op">,</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location"</span><span class="op">:</span> <span class="st">"San Francisco"</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tasks"</span><span class="op">:</span> [</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"title"</span><span class="op">:</span> <span class="st">"Complete project proposal"</span><span class="op">,</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"status"</span><span class="op">:</span> <span class="st">"in_progress"</span><span class="op">,</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"priority"</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">"tags"</span><span class="op">:</span> [<span class="st">"work"</span><span class="op">,</span> <span class="st">"urgent"</span>]<span class="op">,</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">"due_date"</span><span class="op">:</span> <span class="fu">ISODate</span>(<span class="st">"2024-12-15"</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">"title"</span><span class="op">:</span> <span class="st">"Review pull requests"</span><span class="op">,</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">"status"</span><span class="op">:</span> <span class="st">"todo"</span><span class="op">,</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">"priority"</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">"tags"</span><span class="op">:</span> [<span class="st">"work"</span>]<span class="op">,</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">"due_date"</span><span class="op">:</span> <span class="fu">ISODate</span>(<span class="st">"2024-12-10"</span>)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"settings"</span><span class="op">:</span> {</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"theme"</span><span class="op">:</span> <span class="st">"dark"</span><span class="op">,</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"notifications"</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"language"</span><span class="op">:</span> <span class="st">"en"</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"created_at"</span><span class="op">:</span> <span class="fu">ISODate</span>(<span class="st">"2024-01-15"</span>)<span class="op">,</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"updated_at"</span><span class="op">:</span> <span class="fu">ISODate</span>(<span class="st">"2024-12-09"</span>)</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice several differences from relational design. First, the document contains nested objects (<code>profile</code>, <code>settings</code>) that would require separate tables in a relational database. Second, the <code>tasks</code> array embeds related data directly within the user document. Third, different users could have different fields—one might have a <code>company</code> field that others lack.</p>
<p>This embedding pattern eliminates JOINs for common access patterns. If you typically fetch a user with their tasks, having everything in one document means a single database round-trip instead of multiple queries.</p>
<p>Let’s see how to work with MongoDB in Node.js:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { MongoClient } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'mongodb'</span>)<span class="op">;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Connect to MongoDB</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">MongoClient</span>(<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">MONGODB_URI</span>)<span class="op">;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> db <span class="op">=</span> client<span class="op">.</span><span class="fu">db</span>(<span class="st">'taskflow'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Creating documents</strong> uses the insertOne or insertMany methods:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Insert a single user</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db<span class="op">.</span><span class="fu">collection</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">insertOne</span>({</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">email</span><span class="op">:</span> <span class="st">'bob@example.com'</span><span class="op">,</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">'Bob Smith'</span><span class="op">,</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tasks</span><span class="op">:</span> []<span class="op">,</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">created_at</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Insert multiple documents at once</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db<span class="op">.</span><span class="fu">collection</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">insertMany</span>([</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">email</span><span class="op">:</span> <span class="st">'carol@example.com'</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">'Carol White'</span><span class="op">,</span> <span class="dt">tasks</span><span class="op">:</span> [] }<span class="op">,</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">email</span><span class="op">:</span> <span class="st">'dave@example.com'</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">'Dave Brown'</span><span class="op">,</span> <span class="dt">tasks</span><span class="op">:</span> [] }</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>MongoDB automatically generates unique <code>_id</code> fields if you don’t provide them. These ObjectIds include a timestamp, making them roughly sortable by creation time.</p>
<p><strong>Querying documents</strong> offers flexible filtering:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Find a single document by field value</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">collection</span>(<span class="st">'users'</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">findOne</span>({ <span class="dt">email</span><span class="op">:</span> <span class="st">'alice@example.com'</span> })<span class="op">;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Find documents with embedded array matching</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">// This finds users who have at least one in_progress task</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> busyUsers <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">collection</span>(<span class="st">'users'</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">find</span>({ <span class="st">'tasks.status'</span><span class="op">:</span> <span class="st">'in_progress'</span> })</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">toArray</span>()<span class="op">;</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Project specific fields (like SQL SELECT)</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Only returns name and email, not the entire document</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> userNames <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">collection</span>(<span class="st">'users'</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">find</span>({}<span class="op">,</span> { <span class="dt">projection</span><span class="op">:</span> { <span class="dt">name</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> <span class="dv">1</span> } })</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">toArray</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The dot notation (<code>tasks.status</code>) allows querying nested fields and array elements. This is powerful but requires understanding how MongoDB handles array queries—<code>'tasks.status': 'in_progress'</code> finds documents where ANY task has that status.</p>
<p><strong>Updating documents</strong> can modify the entire document or specific fields:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Update a single field using $set</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Other fields remain unchanged</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db<span class="op">.</span><span class="fu">collection</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">email</span><span class="op">:</span> <span class="st">'alice@example.com'</span> }<span class="op">,</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">$set</span><span class="op">:</span> { <span class="st">'profile.bio'</span><span class="op">:</span> <span class="st">'Senior developer'</span> } }</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Add an element to an array using $push</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db<span class="op">.</span><span class="fu">collection</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">email</span><span class="op">:</span> <span class="st">'alice@example.com'</span> }<span class="op">,</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  { </span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">$push</span><span class="op">:</span> { </span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tasks</span><span class="op">:</span> {</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">title</span><span class="op">:</span> <span class="st">'New task'</span><span class="op">,</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">status</span><span class="op">:</span> <span class="st">'todo'</span><span class="op">,</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">created_at</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Update a specific array element using $ positional operator</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="co">// This updates the status of the task with title "Complete project proposal"</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db<span class="op">.</span><span class="fu">collection</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>  { </span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">email</span><span class="op">:</span> <span class="st">'alice@example.com'</span><span class="op">,</span> </span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tasks.title'</span><span class="op">:</span> <span class="st">'Complete project proposal'</span> </span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">$set</span><span class="op">:</span> { <span class="st">'tasks.$.status'</span><span class="op">:</span> <span class="st">'done'</span> } }</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>$</code> positional operator is crucial for updating array elements. It refers to the first array element that matched the query condition. Without it, you’d need to know the exact array index.</p>
<p>MongoDB’s update operators (<code>$set</code>, <code>$push</code>, <code>$pull</code>, <code>$inc</code>, etc.) enable atomic modifications without reading and rewriting entire documents. This is both more efficient and safer for concurrent updates.</p>
</section>
<section id="key-value-stores-redis" class="level3" data-number="12.4.3">
<h3 data-number="12.4.3" class="anchored" data-anchor-id="key-value-stores-redis"><span class="header-section-number">12.4.3</span> 10.3.3 Key-Value Stores (Redis)</h3>
<p>Redis is an in-memory data store that excels at speed. Because data lives in RAM rather than on disk, Redis can handle millions of operations per second with sub-millisecond latency. This makes it ideal for caching, session storage, and real-time features.</p>
<p>The trade-off is capacity—RAM is more expensive than disk storage, so Redis typically holds a subset of your data: frequently accessed items, temporary data, or data that needs extremely fast access.</p>
<p>Let’s explore Redis’s versatile data structures:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Redis <span class="op">=</span> <span class="pp">require</span>(<span class="st">'ioredis'</span>)<span class="op">;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> redis <span class="op">=</span> <span class="kw">new</span> <span class="fu">Redis</span>(<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">REDIS_URL</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Basic key-value operations</strong> are the foundation:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Store a simple value</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">set</span>(<span class="st">'user:1:name'</span><span class="op">,</span> <span class="st">'Alice'</span>)<span class="op">;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Retrieve a value</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> name <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">get</span>(<span class="st">'user:1:name'</span>)<span class="op">;</span>  <span class="co">// 'Alice'</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Set with automatic expiration (TTL)</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co">// This key will disappear after 1 hour</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">set</span>(<span class="st">'session:abc123'</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">userId</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">,</span> <span class="st">'EX'</span><span class="op">,</span> <span class="dv">3600</span>)<span class="op">;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Check remaining time-to-live</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ttl <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">ttl</span>(<span class="st">'session:abc123'</span>)<span class="op">;</span>  <span class="co">// seconds remaining</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The key naming convention (<code>user:1:name</code>) is a Redis best practice. Using colons to create hierarchical namespaces makes keys self-documenting and easier to manage.</p>
<p>Expiration (TTL) is essential for cache management. Without it, cached data would accumulate forever. By setting appropriate TTLs, stale data automatically disappears.</p>
<p><strong>Hashes</strong> store object-like structures efficiently:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Store multiple fields at once</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">hset</span>(<span class="st">'user:1'</span><span class="op">,</span> {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">'Alice'</span><span class="op">,</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">email</span><span class="op">:</span> <span class="st">'alice@example.com'</span><span class="op">,</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">role</span><span class="op">:</span> <span class="st">'admin'</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Retrieve all fields</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">hgetall</span>(<span class="st">'user:1'</span>)<span class="op">;</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co">// { name: 'Alice', email: 'alice@example.com', role: 'admin' }</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Retrieve single field</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> email <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">hget</span>(<span class="st">'user:1'</span><span class="op">,</span> <span class="st">'email'</span>)<span class="op">;</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Increment a numeric field atomically</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">hincrby</span>(<span class="st">'user:1'</span><span class="op">,</span> <span class="st">'login_count'</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Hashes are more memory-efficient than storing each field as a separate key. They also enable atomic operations on individual fields without reading/writing the entire object.</p>
<p><strong>Lists</strong> provide ordered collections:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Push to the front of a list (newest first)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">lpush</span>(<span class="st">'notifications:1'</span><span class="op">,</span> <span class="st">'New message'</span>)<span class="op">;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">lpush</span>(<span class="st">'notifications:1'</span><span class="op">,</span> <span class="st">'Task assigned'</span>)<span class="op">;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Get a range of elements (0 to -1 means all)</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> notifications <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">lrange</span>(<span class="st">'notifications:1'</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ['Task assigned', 'New message']</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Pop from the list (remove and return)</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> latest <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">lpop</span>(<span class="st">'notifications:1'</span>)<span class="op">;</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Trim to keep only recent items</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">ltrim</span>(<span class="st">'notifications:1'</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">99</span>)<span class="op">;</span>  <span class="co">// Keep only 100 newest</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Lists are perfect for activity feeds, queues, and recent items. The lpush/rpop combination creates a queue (FIFO), while lpush/lpop creates a stack (LIFO).</p>
<p><strong>Sets</strong> store unique values:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add members (duplicates are ignored)</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">sadd</span>(<span class="st">'user:1:tags'</span><span class="op">,</span> <span class="st">'developer'</span><span class="op">,</span> <span class="st">'team-lead'</span><span class="op">,</span> <span class="st">'remote'</span>)<span class="op">;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">sadd</span>(<span class="st">'user:1:tags'</span><span class="op">,</span> <span class="st">'developer'</span>)<span class="op">;</span>  <span class="co">// No effect—already exists</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Get all members</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> tags <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">smembers</span>(<span class="st">'user:1:tags'</span>)<span class="op">;</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ['developer', 'team-lead', 'remote']</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Check membership</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> isRemote <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">sismember</span>(<span class="st">'user:1:tags'</span><span class="op">,</span> <span class="st">'remote'</span>)<span class="op">;</span>  <span class="co">// 1 (true)</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Set operations</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> user1Tags <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">smembers</span>(<span class="st">'user:1:tags'</span>)<span class="op">;</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> user2Tags <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">smembers</span>(<span class="st">'user:2:tags'</span>)<span class="op">;</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> commonTags <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">sinter</span>(<span class="st">'user:1:tags'</span><span class="op">,</span> <span class="st">'user:2:tags'</span>)<span class="op">;</span>  <span class="co">// Intersection</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Sets are useful for tags, unique visitors, online users, and any scenario where you need fast membership testing without duplicates.</p>
<p><strong>Sorted sets</strong> add scoring for automatic ordering:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add members with scores</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">zadd</span>(<span class="st">'leaderboard'</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="st">'alice'</span><span class="op">,</span> <span class="dv">85</span><span class="op">,</span> <span class="st">'bob'</span><span class="op">,</span> <span class="dv">92</span><span class="op">,</span> <span class="st">'carol'</span>)<span class="op">;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Get top performers (highest scores first)</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> topThree <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">zrevrange</span>(<span class="st">'leaderboard'</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="st">'WITHSCORES'</span>)<span class="op">;</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co">// ['alice', '100', 'carol', '92', 'bob', '85']</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Get rank (position) of a member</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> aliceRank <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">zrevrank</span>(<span class="st">'leaderboard'</span><span class="op">,</span> <span class="st">'alice'</span>)<span class="op">;</span>  <span class="co">// 0 (first place)</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Increment a score</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> redis<span class="op">.</span><span class="fu">zincrby</span>(<span class="st">'leaderboard'</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="st">'bob'</span>)<span class="op">;</span>  <span class="co">// Bob now has 95 points</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Sorted sets are perfect for leaderboards, priority queues, and time-based indexes (using timestamps as scores).</p>
<p><strong>Implementing a caching layer</strong> is one of Redis’s most common uses:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">getUserWithCache</span>(userId) {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cacheKey <span class="op">=</span> <span class="vs">`user:</span><span class="sc">${</span>userId<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 1: Check the cache</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cached <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">get</span>(cacheKey)<span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cached) {</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Cache hit!'</span>)<span class="op">;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(cached)<span class="op">;</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 2: Cache miss—fetch from primary database</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Cache miss—fetching from database'</span>)<span class="op">;</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> userId)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 3: Store in cache for future requests</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (user) {</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> redis<span class="op">.</span><span class="fu">set</span>(cacheKey<span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(user)<span class="op">,</span> <span class="st">'EX'</span><span class="op">,</span> <span class="dv">300</span>)<span class="op">;</span>  <span class="co">// 5 minutes</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> user<span class="op">;</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This “cache-aside” pattern checks the cache first, falls back to the database on miss, and populates the cache for future requests. The 5-minute TTL balances freshness against database load.</p>
<p><strong>Cache invalidation</strong> is equally important—when data changes, the cache must be updated or cleared:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">updateUser</span>(userId<span class="op">,</span> updates) {</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Update the primary database</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> userId)<span class="op">.</span><span class="fu">update</span>(updates)<span class="op">;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Invalidate the cache (delete, don't update)</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Next read will fetch fresh data from database</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> redis<span class="op">.</span><span class="fu">del</span>(<span class="vs">`user:</span><span class="sc">${</span>userId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Deleting rather than updating the cache is usually safer. It ensures the next read gets fresh data from the authoritative source (the database), avoiding any possibility of the cache and database becoming inconsistent.</p>
</section>
<section id="choosing-between-sql-and-nosql" class="level3" data-number="12.4.4">
<h3 data-number="12.4.4" class="anchored" data-anchor-id="choosing-between-sql-and-nosql"><span class="header-section-number">12.4.4</span> 10.3.4 Choosing Between SQL and NoSQL</h3>
<p>The choice between SQL and NoSQL isn’t about which is “better”—it’s about which fits your specific requirements. Here’s a framework for making this decision:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    SQL vs. NOSQL COMPARISON                             │
├───────────────────────────┬─────────────────────────────────────────────┤
│        RELATIONAL (SQL)   │           NOSQL                             │
├───────────────────────────┼─────────────────────────────────────────────┤
│ Fixed schema              │ Flexible schema                             │
│ ACID transactions         │ Eventual consistency (usually)              │
│ Complex queries (JOINs)   │ Simple queries, denormalized data           │
│ Vertical scaling          │ Horizontal scaling                          │
│ Mature tooling            │ Newer, varied tooling                       │
│ Strong consistency        │ High availability                           │
└───────────────────────────┴─────────────────────────────────────────────┘</code></pre>
<p><strong>Choose a relational database when:</strong></p>
<ul>
<li>Data has clear relationships that benefit from JOINs</li>
<li>ACID compliance is required (financial transactions, inventory)</li>
<li>You need complex queries and ad-hoc reporting</li>
<li>Schema is well-defined and relatively stable</li>
<li>Data integrity is paramount</li>
</ul>
<p>Examples: Banking systems, e-commerce orders, ERP systems, traditional web applications</p>
<p><strong>Choose NoSQL when:</strong></p>
<ul>
<li>Schema evolves frequently or varies between records</li>
<li>Massive scale is required (millions of writes per second)</li>
<li>Simple access patterns (key-based lookup, document retrieval)</li>
<li>Data is naturally hierarchical or document-shaped</li>
<li>High availability is more important than consistency</li>
</ul>
<p>Examples: Content management systems, real-time analytics, IoT sensor data, user session storage</p>
<p><strong>Many production systems use both</strong> (polyglot persistence):</p>
<ul>
<li>PostgreSQL for core business data (users, orders, payments)</li>
<li>Redis for caching and sessions</li>
<li>Elasticsearch for full-text search</li>
<li>MongoDB for flexible content or audit logs</li>
</ul>
<p>This approach uses each database for what it does best. The complexity cost is worthwhile when different data has genuinely different requirements.</p>
<hr>
</section>
</section>
<section id="restful-api-design" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="restful-api-design"><span class="header-section-number">12.5</span> 10.4 RESTful API Design</h2>
<p>With data stored in databases, we need a way for applications to access it. <strong>REST (Representational State Transfer)</strong> is an architectural style that has become the dominant approach for web APIs. REST APIs use HTTP methods to perform operations on resources, providing a uniform, stateless interface.</p>
<section id="rest-principles" class="level3" data-number="12.5.1">
<h3 data-number="12.5.1" class="anchored" data-anchor-id="rest-principles"><span class="header-section-number">12.5.1</span> 10.4.1 REST Principles</h3>
<p>REST is built on several key principles that guide API design:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    REST PRINCIPLES                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  CLIENT-SERVER SEPARATION                                               │
│  Clients and servers evolve independently. The server doesn't know or   │
│  care whether it's serving a web app, mobile app, or CLI tool.          │
│                                                                         │
│  STATELESSNESS                                                          │
│  Each request contains all information needed to process it. The        │
│  server doesn't remember previous requests. This simplifies scaling—    │
│  any server can handle any request.                                     │
│                                                                         │
│  CACHEABILITY                                                           │
│  Responses indicate whether they can be cached. This improves           │
│  performance and reduces server load.                                   │
│                                                                         │
│  UNIFORM INTERFACE                                                      │
│  All resources are accessed through a consistent interface: URIs        │
│  identify resources, HTTP methods perform operations, standard          │
│  formats (JSON) represent data.                                         │
│                                                                         │
│  LAYERED SYSTEM                                                         │
│  Clients can't tell whether they're connected directly to the server    │
│  or through intermediaries (load balancers, caches, gateways).          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p>The <strong>statelessness</strong> principle deserves emphasis. In a REST API, the server doesn’t maintain session state between requests. If a user is logged in, every request must include authentication information (typically a token). This seems redundant, but it enables horizontal scaling—since any server can handle any request, you can add servers to handle more load without worrying about session affinity.</p>
</section>
<section id="resource-oriented-design" class="level3" data-number="12.5.2">
<h3 data-number="12.5.2" class="anchored" data-anchor-id="resource-oriented-design"><span class="header-section-number">12.5.2</span> 10.4.2 Resource-Oriented Design</h3>
<p>In REST, everything is a <strong>resource</strong>—a conceptual entity that can be identified, retrieved, and manipulated. Resources are identified by URIs (Uniform Resource Identifiers) and typically represent nouns in your domain: users, tasks, projects, comments.</p>
<p>Good URI design follows consistent conventions:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    RESOURCE NAMING CONVENTIONS                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  USE NOUNS, NOT VERBS                                                   │
│  Resources are things, not actions.                                     │
│  ✓ /users                    ✗ /getUsers                               │
│  ✓ /tasks                    ✗ /createTask                             │
│  ✓ /projects/123/tasks       ✗ /getTasksForProject                     │
│                                                                         │
│  USE PLURAL NOUNS                                                       │
│  Consistency makes the API predictable.                                 │
│  ✓ /users                    ✗ /user                                   │
│  ✓ /users/123                ✗ /user/123                               │
│                                                                         │
│  USE HIERARCHY FOR RELATIONSHIPS                                        │
│  Nested resources show ownership or containment.                        │
│  ✓ /projects/123/tasks       (tasks belonging to project 123)          │
│  ✓ /users/456/notifications  (notifications for user 456)              │
│                                                                         │
│  USE LOWERCASE AND HYPHENS                                              │
│  URIs are case-sensitive; consistency prevents errors.                  │
│  ✓ /task-comments            ✗ /taskComments                           │
│  ✓ /user-profiles            ✗ /UserProfiles                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p>For our task management API, here’s how resources map to URIs:</p>
<pre><code>/users                      Collection of all users
/users/123                  Single user with ID 123
/users/123/tasks            Tasks assigned to user 123
/users/123/projects         Projects owned by user 123

/projects                   Collection of all projects
/projects/456               Single project with ID 456
/projects/456/tasks         Tasks within project 456
/projects/456/members       Members of project 456

/tasks                      Collection of all tasks
/tasks/789                  Single task with ID 789
/tasks/789/comments         Comments on task 789
/tasks/789/attachments      Files attached to task 789</code></pre>
<p>Notice how the hierarchy expresses relationships. <code>/projects/456/tasks</code> and <code>/users/123/tasks</code> might return different (or overlapping) sets of tasks, filtered by project or assignee respectively.</p>
</section>
<section id="http-methods-and-crud-operations" class="level3" data-number="12.5.3">
<h3 data-number="12.5.3" class="anchored" data-anchor-id="http-methods-and-crud-operations"><span class="header-section-number">12.5.3</span> 10.4.3 HTTP Methods and CRUD Operations</h3>
<p>REST uses HTTP methods to indicate what operation to perform on a resource. Each method has specific semantics that clients and servers agree on:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    HTTP METHODS AND OPERATIONS                          │
├──────────┬─────────────┬────────────────────────────────────────────────┤
│  Method  │  Operation  │  Description                                   │
├──────────┼─────────────┼────────────────────────────────────────────────┤
│  GET     │  Read       │  Retrieve resource(s). Safe—doesn't modify     │
│          │             │  data. Cacheable.                              │
├──────────┼─────────────┼────────────────────────────────────────────────┤
│  POST    │  Create     │  Create a new resource. The server assigns     │
│          │             │  the ID and returns the created resource.      │
├──────────┼─────────────┼────────────────────────────────────────────────┤
│  PUT     │  Replace    │  Replace an entire resource. Client provides   │
│          │             │  all fields; missing fields are cleared.       │
├──────────┼─────────────┼────────────────────────────────────────────────┤
│  PATCH   │  Update     │  Partial update. Client provides only the      │
│          │             │  fields to change.                             │
├──────────┼─────────────┼────────────────────────────────────────────────┤
│  DELETE  │  Delete     │  Remove a resource. Often returns empty        │
│          │             │  response (204 No Content).                    │
└──────────┴─────────────┴────────────────────────────────────────────────┘</code></pre>
<p>Two important properties distinguish these methods:</p>
<p><strong>Safety</strong>: GET requests are “safe”—they only retrieve data without side effects. You can call GET as many times as you want without changing anything. This allows aggressive caching and prefetching.</p>
<p><strong>Idempotency</strong>: GET, PUT, and DELETE are idempotent—calling them multiple times has the same effect as calling once. If you PUT the same data twice, the resource ends up in the same state. POST is NOT idempotent—each POST typically creates a new resource.</p>
<p>Here’s how these methods apply to our tasks resource:</p>
<pre><code>GET    /api/tasks              List all tasks (with pagination)
GET    /api/tasks/123          Get task with ID 123
POST   /api/tasks              Create a new task
PUT    /api/tasks/123          Replace task 123 entirely
PATCH  /api/tasks/123          Update specific fields of task 123
DELETE /api/tasks/123          Delete task 123

GET    /api/tasks?status=todo                Filter tasks by status
GET    /api/tasks?page=2&amp;limit=20            Paginate results
GET    /api/tasks?sort=due_date&amp;order=asc    Sort results</code></pre>
<p>Query parameters modify GET requests—filtering, pagination, and sorting change which resources are returned and in what order, but they don’t create or modify resources.</p>
</section>
<section id="http-status-codes" class="level3" data-number="12.5.4">
<h3 data-number="12.5.4" class="anchored" data-anchor-id="http-status-codes"><span class="header-section-number">12.5.4</span> 10.4.4 HTTP Status Codes</h3>
<p>Status codes communicate the result of an API request. Using appropriate codes makes your API self-documenting and helps clients handle responses correctly:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    ESSENTIAL STATUS CODES                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  SUCCESS (2xx)                                                          │
│  200 OK              Request succeeded. Body contains result.           │
│  201 Created         Resource created. Body contains new resource.      │
│  204 No Content      Success, but no body (common for DELETE).          │
│                                                                         │
│  CLIENT ERRORS (4xx) — Problem with the request                         │
│  400 Bad Request     Malformed request (invalid JSON, wrong format).    │
│  401 Unauthorized    Authentication required or failed.                 │
│  403 Forbidden       Authenticated, but not authorized for this.        │
│  404 Not Found       Resource doesn't exist.                            │
│  409 Conflict        Request conflicts with current state.              │
│  422 Unprocessable   Valid request, but validation failed.              │
│  429 Too Many        Rate limit exceeded.                               │
│                                                                         │
│  SERVER ERRORS (5xx) — Problem on the server                            │
│  500 Internal Error  Unexpected server error (bug, crash).              │
│  502 Bad Gateway     Invalid response from upstream server.             │
│  503 Unavailable     Server temporarily overloaded or down.             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p>The distinction between 401 and 403 often confuses developers:</p>
<ul>
<li><strong>401 Unauthorized</strong>: “I don’t know who you are. Please authenticate.”</li>
<li><strong>403 Forbidden</strong>: “I know who you are, but you can’t do this.”</li>
</ul>
<p>Similarly, 400 vs 422:</p>
<ul>
<li><strong>400 Bad Request</strong>: The request is malformed (can’t parse JSON, missing required header).</li>
<li><strong>422 Unprocessable Entity</strong>: The request is valid, but the data fails validation (email format wrong, title too long).</li>
</ul>
</section>
<section id="implementing-a-restful-api" class="level3" data-number="12.5.5">
<h3 data-number="12.5.5" class="anchored" data-anchor-id="implementing-a-restful-api"><span class="header-section-number">12.5.5</span> 10.4.5 Implementing a RESTful API</h3>
<p>Let’s build a complete REST API for tasks using Express.js. We’ll structure the code into layers: routes (HTTP handling), services (business logic), and a clean separation of concerns.</p>
<p>First, the route handlers that define our endpoints:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">// routes/tasks.js</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">'express'</span>)<span class="op">;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> router <span class="op">=</span> express<span class="op">.</span><span class="fu">Router</span>()<span class="op">;</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { authenticate } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'../middleware/auth'</span>)<span class="op">;</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { validate } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'../middleware/validate'</span>)<span class="op">;</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> taskSchema <span class="op">=</span> <span class="pp">require</span>(<span class="st">'../schemas/task'</span>)<span class="op">;</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> taskService <span class="op">=</span> <span class="pp">require</span>(<span class="st">'../services/taskService'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This file begins by importing dependencies. We separate concerns: authentication middleware verifies the user, validation middleware checks request data, and the service layer handles business logic. This structure makes each piece testable and replaceable.</p>
<p>The list endpoint returns paginated, filtered tasks:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">// GET /api/tasks - List tasks with filtering and pagination</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">get</span>(<span class="st">'/'</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Extract query parameters with defaults</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>      page <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>      limit <span class="op">=</span> <span class="dv">20</span><span class="op">,</span> </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>      status<span class="op">,</span> </span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>      priority<span class="op">,</span> </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>      sort <span class="op">=</span> <span class="st">'created_at'</span><span class="op">,</span> </span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>      order <span class="op">=</span> <span class="st">'desc'</span> </span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    } <span class="op">=</span> req<span class="op">.</span><span class="at">query</span><span class="op">;</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call service layer with parsed parameters</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> taskService<span class="op">.</span><span class="fu">list</span>({</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">userId</span><span class="op">:</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span><span class="op">,</span>                    <span class="co">// From auth middleware</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">page</span><span class="op">:</span> <span class="pp">parseInt</span>(page)<span class="op">,</span>                   <span class="co">// Convert string to number</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">limit</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(<span class="pp">parseInt</span>(limit)<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span>  <span class="co">// Cap at 100 to prevent abuse</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">filters</span><span class="op">:</span> { status<span class="op">,</span> priority }<span class="op">,</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>      sort<span class="op">,</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>      order</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return data with pagination metadata</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">data</span><span class="op">:</span> result<span class="op">.</span><span class="at">tasks</span><span class="op">,</span></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">pagination</span><span class="op">:</span> {</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">page</span><span class="op">:</span> result<span class="op">.</span><span class="at">page</span><span class="op">,</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">limit</span><span class="op">:</span> result<span class="op">.</span><span class="at">limit</span><span class="op">,</span></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">total</span><span class="op">:</span> result<span class="op">.</span><span class="at">total</span><span class="op">,</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">totalPages</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">ceil</span>(result<span class="op">.</span><span class="at">total</span> <span class="op">/</span> result<span class="op">.</span><span class="at">limit</span>)</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>(error)<span class="op">;</span>  <span class="co">// Pass to error handling middleware</span></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Several design decisions here merit explanation. The <code>authenticate</code> middleware runs before our handler, populating <code>req.user</code> with the authenticated user’s information. Query parameters are strings, so we parse them to numbers. We cap <code>limit</code> at 100 to prevent clients from requesting enormous result sets. The response includes pagination metadata so clients know how to fetch more results.</p>
<p>The single-item endpoint retrieves one task:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">// GET /api/tasks/:id - Get single task</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">get</span>(<span class="st">'/:id'</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Service checks ownership internally</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> taskService<span class="op">.</span><span class="fu">getById</span>(req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span><span class="op">,</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>task) {</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">code</span><span class="op">:</span> <span class="st">'TASK_NOT_FOUND'</span><span class="op">,</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">message</span><span class="op">:</span> <span class="st">'Task not found'</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">data</span><span class="op">:</span> task })<span class="op">;</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>(error)<span class="op">;</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice the error response structure—we include both a machine-readable code (<code>TASK_NOT_FOUND</code>) and a human-readable message. This allows clients to handle specific errors programmatically while still displaying meaningful messages to users.</p>
<p>Creating a task validates input and returns the created resource:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">// POST /api/tasks - Create task</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">post</span>(<span class="st">'/'</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="fu">validate</span>(taskSchema<span class="op">.</span><span class="at">create</span>)<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validation already passed (middleware would have returned 422)</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add authenticated user as owner</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> taskService<span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>req<span class="op">.</span><span class="at">body</span><span class="op">,</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">userId</span><span class="op">:</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 201 Created with the new resource</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">201</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">data</span><span class="op">:</span> task })<span class="op">;</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>(error)<span class="op">;</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>validate(taskSchema.create)</code> middleware runs before our handler, ensuring <code>req.body</code> contains valid data. If validation fails, the middleware returns a 422 response and our handler never runs. This keeps validation logic centralized and reusable.</p>
<p>The update endpoint demonstrates PATCH semantics—partial updates:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">// PATCH /api/tasks/:id - Partial update</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">patch</span>(<span class="st">'/:id'</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="fu">validate</span>(taskSchema<span class="op">.</span><span class="at">patch</span>)<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Service updates only provided fields</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> taskService<span class="op">.</span><span class="fu">update</span>(req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span><span class="op">,</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span><span class="op">,</span> req<span class="op">.</span><span class="at">body</span>)<span class="op">;</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>task) {</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">code</span><span class="op">:</span> <span class="st">'TASK_NOT_FOUND'</span><span class="op">,</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">message</span><span class="op">:</span> <span class="st">'Task not found'</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">data</span><span class="op">:</span> task })<span class="op">;</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>(error)<span class="op">;</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With PATCH, clients send only the fields they want to change. If you want to update just the status, send <code>{ "status": "done" }</code>—other fields remain unchanged. This differs from PUT, where you’d send the entire resource and unspecified fields would be cleared.</p>
<p>Finally, deletion:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">// DELETE /api/tasks/:id - Delete task</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">delete</span>(<span class="st">'/:id'</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> deleted <span class="op">=</span> <span class="cf">await</span> taskService<span class="op">.</span><span class="fu">delete</span>(req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span><span class="op">,</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>deleted) {</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">code</span><span class="op">:</span> <span class="st">'TASK_NOT_FOUND'</span><span class="op">,</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">message</span><span class="op">:</span> <span class="st">'Task not found'</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 204 No Content - success but nothing to return</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">204</span>)<span class="op">.</span><span class="fu">send</span>()<span class="op">;</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>(error)<span class="op">;</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>DELETE returns 204 No Content on success—there’s no body to return since the resource no longer exists.</p>
<p>Now let’s look at the service layer that contains business logic:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/taskService.js</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> db <span class="op">=</span> <span class="pp">require</span>(<span class="st">'../db'</span>)<span class="op">;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TaskService {</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">list</span>({ userId<span class="op">,</span> page<span class="op">,</span> limit<span class="op">,</span> filters<span class="op">,</span> sort<span class="op">,</span> order }) {</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start building query</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> query <span class="op">=</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(<span class="st">'user_id'</span><span class="op">,</span> userId)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">orderBy</span>(sort<span class="op">,</span> order)<span class="op">;</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply filters conditionally</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (filters<span class="op">.</span><span class="at">status</span>) {</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>      query<span class="op">.</span><span class="fu">where</span>(<span class="st">'status'</span><span class="op">,</span> filters<span class="op">.</span><span class="at">status</span>)<span class="op">;</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (filters<span class="op">.</span><span class="at">priority</span>) {</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>      query<span class="op">.</span><span class="fu">where</span>(<span class="st">'priority'</span><span class="op">,</span> filters<span class="op">.</span><span class="at">priority</span>)<span class="op">;</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get total count for pagination (before limit/offset)</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> countQuery <span class="op">=</span> query<span class="op">.</span><span class="fu">clone</span>()<span class="op">;</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> [{ count }] <span class="op">=</span> <span class="cf">await</span> countQuery<span class="op">.</span><span class="fu">count</span>(<span class="st">'* as count'</span>)<span class="op">;</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply pagination</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tasks <span class="op">=</span> <span class="cf">await</span> query</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">limit</span>(limit)</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">offset</span>((page <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> limit)<span class="op">;</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>      tasks<span class="op">,</span></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>      page<span class="op">,</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>      limit<span class="op">,</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">total</span><span class="op">:</span> <span class="pp">parseInt</span>(count)</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The list method demonstrates several important patterns. We build the query incrementally, adding filters only if provided. We clone the query before counting because limit/offset would affect the count. The offset calculation <code>(page - 1) * limit</code> converts page numbers (1-indexed) to database offsets (0-indexed).</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getById</span>(id<span class="op">,</span> userId) {</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Combine id check and ownership check in one query</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>({ id<span class="op">,</span> <span class="dt">user_id</span><span class="op">:</span> userId })</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The getById method includes <code>user_id</code> in the query. This ensures users can only access their own tasks—a form of authorization baked into the query itself.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">create</span>(data) {</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Insert and return the created row</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> [task] <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">insert</span>({</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">title</span><span class="op">:</span> data<span class="op">.</span><span class="at">title</span><span class="op">,</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">description</span><span class="op">:</span> data<span class="op">.</span><span class="at">description</span><span class="op">,</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">user_id</span><span class="op">:</span> data<span class="op">.</span><span class="at">userId</span><span class="op">,</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">project_id</span><span class="op">:</span> data<span class="op">.</span><span class="at">projectId</span><span class="op">,</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">status</span><span class="op">:</span> data<span class="op">.</span><span class="at">status</span> <span class="op">||</span> <span class="st">'todo'</span><span class="op">,</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">priority</span><span class="op">:</span> data<span class="op">.</span><span class="at">priority</span> <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">due_date</span><span class="op">:</span> data<span class="op">.</span><span class="at">dueDate</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">returning</span>(<span class="st">'*'</span>)<span class="op">;</span>  <span class="co">// PostgreSQL returns the inserted row</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> task<span class="op">;</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The create method maps from API field names (camelCase) to database column names (snake_case). The <code>.returning('*')</code> clause tells PostgreSQL to return the inserted row, including the generated ID and timestamps.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">update</span>(id<span class="op">,</span> userId<span class="op">,</span> data) {</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only update provided fields</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> [task] <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>({ id<span class="op">,</span> <span class="dt">user_id</span><span class="op">:</span> userId })</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">update</span>({</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span>data<span class="op">,</span>                      <span class="co">// Spread provided fields</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">updated_at</span><span class="op">:</span> db<span class="op">.</span><span class="at">fn</span><span class="op">.</span><span class="fu">now</span>()       <span class="co">// Always update timestamp</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">returning</span>(<span class="st">'*'</span>)<span class="op">;</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> task<span class="op">;</span>  <span class="co">// undefined if no row matched</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="kw">delete</span>(id<span class="op">,</span> userId) {</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> deleted <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>({ id<span class="op">,</span> <span class="dt">user_id</span><span class="op">:</span> userId })</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">del</span>()<span class="op">;</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> deleted <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// True if a row was deleted</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">TaskService</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The service layer handles data access and business logic, keeping route handlers thin. This separation makes the code more testable—you can test service methods directly without HTTP, and test routes with a mocked service.</p>
</section>
<section id="response-structure" class="level3" data-number="12.5.6">
<h3 data-number="12.5.6" class="anchored" data-anchor-id="response-structure"><span class="header-section-number">12.5.6</span> 10.4.6 Response Structure</h3>
<p>Consistent response formats make your API predictable and easier to consume. Here’s a structure that works well:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Success - single resource</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data"</span><span class="op">:</span> {</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"title"</span><span class="op">:</span> <span class="st">"Complete project"</span><span class="op">,</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"status"</span><span class="op">:</span> <span class="st">"in_progress"</span><span class="op">,</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"created_at"</span><span class="op">:</span> <span class="st">"2024-12-09T10:30:00Z"</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Success - collection with pagination</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data"</span><span class="op">:</span> [</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    { <span class="st">"id"</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span> <span class="st">"title"</span><span class="op">:</span> <span class="st">"Task 1"</span> }<span class="op">,</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    { <span class="st">"id"</span><span class="op">:</span> <span class="dv">124</span><span class="op">,</span> <span class="st">"title"</span><span class="op">:</span> <span class="st">"Task 2"</span> }</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pagination"</span><span class="op">:</span> {</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"page"</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"limit"</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total"</span><span class="op">:</span> <span class="dv">45</span><span class="op">,</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"totalPages"</span><span class="op">:</span> <span class="dv">3</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Error</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"error"</span><span class="op">:</span> {</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"code"</span><span class="op">:</span> <span class="st">"VALIDATION_ERROR"</span><span class="op">,</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"message"</span><span class="op">:</span> <span class="st">"Invalid request data"</span><span class="op">,</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"details"</span><span class="op">:</span> [</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>      { <span class="st">"field"</span><span class="op">:</span> <span class="st">"title"</span><span class="op">,</span> <span class="st">"message"</span><span class="op">:</span> <span class="st">"Title is required"</span> }<span class="op">,</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>      { <span class="st">"field"</span><span class="op">:</span> <span class="st">"priority"</span><span class="op">,</span> <span class="st">"message"</span><span class="op">:</span> <span class="st">"Priority must be between 0 and 4"</span> }</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The consistent <code>data</code> wrapper makes responses predictable—clients always look in the same place for the result. The <code>error</code> structure provides both machine-readable codes for programmatic handling and human-readable messages for display. The optional <code>details</code> array allows field-level error reporting for forms.</p>
<hr>
</section>
</section>
<section id="graphql" class="level2" data-number="12.6">
<h2 data-number="12.6" class="anchored" data-anchor-id="graphql"><span class="header-section-number">12.6</span> 10.5 GraphQL</h2>
<p>While REST has served us well, it has limitations. Mobile apps with limited bandwidth want minimal data. Complex UIs need data from multiple resources. Different clients have different data needs. <strong>GraphQL</strong> addresses these challenges by letting clients specify exactly what data they need.</p>
<section id="the-problem-graphql-solves" class="level3" data-number="12.6.1">
<h3 data-number="12.6.1" class="anchored" data-anchor-id="the-problem-graphql-solves"><span class="header-section-number">12.6.1</span> 10.5.1 The Problem GraphQL Solves</h3>
<p>Consider a mobile app displaying a task list. With REST, you might face these issues:</p>
<p><strong>Over-fetching</strong>: The <code>/tasks</code> endpoint returns all task fields, but the list view only needs <code>id</code>, <code>title</code>, and <code>status</code>. You’re transferring unnecessary data.</p>
<p><strong>Under-fetching</strong>: The list also shows the assignee’s name, but that requires a separate request to <code>/users/{id}</code> for each task—the dreaded N+1 problem.</p>
<p><strong>Multiple round trips</strong>: To show a dashboard with user info, their tasks, and project summaries, you need three separate requests.</p>
<p>GraphQL solves these with a single query that specifies exactly what’s needed:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">query</span> Dashboard {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  me {</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    name</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    avatar</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  myTasks(limit: <span class="dv">5</span>) {</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    title</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    status</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    assignee {</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>      name</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  myProjects {</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    name</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    taskCount</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>One request, exactly the needed data, no wasted bandwidth.</p>
</section>
<section id="graphql-schema" class="level3" data-number="12.6.2">
<h3 data-number="12.6.2" class="anchored" data-anchor-id="graphql-schema"><span class="header-section-number">12.6.2</span> 10.5.2 GraphQL Schema</h3>
<p>A GraphQL API is defined by its <strong>schema</strong>—a type system describing what data is available and how it can be queried. Let’s build a schema for our task management application:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># schema.graphql</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Enums define a fixed set of values</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> TaskStatus {</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  TODO</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  IN_PROGRESS</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  REVIEW</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  DONE</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> TaskPriority {</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  LOW</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>  MEDIUM</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  HIGH</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  URGENT</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Enums provide type safety—the API rejects invalid status values rather than accepting arbitrary strings.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Object types define the shape of resources</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> User {</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  id: <span class="dt">ID</span>!                                          <span class="co"># ! means non-nullable</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  email: <span class="dt">String</span>!</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  name: <span class="dt">String</span>!</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  avatar: <span class="dt">String</span>                                   <span class="co"># No ! means nullable</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  tasks(status: TaskStatus, limit: <span class="dt">Int</span>): [Task!]!  <span class="co"># Returns list of Tasks</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  projects: [Project!]!</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  createdAt: DateTime!</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The User type shows several GraphQL features. <code>ID!</code> is a non-nullable unique identifier. <code>String</code> (without <code>!</code>) is a nullable string—avatar might be null. <code>[Task!]!</code> means a non-nullable list of non-nullable tasks—the list is always present (might be empty), and every element is a valid Task.</p>
<p>The <code>tasks</code> field has arguments—clients can filter by status or limit results. This flexibility is part of what makes GraphQL powerful.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Task {</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  id: <span class="dt">ID</span>!</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  title: <span class="dt">String</span>!</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  description: <span class="dt">String</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  status: TaskStatus!</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  priority: TaskPriority!</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  assignee: User!                  <span class="co"># Relationship to User</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  project: Project                 <span class="co"># Optional relationship</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  comments: [Comment!]!</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  dueDate: DateTime</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  createdAt: DateTime!</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  updatedAt: DateTime!</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Project {</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  id: <span class="dt">ID</span>!</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>  name: <span class="dt">String</span>!</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>  description: <span class="dt">String</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>  owner: User!</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>  members: [User!]!</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>  tasks(status: TaskStatus): [Task!]!</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>  taskCount: <span class="dt">Int</span>!                  <span class="co"># Computed field</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>  completedTaskCount: <span class="dt">Int</span>!</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>  createdAt: DateTime!</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice how types reference each other—Task has an <code>assignee</code> (User) and <code>project</code> (Project), while Project has <code>tasks</code> (list of Task). These relationships form a graph that clients can traverse in queries.</p>
<p><strong>Input types</strong> define the shape of mutation arguments:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">input</span> CreateTaskInput {</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  title: <span class="dt">String</span>!</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  description: <span class="dt">String</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  projectId: <span class="dt">ID</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  priority: TaskPriority = MEDIUM    <span class="co"># Default value</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  dueDate: DateTime</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="kw">input</span> UpdateTaskInput {</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>  title: <span class="dt">String</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  description: <span class="dt">String</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>  status: TaskStatus</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>  priority: TaskPriority</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>  dueDate: DateTime</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Input types are similar to object types but used for arguments. They can have default values—if <code>priority</code> isn’t provided, it defaults to MEDIUM.</p>
<p><strong>The Query type</strong> defines read operations:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Query {</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Current authenticated user</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  me: User!</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Look up specific resources</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  user(id: <span class="dt">ID</span>!): User</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  task(id: <span class="dt">ID</span>!): Task</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  project(id: <span class="dt">ID</span>!): Project</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List resources with filtering</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  tasks(</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    status: TaskStatus</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    priority: TaskPriority</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    projectId: <span class="dt">ID</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    limit: <span class="dt">Int</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>    offset: <span class="dt">Int</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  ): [Task!]!</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each field in Query is an entry point for reads. Arguments enable filtering and pagination. The return types specify what clients receive.</p>
<p><strong>The Mutation type</strong> defines write operations:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Mutation {</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  createTask(<span class="kw">input</span>: CreateTaskInput!): Task!</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  updateTask(id: <span class="dt">ID</span>!, <span class="kw">input</span>: UpdateTaskInput!): Task!</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  deleteTask(id: <span class="dt">ID</span>!): <span class="dt">Boolean</span>!</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  addComment(taskId: <span class="dt">ID</span>!, text: <span class="dt">String</span>!): Comment!</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Mutations modify data and return the affected resource. This lets clients update their cache without additional requests.</p>
</section>
<section id="writing-graphql-queries" class="level3" data-number="12.6.3">
<h3 data-number="12.6.3" class="anchored" data-anchor-id="writing-graphql-queries"><span class="header-section-number">12.6.3</span> 10.5.3 Writing GraphQL Queries</h3>
<p>GraphQL queries declare exactly what data to fetch. Let’s explore increasingly complex examples:</p>
<p><strong>Simple query</strong>:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">query</span> GetMe {</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  me {</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    name</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    email</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This fetches only three fields from the current user. The response mirrors the query structure:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"data"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"me"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"id"</span><span class="fu">:</span> <span class="st">"123"</span><span class="fu">,</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Alice"</span><span class="fu">,</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"email"</span><span class="fu">:</span> <span class="st">"alice@example.com"</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Query with arguments</strong>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">query</span> GetTask(<span class="va">$taskId</span>: <span class="dt">ID</span>!) {</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  task(id: <span class="va">$taskId</span>) {</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    title</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    status</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    dueDate</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Variables (prefixed with <code>$</code>) are passed separately, enabling query reuse and preventing injection attacks. The client sends:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"query"</span><span class="fu">:</span> <span class="st">"..."</span><span class="fu">,</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"variables"</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">"taskId"</span><span class="fu">:</span> <span class="st">"789"</span> <span class="fu">}</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Nested query traversing relationships</strong>:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">query</span> GetUserWithTasks(<span class="va">$userId</span>: <span class="dt">ID</span>!) {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  user(id: <span class="va">$userId</span>) {</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    name</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    tasks(status: IN_PROGRESS, limit: <span class="dv">10</span>) {</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>      id</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>      title</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>      priority</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>      project {</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>        id</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>        name</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This single query fetches a user, their in-progress tasks (limited to 10), and each task’s project. With REST, this would require multiple requests. The nested structure shows GraphQL’s power—clients traverse the data graph as needed.</p>
<p><strong>Complex dashboard query</strong>:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">query</span> Dashboard {</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  me {</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    name</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    tasks(limit: <span class="dv">5</span>) {</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>      id</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>      title</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>      status</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>      dueDate</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  projects {</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    name</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    taskCount</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    completedTaskCount</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>  urgentTasks: tasks(priority: URGENT, status: TODO) {</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>    title</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>    dueDate</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>    project {</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>      name</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>One query fetches everything a dashboard needs: user info, recent tasks, project summaries, and urgent items. The <code>urgentTasks:</code> prefix is an alias—it renames the field in the response, allowing multiple calls to <code>tasks</code> with different filters.</p>
<p><strong>Fragments for reusable field selections</strong>:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fragment</span> TaskFields <span class="kw">on</span> Task {</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  id</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  title</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  status</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  priority</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  dueDate</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="kw">query</span> GetProjectTasks(<span class="va">$projectId</span>: <span class="dt">ID</span>!) {</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  project(id: <span class="va">$projectId</span>) {</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    name</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    tasks {</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>      ...TaskFields</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>      assignee {</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>        name</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Fragments define reusable field sets. <code>...TaskFields</code> spreads those fields into the selection. This reduces repetition and ensures consistency across queries.</p>
</section>
<section id="graphql-mutations" class="level3" data-number="12.6.4">
<h3 data-number="12.6.4" class="anchored" data-anchor-id="graphql-mutations"><span class="header-section-number">12.6.4</span> 10.5.4 GraphQL Mutations</h3>
<p>Mutations modify data. They look similar to queries but conventionally cause side effects:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">mutation</span> CreateTask(<span class="va">$input</span>: CreateTaskInput!) {</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  createTask(<span class="kw">input</span>: <span class="va">$input</span>) {</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    title</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    status</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    createdAt</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Variables:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"input"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"title"</span><span class="fu">:</span> <span class="st">"Review documentation"</span><span class="fu">,</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"projectId"</span><span class="fu">:</span> <span class="st">"123"</span><span class="fu">,</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"priority"</span><span class="fu">:</span> <span class="st">"HIGH"</span><span class="fu">,</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"dueDate"</span><span class="fu">:</span> <span class="st">"2024-12-15"</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The mutation returns the created task, including server-generated fields like <code>id</code> and <code>createdAt</code>. Clients can use this to update their local cache without a separate fetch.</p>
<p><strong>Multiple mutations in one request</strong>:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">mutation</span> BatchUpdate {</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  task1: updateTask(id: <span class="st">"1"</span>, <span class="kw">input</span>: { status: DONE }) {</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    status</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>  task2: updateTask(id: <span class="st">"2"</span>, <span class="kw">input</span>: { status: IN_PROGRESS }) {</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    id</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    status</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Mutations execute sequentially (unlike queries, which can parallelize). Aliases (<code>task1:</code>, <code>task2:</code>) distinguish multiple calls to the same mutation.</p>
</section>
<section id="implementing-graphql-resolvers" class="level3" data-number="12.6.5">
<h3 data-number="12.6.5" class="anchored" data-anchor-id="implementing-graphql-resolvers"><span class="header-section-number">12.6.5</span> 10.5.5 Implementing GraphQL Resolvers</h3>
<p>Resolvers are functions that fetch data for each field in your schema. Let’s implement resolvers for our task management API:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">// resolvers.js</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> db <span class="op">=</span> <span class="pp">require</span>(<span class="st">'./db'</span>)<span class="op">;</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> resolvers <span class="op">=</span> {</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Root Query resolvers</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Query</span><span class="op">:</span> {</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">me</span><span class="op">:</span> <span class="kw">async</span> (_<span class="op">,</span> __<span class="op">,</span> { user }) <span class="kw">=&gt;</span> {</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// The third argument is context, containing authenticated user</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>user) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Not authenticated'</span>)<span class="op">;</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">db</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> user<span class="op">.</span><span class="at">id</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">task</span><span class="op">:</span> <span class="kw">async</span> (_<span class="op">,</span> { id }<span class="op">,</span> { user }) <span class="kw">=&gt;</span> {</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>user) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Not authenticated'</span>)<span class="op">;</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)<span class="op">.</span><span class="fu">where</span>({ id<span class="op">,</span> <span class="dt">user_id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span> })<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tasks</span><span class="op">:</span> <span class="kw">async</span> (_<span class="op">,</span> { status<span class="op">,</span> priority<span class="op">,</span> projectId<span class="op">,</span> limit <span class="op">=</span> <span class="dv">20</span><span class="op">,</span> offset <span class="op">=</span> <span class="dv">0</span> }<span class="op">,</span> { user }) <span class="kw">=&gt;</span> {</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>user) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Not authenticated'</span>)<span class="op">;</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Build query with conditional filters</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> query <span class="op">=</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'user_id'</span><span class="op">,</span> user<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (status) query<span class="op">.</span><span class="fu">where</span>(<span class="st">'status'</span><span class="op">,</span> status<span class="op">.</span><span class="fu">toLowerCase</span>())<span class="op">;</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (priority) query<span class="op">.</span><span class="fu">where</span>(<span class="st">'priority'</span><span class="op">,</span> <span class="fu">priorityToNumber</span>(priority))<span class="op">;</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (projectId) query<span class="op">.</span><span class="fu">where</span>(<span class="st">'project_id'</span><span class="op">,</span> projectId)<span class="op">;</span></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> query</span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">limit</span>(limit)</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">offset</span>(offset)</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">orderBy</span>(<span class="st">'created_at'</span><span class="op">,</span> <span class="st">'desc'</span>)<span class="op">;</span></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each resolver receives four arguments:</p>
<ol type="1">
<li><code>parent</code> - The result of the parent resolver (for nested fields)</li>
<li><code>args</code> - Arguments passed to the field</li>
<li><code>context</code> - Shared data like the authenticated user</li>
<li><code>info</code> - Query metadata (rarely used)</li>
</ol>
<p>Root Query resolvers have <code>undefined</code> as parent since they’re entry points.</p>
<p><strong>Mutation resolvers</strong> modify data:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>  Mutation<span class="op">:</span> {</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">createTask</span><span class="op">:</span> <span class="kw">async</span> (_<span class="op">,</span> { input }<span class="op">,</span> { user }) <span class="kw">=&gt;</span> {</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>user) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Not authenticated'</span>)<span class="op">;</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> [task] <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">insert</span>({</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">title</span><span class="op">:</span> input<span class="op">.</span><span class="at">title</span><span class="op">,</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">description</span><span class="op">:</span> input<span class="op">.</span><span class="at">description</span><span class="op">,</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">user_id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">project_id</span><span class="op">:</span> input<span class="op">.</span><span class="at">projectId</span><span class="op">,</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">priority</span><span class="op">:</span> <span class="fu">priorityToNumber</span>(input<span class="op">.</span><span class="at">priority</span>)<span class="op">,</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">due_date</span><span class="op">:</span> input<span class="op">.</span><span class="at">dueDate</span><span class="op">,</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">status</span><span class="op">:</span> <span class="st">'todo'</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">returning</span>(<span class="st">'*'</span>)<span class="op">;</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> task<span class="op">;</span></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">updateTask</span><span class="op">:</span> <span class="kw">async</span> (_<span class="op">,</span> { id<span class="op">,</span> input }<span class="op">,</span> { user }) <span class="kw">=&gt;</span> {</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>user) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Not authenticated'</span>)<span class="op">;</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Build update object from provided fields</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> updates <span class="op">=</span> { <span class="dt">updated_at</span><span class="op">:</span> db<span class="op">.</span><span class="at">fn</span><span class="op">.</span><span class="fu">now</span>() }<span class="op">;</span></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (input<span class="op">.</span><span class="at">title</span>) updates<span class="op">.</span><span class="at">title</span> <span class="op">=</span> input<span class="op">.</span><span class="at">title</span><span class="op">;</span></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (input<span class="op">.</span><span class="at">description</span> <span class="op">!==</span> <span class="kw">undefined</span>) updates<span class="op">.</span><span class="at">description</span> <span class="op">=</span> input<span class="op">.</span><span class="at">description</span><span class="op">;</span></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (input<span class="op">.</span><span class="at">status</span>) updates<span class="op">.</span><span class="at">status</span> <span class="op">=</span> input<span class="op">.</span><span class="at">status</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">;</span></span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (input<span class="op">.</span><span class="at">priority</span>) updates<span class="op">.</span><span class="at">priority</span> <span class="op">=</span> <span class="fu">priorityToNumber</span>(input<span class="op">.</span><span class="at">priority</span>)<span class="op">;</span></span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (input<span class="op">.</span><span class="at">dueDate</span>) updates<span class="op">.</span><span class="at">due_date</span> <span class="op">=</span> input<span class="op">.</span><span class="at">dueDate</span><span class="op">;</span></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> [task] <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">where</span>({ id<span class="op">,</span> <span class="dt">user_id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span> })</span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">update</span>(updates)</span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">returning</span>(<span class="st">'*'</span>)<span class="op">;</span></span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> task<span class="op">;</span></span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Field resolvers</strong> handle nested data and computed fields:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Resolvers for Task type fields</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  Task<span class="op">:</span> {</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resolve the assignee relationship</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">assignee</span><span class="op">:</span> (task) <span class="kw">=&gt;</span> {</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">db</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> task<span class="op">.</span><span class="at">user_id</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resolve the optional project relationship</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">project</span><span class="op">:</span> (task) <span class="kw">=&gt;</span> {</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>task<span class="op">.</span><span class="at">project_id</span>) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">db</span>(<span class="st">'projects'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> task<span class="op">.</span><span class="at">project_id</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resolve comments list</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">comments</span><span class="op">:</span> (task) <span class="kw">=&gt;</span> {</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">db</span>(<span class="st">'comments'</span>)</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">where</span>(<span class="st">'task_id'</span><span class="op">,</span> task<span class="op">.</span><span class="at">id</span>)</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">orderBy</span>(<span class="st">'created_at'</span><span class="op">,</span> <span class="st">'asc'</span>)<span class="op">;</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Transform database values to GraphQL enum format</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">status</span><span class="op">:</span> (task) <span class="kw">=&gt;</span> task<span class="op">.</span><span class="at">status</span><span class="op">.</span><span class="fu">toUpperCase</span>()<span class="op">,</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">priority</span><span class="op">:</span> (task) <span class="kw">=&gt;</span> <span class="fu">numberToPriority</span>(task<span class="op">.</span><span class="at">priority</span>)<span class="op">,</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Resolvers for Project type fields</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>  Project<span class="op">:</span> {</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">owner</span><span class="op">:</span> (project) <span class="kw">=&gt;</span> {</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">db</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> project<span class="op">.</span><span class="at">owner_id</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tasks</span><span class="op">:</span> (project<span class="op">,</span> { status }) <span class="kw">=&gt;</span> {</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> query <span class="op">=</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'project_id'</span><span class="op">,</span> project<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (status) query<span class="op">.</span><span class="fu">where</span>(<span class="st">'status'</span><span class="op">,</span> status<span class="op">.</span><span class="fu">toLowerCase</span>())<span class="op">;</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> query<span class="op">;</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Computed field - count tasks</span></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">taskCount</span><span class="op">:</span> <span class="kw">async</span> (project) <span class="kw">=&gt;</span> {</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> [{ count }] <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">where</span>(<span class="st">'project_id'</span><span class="op">,</span> project<span class="op">.</span><span class="at">id</span>)</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">count</span>(<span class="st">'* as count'</span>)<span class="op">;</span></span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="pp">parseInt</span>(count)<span class="op">;</span></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Field resolvers receive the parent object as their first argument. The <code>assignee</code> resolver receives the task, extracts <code>user_id</code>, and fetches the corresponding user. GraphQL calls these resolvers automatically when clients request those fields.</p>
</section>
<section id="the-n1-problem-and-dataloader" class="level3" data-number="12.6.6">
<h3 data-number="12.6.6" class="anchored" data-anchor-id="the-n1-problem-and-dataloader"><span class="header-section-number">12.6.6</span> 10.5.6 The N+1 Problem and DataLoader</h3>
<p>There’s a performance trap in the resolvers above. Consider this query:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode graphql code-with-copy"><code class="sourceCode graphql"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">query</span> {</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  tasks(limit: <span class="dv">100</span>) {</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    title</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    assignee {</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>      name</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>tasks</code> query executes once, returning 100 tasks. Then the <code>assignee</code> resolver runs 100 times—once per task—each making a database query. That’s 101 queries for what should be 2!</p>
<p><strong>DataLoader</strong> solves this by batching and caching:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DataLoader <span class="op">=</span> <span class="pp">require</span>(<span class="st">'dataloader'</span>)<span class="op">;</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Batch function receives array of keys, returns array of results in same order</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> createUserLoader <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="kw">new</span> <span class="fu">DataLoader</span>(<span class="kw">async</span> (userIds) <span class="kw">=&gt;</span> {</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// One query for all requested users</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">whereIn</span>(<span class="st">'id'</span><span class="op">,</span> userIds)<span class="op">;</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Return in same order as requested IDs</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> userMap <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(users<span class="op">.</span><span class="fu">map</span>(u <span class="kw">=&gt;</span> [u<span class="op">.</span><span class="at">id</span><span class="op">,</span> u]))<span class="op">;</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> userIds<span class="op">.</span><span class="fu">map</span>(id <span class="kw">=&gt;</span> userMap<span class="op">.</span><span class="fu">get</span>(id))<span class="op">;</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>DataLoader collects all <code>load()</code> calls within a single tick of the event loop, batches them into one request, and distributes results back. Same-ID requests within a request are cached.</p>
<p>Use DataLoader in resolvers:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create fresh loaders per request (in context)</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> context <span class="op">=</span> ({ req }) <span class="kw">=&gt;</span> ({</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">user</span><span class="op">:</span> <span class="fu">authenticate</span>(req)<span class="op">,</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">loaders</span><span class="op">:</span> {</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">user</span><span class="op">:</span> <span class="fu">createUserLoader</span>()<span class="op">,</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">project</span><span class="op">:</span> <span class="fu">createProjectLoader</span>()<span class="op">,</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Use loader in resolver</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> resolvers <span class="op">=</span> {</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Task</span><span class="op">:</span> {</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">assignee</span><span class="op">:</span> (task<span class="op">,</span> _<span class="op">,</span> { loaders }) <span class="kw">=&gt;</span> {</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> loaders<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="fu">load</span>(task<span class="op">.</span><span class="at">user_id</span>)<span class="op">;</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">project</span><span class="op">:</span> (task<span class="op">,</span> _<span class="op">,</span> { loaders }) <span class="kw">=&gt;</span> {</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>task<span class="op">.</span><span class="at">project_id</span>) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> loaders<span class="op">.</span><span class="at">project</span><span class="op">.</span><span class="fu">load</span>(task<span class="op">.</span><span class="at">project_id</span>)<span class="op">;</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now the 100-task query makes just 2 database queries: one for tasks, one for all referenced users. DataLoader is essential for performant GraphQL APIs.</p>
<hr>
</section>
</section>
<section id="api-documentation" class="level2" data-number="12.7">
<h2 data-number="12.7" class="anchored" data-anchor-id="api-documentation"><span class="header-section-number">12.7</span> 10.6 API Documentation</h2>
<p>An API without documentation is like a library without a catalog—technically usable but practically frustrating. Good documentation transforms your API from “technically correct” to “delightful to use.”</p>
<section id="openapi-specification" class="level3" data-number="12.7.1">
<h3 data-number="12.7.1" class="anchored" data-anchor-id="openapi-specification"><span class="header-section-number">12.7.1</span> 10.6.1 OpenAPI Specification</h3>
<p><strong>OpenAPI</strong> (formerly Swagger) is the industry standard for REST API documentation. It’s a machine-readable format that enables automatic documentation generation, client SDK generation, and validation.</p>
<p>Here’s an excerpt from an OpenAPI specification for our tasks API:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">openapi</span><span class="kw">:</span><span class="at"> </span><span class="fl">3.0.3</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">info</span><span class="kw">:</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> TaskFlow API</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="fu">  description</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    API for the TaskFlow task management application.</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    ## Authentication</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    All endpoints except `/auth/login` and `/auth/register` require </span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    authentication. Include the JWT token in the Authorization header:</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    ```</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    Authorization: Bearer &lt;token&gt;</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    ```</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="fl">1.0.0</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a><span class="fu">servers</span><span class="kw">:</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">url</span><span class="kw">:</span><span class="at"> https://api.taskflow.com/v1</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Production</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">url</span><span class="kw">:</span><span class="at"> http://localhost:3000/v1</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Local development</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The info section provides context. The description supports Markdown, enabling rich documentation with code examples. Multiple servers help developers test against different environments.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">/tasks</span><span class="kw">:</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">get</span><span class="kw">:</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> List tasks</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="fu">      description</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>        Returns a paginated list of tasks for the authenticated user.</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        Results can be filtered by status, priority, and project.</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">tags</span><span class="kw">:</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> Tasks</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">security</span><span class="kw">:</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">bearerAuth</span><span class="kw">:</span><span class="at"> </span><span class="kw">[]</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">parameters</span><span class="kw">:</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> status</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">in</span><span class="kw">:</span><span class="at"> query</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Filter by task status</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">schema</span><span class="kw">:</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">enum</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">todo</span><span class="kw">,</span><span class="at"> in_progress</span><span class="kw">,</span><span class="at"> review</span><span class="kw">,</span><span class="at"> done</span><span class="kw">]</span></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> page</span></span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">in</span><span class="kw">:</span><span class="at"> query</span></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Page number (1-indexed)</span></span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">schema</span><span class="kw">:</span></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">type</span><span class="kw">:</span><span class="at"> integer</span></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">default</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">minimum</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> limit</span></span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">in</span><span class="kw">:</span><span class="at"> query</span></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Results per page (max 100)</span></span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">schema</span><span class="kw">:</span></span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">type</span><span class="kw">:</span><span class="at"> integer</span></span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">default</span><span class="kw">:</span><span class="at"> </span><span class="dv">20</span></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">minimum</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">maximum</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each path documents available operations. Parameters specify where each value comes from (<code>query</code>, <code>path</code>, <code>header</code>, <code>body</code>) and include validation rules (type, enum values, min/max).</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">responses</span><span class="kw">:</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">'200'</span><span class="kw">:</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Paginated list of tasks</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">content</span><span class="kw">:</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">application/json</span><span class="kw">:</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">schema</span><span class="kw">:</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a><span class="at">                    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> array</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a><span class="at">                    </span><span class="fu">items</span><span class="kw">:</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a><span class="at">                      </span><span class="fu">$ref</span><span class="kw">:</span><span class="at"> </span><span class="st">'#/components/schemas/Task'</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">pagination</span><span class="kw">:</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="at">                    </span><span class="fu">$ref</span><span class="kw">:</span><span class="at"> </span><span class="st">'#/components/schemas/Pagination'</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">'401'</span><span class="kw">:</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">$ref</span><span class="kw">:</span><span class="at"> </span><span class="st">'#/components/responses/Unauthorized'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Response documentation shows what clients receive. Schema references (<code>$ref</code>) enable reuse—define a Task schema once, reference it everywhere.</p>
<p><strong>Components</strong> define reusable schemas:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span><span class="kw">:</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schemas</span><span class="kw">:</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Task</span><span class="kw">:</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">required</span><span class="kw">:</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> id</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> title</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> status</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> integer</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">example</span><span class="kw">:</span><span class="at"> </span><span class="dv">123</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">title</span><span class="kw">:</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">example</span><span class="kw">:</span><span class="at"> Review pull request</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">minLength</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">maxLength</span><span class="kw">:</span><span class="at"> </span><span class="dv">200</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">nullable</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">status</span><span class="kw">:</span></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">enum</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">todo</span><span class="kw">,</span><span class="at"> in_progress</span><span class="kw">,</span><span class="at"> review</span><span class="kw">,</span><span class="at"> done</span><span class="kw">]</span></span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">priority</span><span class="kw">:</span></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> integer</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">minimum</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">maximum</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">dueDate</span><span class="kw">:</span></span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">format</span><span class="kw">:</span><span class="at"> date</span></span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">nullable</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>example</code> fields populate documentation with realistic data. Validation rules (<code>minLength</code>, <code>maximum</code>, <code>enum</code>) can drive automatic request validation.</p>
</section>
<section id="serving-documentation" class="level3" data-number="12.7.2">
<h3 data-number="12.7.2" class="anchored" data-anchor-id="serving-documentation"><span class="header-section-number">12.7.2</span> 10.6.2 Serving Documentation</h3>
<p><strong>Swagger UI</strong> renders OpenAPI specifications as interactive documentation:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> swaggerUi <span class="op">=</span> <span class="pp">require</span>(<span class="st">'swagger-ui-express'</span>)<span class="op">;</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> YAML <span class="op">=</span> <span class="pp">require</span>(<span class="st">'yamljs'</span>)<span class="op">;</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> swaggerDocument <span class="op">=</span> YAML<span class="op">.</span><span class="fu">load</span>(<span class="st">'./openapi.yaml'</span>)<span class="op">;</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Serve documentation at /api-docs</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="st">'/api-docs'</span><span class="op">,</span> swaggerUi<span class="op">.</span><span class="at">serve</span><span class="op">,</span> swaggerUi<span class="op">.</span><span class="fu">setup</span>(swaggerDocument<span class="op">,</span> {</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">customCss</span><span class="op">:</span> <span class="st">'.swagger-ui .topbar { display: none }'</span><span class="op">,</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">customSiteTitle</span><span class="op">:</span> <span class="st">'TaskFlow API Documentation'</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Swagger UI provides an interactive interface where developers can read documentation, see examples, and even try API calls directly. This “try it out” feature accelerates integration and debugging.</p>
<hr>
</section>
</section>
<section id="data-validation" class="level2" data-number="12.8">
<h2 data-number="12.8" class="anchored" data-anchor-id="data-validation"><span class="header-section-number">12.8</span> 10.7 Data Validation</h2>
<p>Never trust client input. Every API request might contain malformed data, missing fields, or malicious payloads. Validation ensures only valid data enters your system.</p>
<section id="validation-with-joi" class="level3" data-number="12.8.1">
<h3 data-number="12.8.1" class="anchored" data-anchor-id="validation-with-joi"><span class="header-section-number">12.8.1</span> 10.7.1 Validation with Joi</h3>
<p><strong>Joi</strong> is a popular validation library for JavaScript that provides a fluent API for defining schemas:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Joi <span class="op">=</span> <span class="pp">require</span>(<span class="st">'joi'</span>)<span class="op">;</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> taskSchema <span class="op">=</span> {</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">create</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">object</span>({</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">max</span>(<span class="dv">200</span>)</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">required</span>()</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">messages</span>({</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'string.empty'</span><span class="op">:</span> <span class="st">'Title cannot be empty'</span><span class="op">,</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'string.max'</span><span class="op">:</span> <span class="st">'Title cannot exceed 200 characters'</span><span class="op">,</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'any.required'</span><span class="op">:</span> <span class="st">'Title is required'</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">description</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">max</span>(<span class="dv">2000</span>)</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">allow</span>(<span class="st">''</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">,</span>  <span class="co">// Empty string and null are valid</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">projectId</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">number</span>()</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">integer</span>()</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">positive</span>()</span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">allow</span>(<span class="kw">null</span>)<span class="op">,</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">priority</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">number</span>()</span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">integer</span>()</span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">min</span>(<span class="dv">0</span>)</span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">max</span>(<span class="dv">3</span>)</span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">default</span>(<span class="dv">0</span>)<span class="op">,</span>  <span class="co">// Use 0 if not provided</span></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">dueDate</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">date</span>()</span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">iso</span>()</span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">greater</span>(<span class="st">'now'</span>)  <span class="co">// Must be in the future</span></span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">allow</span>(<span class="kw">null</span>)</span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Update schema - all fields optional but at least one required</span></span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">update</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">object</span>({</span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">max</span>(<span class="dv">200</span>)<span class="op">,</span></span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">description</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">max</span>(<span class="dv">2000</span>)<span class="op">.</span><span class="fu">allow</span>(<span class="st">''</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">,</span></span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">status</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">valid</span>(<span class="st">'todo'</span><span class="op">,</span> <span class="st">'in_progress'</span><span class="op">,</span> <span class="st">'review'</span><span class="op">,</span> <span class="st">'done'</span>)<span class="op">,</span></span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">priority</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">number</span>()<span class="op">.</span><span class="fu">integer</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">max</span>(<span class="dv">3</span>)<span class="op">,</span></span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">dueDate</span><span class="op">:</span> Joi<span class="op">.</span><span class="fu">date</span>()<span class="op">.</span><span class="fu">iso</span>()<span class="op">.</span><span class="fu">allow</span>(<span class="kw">null</span>)</span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">min</span>(<span class="dv">1</span>)  <span class="co">// At least one field must be provided</span></span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each schema rule has a purpose. <code>required()</code> means the field must be present. <code>allow('', null)</code> permits empty values for optional text fields. <code>default(0)</code> provides a fallback. Custom <code>.messages()</code> improve error clarity.</p>
<p><strong>Validation middleware</strong> applies schemas to requests:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> validate <span class="op">=</span> (schema) <span class="kw">=&gt;</span> {</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { error<span class="op">,</span> value } <span class="op">=</span> schema<span class="op">.</span><span class="fu">validate</span>(req<span class="op">.</span><span class="at">body</span><span class="op">,</span> {</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">abortEarly</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span>     <span class="co">// Return all errors, not just first</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stripUnknown</span><span class="op">:</span> <span class="kw">true</span>     <span class="co">// Remove fields not in schema</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error) {</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Transform Joi errors into our API format</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> details <span class="op">=</span> error<span class="op">.</span><span class="at">details</span><span class="op">.</span><span class="fu">map</span>(detail <span class="kw">=&gt;</span> ({</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">field</span><span class="op">:</span> detail<span class="op">.</span><span class="at">path</span><span class="op">.</span><span class="fu">join</span>(<span class="st">'.'</span>)<span class="op">,</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> detail<span class="op">.</span><span class="at">message</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>      }))<span class="op">;</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">422</span>)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>          <span class="dt">code</span><span class="op">:</span> <span class="st">'VALIDATION_ERROR'</span><span class="op">,</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>          <span class="dt">message</span><span class="op">:</span> <span class="st">'Invalid request data'</span><span class="op">,</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>          details</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Replace body with validated/sanitized version</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>    req<span class="op">.</span><span class="at">body</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>stripUnknown: true</code> option is a security feature—it removes any fields not defined in the schema, preventing clients from injecting unexpected data.</p>
</section>
<section id="centralized-error-handling" class="level3" data-number="12.8.2">
<h3 data-number="12.8.2" class="anchored" data-anchor-id="centralized-error-handling"><span class="header-section-number">12.8.2</span> 10.7.2 Centralized Error Handling</h3>
<p>Rather than handling errors in every route, centralize error handling in middleware:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom error classes for different scenarios</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AppError <span class="kw">extends</span> <span class="bu">Error</span> {</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(code<span class="op">,</span> message<span class="op">,</span> statusCode <span class="op">=</span> <span class="dv">500</span><span class="op">,</span> details <span class="op">=</span> <span class="kw">null</span>) {</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(message)<span class="op">;</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">code</span> <span class="op">=</span> code<span class="op">;</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">statusCode</span> <span class="op">=</span> statusCode<span class="op">;</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">details</span> <span class="op">=</span> details<span class="op">;</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">isOperational</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span>  <span class="co">// Distinguishes from programming bugs</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotFoundError <span class="kw">extends</span> AppError {</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(resource <span class="op">=</span> <span class="st">'Resource'</span>) {</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(<span class="st">'NOT_FOUND'</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>resource<span class="sc">}</span><span class="vs"> not found`</span><span class="op">,</span> <span class="dv">404</span>)<span class="op">;</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ValidationError <span class="kw">extends</span> AppError {</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(details) {</span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(<span class="st">'VALIDATION_ERROR'</span><span class="op">,</span> <span class="st">'Invalid request data'</span><span class="op">,</span> <span class="dv">422</span><span class="op">,</span> details)<span class="op">;</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Custom error classes make code clearer and more maintainable. You can throw <code>new NotFoundError('Task')</code> anywhere, and the error handler produces the right response.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Error handling middleware (must have 4 parameters)</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> errorHandler <span class="op">=</span> (err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Log for debugging</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'Error:'</span><span class="op">,</span> {</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">message</span><span class="op">:</span> err<span class="op">.</span><span class="at">message</span><span class="op">,</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">code</span><span class="op">:</span> err<span class="op">.</span><span class="at">code</span><span class="op">,</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">stack</span><span class="op">:</span> err<span class="op">.</span><span class="at">stack</span><span class="op">,</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">path</span><span class="op">:</span> req<span class="op">.</span><span class="at">path</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle our custom errors</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (err <span class="kw">instanceof</span> AppError) {</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(err<span class="op">.</span><span class="at">statusCode</span>)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> err<span class="op">.</span><span class="at">code</span><span class="op">,</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> err<span class="op">.</span><span class="at">message</span><span class="op">,</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span>(err<span class="op">.</span><span class="at">details</span> <span class="op">&amp;&amp;</span> { <span class="dt">details</span><span class="op">:</span> err<span class="op">.</span><span class="at">details</span> })</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle database constraint violations</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (err<span class="op">.</span><span class="at">code</span> <span class="op">===</span> <span class="st">'23505'</span>) {  <span class="co">// PostgreSQL unique violation</span></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">409</span>)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">'CONFLICT'</span><span class="op">,</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">'Resource already exists'</span></span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Unknown errors - don't leak details in production</span></span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">code</span><span class="op">:</span> <span class="st">'INTERNAL_ERROR'</span><span class="op">,</span></span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">'production'</span> </span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">?</span> <span class="st">'An unexpected error occurred'</span> </span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> err<span class="op">.</span><span class="at">message</span></span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Register as last middleware</span></span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(errorHandler)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The error handler transforms various error types into consistent API responses. Database errors get user-friendly messages. Unknown errors hide implementation details in production to prevent information leakage.</p>
<hr>
</section>
</section>
<section id="api-security" class="level2" data-number="12.9">
<h2 data-number="12.9" class="anchored" data-anchor-id="api-security"><span class="header-section-number">12.9</span> 10.8 API Security</h2>
<p>APIs are attack surfaces. Every endpoint is a potential entry point for malicious actors. Security must be designed in, not bolted on.</p>
<section id="authentication-with-jwt" class="level3" data-number="12.9.1">
<h3 data-number="12.9.1" class="anchored" data-anchor-id="authentication-with-jwt"><span class="header-section-number">12.9.1</span> 10.8.1 Authentication with JWT</h3>
<p><strong>JSON Web Tokens (JWT)</strong> provide stateless authentication. The server issues a signed token upon login; clients include this token in subsequent requests. The server verifies the signature without database lookups.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> jwt <span class="op">=</span> <span class="pp">require</span>(<span class="st">'jsonwebtoken'</span>)<span class="op">;</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bcrypt <span class="op">=</span> <span class="pp">require</span>(<span class="st">'bcrypt'</span>)<span class="op">;</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">login</span>(email<span class="op">,</span> password) {</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Find user by email</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'email'</span><span class="op">,</span> email)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>user) {</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">UnauthorizedError</span>(<span class="st">'Invalid credentials'</span>)<span class="op">;</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Verify password against stored hash</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> validPassword <span class="op">=</span> <span class="cf">await</span> bcrypt<span class="op">.</span><span class="fu">compare</span>(password<span class="op">,</span> user<span class="op">.</span><span class="at">password_hash</span>)<span class="op">;</span></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>validPassword) {</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">UnauthorizedError</span>(<span class="st">'Invalid credentials'</span>)<span class="op">;</span></span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Generate signed token</span></span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> token <span class="op">=</span> jwt<span class="op">.</span><span class="fu">sign</span>(</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">userId</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> user<span class="op">.</span><span class="at">email</span> }<span class="op">,</span>  <span class="co">// Payload</span></span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">JWT_SECRET</span><span class="op">,</span>                   <span class="co">// Secret key</span></span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">expiresIn</span><span class="op">:</span> <span class="st">'24h'</span> }                      <span class="co">// Options</span></span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> { token<span class="op">,</span> <span class="dt">user</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> user<span class="op">.</span><span class="at">name</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> user<span class="op">.</span><span class="at">email</span> } }<span class="op">;</span></span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The token payload contains minimal identifying information—enough to authenticate but not sensitive data. The signature prevents tampering; if anyone modifies the payload, verification fails.</p>
<p><strong>Authentication middleware</strong> verifies tokens on protected routes:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> authenticate <span class="op">=</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Extract token from header</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> authHeader <span class="op">=</span> req<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">authorization</span><span class="op">;</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>authHeader <span class="op">||</span> <span class="op">!</span>authHeader<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">'Bearer '</span>)) {</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">UnauthorizedError</span>(<span class="st">'No token provided'</span>)<span class="op">;</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> authHeader<span class="op">.</span><span class="fu">substring</span>(<span class="dv">7</span>)<span class="op">;</span>  <span class="co">// Remove 'Bearer ' prefix</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify signature and decode payload</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> decoded <span class="op">=</span> jwt<span class="op">.</span><span class="fu">verify</span>(token<span class="op">,</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">JWT_SECRET</span>)<span class="op">;</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optionally verify user still exists (handles deleted accounts)</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'users'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> decoded<span class="op">.</span><span class="at">userId</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>user) {</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">UnauthorizedError</span>(<span class="st">'User no longer exists'</span>)<span class="op">;</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attach user to request for downstream handlers</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>    req<span class="op">.</span><span class="at">user</span> <span class="op">=</span> user<span class="op">;</span></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">===</span> <span class="st">'TokenExpiredError'</span>) {</span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">next</span>(<span class="kw">new</span> <span class="fu">UnauthorizedError</span>(<span class="st">'Token expired'</span>))<span class="op">;</span></span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">===</span> <span class="st">'JsonWebTokenError'</span>) {</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">next</span>(<span class="kw">new</span> <span class="fu">UnauthorizedError</span>(<span class="st">'Invalid token'</span>))<span class="op">;</span></span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>(error)<span class="op">;</span></span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="rate-limiting" class="level3" data-number="12.9.2">
<h3 data-number="12.9.2" class="anchored" data-anchor-id="rate-limiting"><span class="header-section-number">12.9.2</span> 10.8.2 Rate Limiting</h3>
<p>Rate limiting prevents abuse by restricting how many requests a client can make in a time window:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> rateLimit <span class="op">=</span> <span class="pp">require</span>(<span class="st">'express-rate-limit'</span>)<span class="op">;</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="co">// General API rate limit</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> apiLimiter <span class="op">=</span> <span class="fu">rateLimit</span>({</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">windowMs</span><span class="op">:</span> <span class="dv">15</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">,</span>  <span class="co">// 15 minute window</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span>                   <span class="co">// 100 requests per window</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">message</span><span class="op">:</span> {</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">code</span><span class="op">:</span> <span class="st">'RATE_LIMIT_EXCEEDED'</span><span class="op">,</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> <span class="st">'Too many requests, please try again later'</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Strict limit for authentication (prevents brute force)</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> authLimiter <span class="op">=</span> <span class="fu">rateLimit</span>({</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">windowMs</span><span class="op">:</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">,</span>  <span class="co">// 1 hour window</span></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span>                    <span class="co">// 10 attempts per hour</span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">skipSuccessfulRequests</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>  <span class="co">// Don't count successful logins</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">message</span><span class="op">:</span> {</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">error</span><span class="op">:</span> {</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">code</span><span class="op">:</span> <span class="st">'AUTH_RATE_LIMIT'</span><span class="op">,</span></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> <span class="st">'Too many login attempts, please try again later'</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="st">'/api/'</span><span class="op">,</span> apiLimiter)<span class="op">;</span></span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="st">'/api/auth/login'</span><span class="op">,</span> authLimiter)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The authentication limiter uses <code>skipSuccessfulRequests</code> so successful logins don’t count against the limit—only failed attempts (potential attacks) are limited.</p>
<hr>
</section>
</section>
<section id="caching-strategies" class="level2" data-number="12.10">
<h2 data-number="12.10" class="anchored" data-anchor-id="caching-strategies"><span class="header-section-number">12.10</span> 10.9 Caching Strategies</h2>
<p>Databases are slow compared to memory. Caching stores frequently-accessed data in fast storage (RAM) to reduce latency and database load. The challenge is keeping cached data synchronized with the source of truth.</p>
<section id="cache-aside-pattern" class="level3" data-number="12.10.1">
<h3 data-number="12.10.1" class="anchored" data-anchor-id="cache-aside-pattern"><span class="header-section-number">12.10.1</span> 10.9.1 Cache-Aside Pattern</h3>
<p>The most common caching strategy is <strong>cache-aside</strong> (or “lazy loading”):</p>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    CACHE-ASIDE PATTERN                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  READ FLOW:                                                             │
│  1. Application checks cache for data                                   │
│  2. If found (cache hit), return cached data                            │
│  3. If not found (cache miss), fetch from database                      │
│  4. Store result in cache for future requests                           │
│  5. Return data to client                                               │
│                                                                         │
│  WRITE FLOW:                                                            │
│  1. Update database (source of truth)                                   │
│  2. Invalidate (delete) cached data                                     │
│  3. Next read will fetch fresh data and repopulate cache                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
<p>Implementation:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> CACHE_TTL <span class="op">=</span> <span class="dv">300</span><span class="op">;</span>  <span class="co">// 5 minutes</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">getTaskWithCache</span>(taskId) {</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cacheKey <span class="op">=</span> <span class="vs">`task:</span><span class="sc">${</span>taskId<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 1: Check cache</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cached <span class="op">=</span> <span class="cf">await</span> redis<span class="op">.</span><span class="fu">get</span>(cacheKey)<span class="op">;</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cached) {</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Cache hit'</span>)<span class="op">;</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(cached)<span class="op">;</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 2: Cache miss - fetch from database</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Cache miss - querying database'</span>)<span class="op">;</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)<span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> taskId)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 3: Populate cache for future requests</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (task) {</span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> redis<span class="op">.</span><span class="fu">set</span>(cacheKey<span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(task)<span class="op">,</span> <span class="st">'EX'</span><span class="op">,</span> CACHE_TTL)<span class="op">;</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> task<span class="op">;</span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The TTL (time-to-live) ensures stale data eventually expires, even if we miss an invalidation. This provides a safety net—worst case, data is 5 minutes stale rather than permanently wrong.</p>
<p><strong>Cache invalidation</strong> on writes:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">updateTask</span>(taskId<span class="op">,</span> updates) {</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Update the source of truth</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [task] <span class="op">=</span> <span class="cf">await</span> <span class="fu">db</span>(<span class="st">'tasks'</span>)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">where</span>(<span class="st">'id'</span><span class="op">,</span> taskId)</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">update</span>(updates)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">returning</span>(<span class="st">'*'</span>)<span class="op">;</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Invalidate cache - next read will fetch fresh data</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> redis<span class="op">.</span><span class="fu">del</span>(<span class="vs">`task:</span><span class="sc">${</span>taskId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Also invalidate related caches</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> redis<span class="op">.</span><span class="fu">del</span>(<span class="vs">`user:</span><span class="sc">${</span>task<span class="op">.</span><span class="at">user_id</span><span class="sc">}</span><span class="vs">:tasks`</span>)<span class="op">;</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> task<span class="op">;</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We delete rather than update the cache. This is safer—if we tried to update and something went wrong, we’d have inconsistent data. Deletion ensures the next read gets authoritative data from the database.</p>
</section>
<section id="cache-invalidation-challenges" class="level3" data-number="12.10.2">
<h3 data-number="12.10.2" class="anchored" data-anchor-id="cache-invalidation-challenges"><span class="header-section-number">12.10.2</span> 10.9.2 Cache Invalidation Challenges</h3>
<p>Phil Karlton famously said there are only two hard problems in computer science: cache invalidation and naming things. The difficulty arises from maintaining consistency between cache and database.</p>
<p><strong>Common pitfalls:</strong></p>
<ul>
<li><strong>Forgetting to invalidate</strong>: A bug causes updates to skip cache invalidation. Data becomes permanently stale.</li>
<li><strong>Race conditions</strong>: A read happens between database update and cache invalidation, caching stale data.</li>
<li><strong>Cascade effects</strong>: Updating a user should invalidate their tasks, projects, and other related caches.</li>
</ul>
<p><strong>Mitigation strategies:</strong></p>
<ul>
<li>Use TTLs as a safety net (data eventually expires)</li>
<li>Invalidate aggressively (when in doubt, delete from cache)</li>
<li>Use cache tags for related data invalidation</li>
<li>Consider cache-through or write-through patterns for critical data</li>
</ul>
<hr>
</section>
</section>
<section id="chapter-summary" class="level2" data-number="12.11">
<h2 data-number="12.11" class="anchored" data-anchor-id="chapter-summary"><span class="header-section-number">12.11</span> 10.10 Chapter Summary</h2>
<p>Data management and APIs form the backbone of modern applications. This chapter covered the essential concepts and practices for storing, accessing, and exposing data effectively.</p>
<p>Key takeaways:</p>
<p><strong>Relational databases</strong> use tables, relationships, and SQL to manage structured data. Normalization reduces redundancy, while transactions ensure consistency. These databases excel at complex queries and maintaining data integrity.</p>
<p><strong>NoSQL databases</strong> provide alternatives for specific needs: document stores for flexible schemas, key-value stores for caching, column stores for analytics, and graph databases for relationship-heavy data. The choice depends on your access patterns and consistency requirements.</p>
<p><strong>RESTful APIs</strong> expose data through resources, HTTP methods, and status codes. Good REST design uses consistent naming, appropriate methods, and meaningful responses. The uniform interface makes APIs predictable and easy to consume.</p>
<p><strong>GraphQL</strong> offers an alternative where clients specify exactly what data they need. This solves over-fetching and under-fetching but requires careful resolver design to avoid performance pitfalls like the N+1 problem.</p>
<p><strong>API documentation</strong> using OpenAPI/Swagger makes APIs discoverable and reduces integration friction. Interactive documentation lets developers experiment without writing code.</p>
<p><strong>Validation and error handling</strong> protect your system from invalid data and provide meaningful feedback when things go wrong. Never trust client input.</p>
<p><strong>Security</strong> must be designed in from the start. Authentication verifies identity, authorization controls access, rate limiting prevents abuse, and input sanitization stops injection attacks.</p>
<p><strong>Caching</strong> improves performance by reducing database load. The cache-aside pattern is most common, but cache invalidation remains challenging. TTLs provide a safety net against stale data.</p>
<hr>
</section>
<section id="key-terms" class="level2" data-number="12.12">
<h2 data-number="12.12" class="anchored" data-anchor-id="key-terms"><span class="header-section-number">12.12</span> 10.11 Key Terms</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Term</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Primary Key</strong></td>
<td>Column(s) that uniquely identify each row in a table</td>
</tr>
<tr class="even">
<td><strong>Foreign Key</strong></td>
<td>Column that references a primary key in another table, creating relationships</td>
</tr>
<tr class="odd">
<td><strong>Normalization</strong></td>
<td>Process of organizing data to reduce redundancy and improve integrity</td>
</tr>
<tr class="even">
<td><strong>ACID</strong></td>
<td>Properties (Atomicity, Consistency, Isolation, Durability) ensuring reliable transactions</td>
</tr>
<tr class="odd">
<td><strong>NoSQL</strong></td>
<td>Non-relational databases optimized for specific use cases</td>
</tr>
<tr class="even">
<td><strong>REST</strong></td>
<td>Architectural style using resources, HTTP methods, and stateless communication</td>
</tr>
<tr class="odd">
<td><strong>Resource</strong></td>
<td>Conceptual entity in REST, identified by a URI</td>
</tr>
<tr class="even">
<td><strong>GraphQL</strong></td>
<td>Query language allowing clients to specify exactly what data they need</td>
</tr>
<tr class="odd">
<td><strong>Resolver</strong></td>
<td>Function that fetches data for a GraphQL field</td>
</tr>
<tr class="even">
<td><strong>OpenAPI</strong></td>
<td>Specification standard for documenting REST APIs</td>
</tr>
<tr class="odd">
<td><strong>JWT</strong></td>
<td>JSON Web Token—compact, self-contained token for authentication</td>
</tr>
<tr class="even">
<td><strong>Rate Limiting</strong></td>
<td>Controlling request frequency to prevent abuse</td>
</tr>
<tr class="odd">
<td><strong>Cache-Aside</strong></td>
<td>Caching pattern where application explicitly manages cache</td>
</tr>
<tr class="even">
<td><strong>N+1 Problem</strong></td>
<td>Performance issue where fetching N items causes N+1 database queries</td>
</tr>
<tr class="odd">
<td><strong>DataLoader</strong></td>
<td>Utility that batches and caches requests to solve N+1 problems</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="review-questions" class="level2" data-number="12.13">
<h2 data-number="12.13" class="anchored" data-anchor-id="review-questions"><span class="header-section-number">12.13</span> 10.12 Review Questions</h2>
<ol type="1">
<li><p>Explain the difference between primary keys and foreign keys. How do they work together to establish relationships between tables?</p></li>
<li><p>What are the three normal forms in database normalization? Provide an example of denormalized data and show how you would normalize it.</p></li>
<li><p>When would you choose a document database (like MongoDB) over a relational database (like PostgreSQL)? Give specific scenarios for each.</p></li>
<li><p>Describe the REST principles. How do HTTP methods map to CRUD operations?</p></li>
<li><p>Compare REST and GraphQL. What problems does GraphQL solve that REST doesn’t? What challenges does it introduce?</p></li>
<li><p>Explain the N+1 problem in GraphQL. How does DataLoader solve it?</p></li>
<li><p>What information should be included in an OpenAPI specification? Why is API documentation important?</p></li>
<li><p>Explain the difference between authentication and authorization. How would you implement both in a REST API?</p></li>
<li><p>Describe the cache-aside pattern. When would you use it, and what are the challenges?</p></li>
<li><p>What strategies can you use for API versioning? What are the trade-offs of each approach?</p></li>
</ol>
<hr>
</section>
<section id="hands-on-exercises" class="level2" data-number="12.14">
<h2 data-number="12.14" class="anchored" data-anchor-id="hands-on-exercises"><span class="header-section-number">12.14</span> 10.13 Hands-On Exercises</h2>
<section id="exercise-10.1-database-design" class="level3" data-number="12.14.1">
<h3 data-number="12.14.1" class="anchored" data-anchor-id="exercise-10.1-database-design"><span class="header-section-number">12.14.1</span> Exercise 10.1: Database Design</h3>
<p>Design a complete database schema for your project:</p>
<ol type="1">
<li>Identify all entities (users, tasks, projects, etc.)</li>
<li>Define attributes for each entity with appropriate data types</li>
<li>Establish relationships (one-to-many, many-to-many)</li>
<li>Write CREATE TABLE statements with proper constraints</li>
<li>Add indexes for columns used in WHERE clauses and JOINs</li>
<li>Document your schema with an entity-relationship diagram</li>
</ol>
</section>
<section id="exercise-10.2-sql-query-practice" class="level3" data-number="12.14.2">
<h3 data-number="12.14.2" class="anchored" data-anchor-id="exercise-10.2-sql-query-practice"><span class="header-section-number">12.14.2</span> Exercise 10.2: SQL Query Practice</h3>
<p>Write SQL queries for common operations in your application:</p>
<ol type="1">
<li>CRUD operations for your main entity</li>
<li>A join query combining at least 3 tables</li>
<li>An aggregation query using GROUP BY and HAVING</li>
<li>A query using a subquery or CTE</li>
<li>A query that would benefit from an index (and create that index)</li>
</ol>
</section>
<section id="exercise-10.3-rest-api-implementation" class="level3" data-number="12.14.3">
<h3 data-number="12.14.3" class="anchored" data-anchor-id="exercise-10.3-rest-api-implementation"><span class="header-section-number">12.14.3</span> Exercise 10.3: REST API Implementation</h3>
<p>Implement a complete REST API for one resource:</p>
<ol type="1">
<li>Create routes for all CRUD operations</li>
<li>Use appropriate HTTP methods and status codes</li>
<li>Implement pagination, filtering, and sorting for list endpoints</li>
<li>Add input validation with meaningful error messages</li>
<li>Write integration tests for all endpoints</li>
</ol>
</section>
<section id="exercise-10.4-api-documentation" class="level3" data-number="12.14.4">
<h3 data-number="12.14.4" class="anchored" data-anchor-id="exercise-10.4-api-documentation"><span class="header-section-number">12.14.4</span> Exercise 10.4: API Documentation</h3>
<p>Document your API using OpenAPI:</p>
<ol type="1">
<li>Define all endpoints with parameters and responses</li>
<li>Create reusable schemas for request/response objects</li>
<li>Document authentication requirements</li>
<li>Include example requests and responses</li>
<li>Set up Swagger UI to serve the documentation</li>
</ol>
</section>
<section id="exercise-10.5-caching-implementation" class="level3" data-number="12.14.5">
<h3 data-number="12.14.5" class="anchored" data-anchor-id="exercise-10.5-caching-implementation"><span class="header-section-number">12.14.5</span> Exercise 10.5: Caching Implementation</h3>
<p>Add a caching layer to your API:</p>
<ol type="1">
<li>Set up Redis connection</li>
<li>Implement cache-aside pattern for read operations</li>
<li>Add cache invalidation when data changes</li>
<li>Configure appropriate TTLs for different data types</li>
<li>Measure and document the performance improvement</li>
</ol>
</section>
<section id="exercise-10.6-graphql-alternative" class="level3" data-number="12.14.6">
<h3 data-number="12.14.6" class="anchored" data-anchor-id="exercise-10.6-graphql-alternative"><span class="header-section-number">12.14.6</span> Exercise 10.6: GraphQL Alternative</h3>
<p>Implement a GraphQL API alongside your REST API:</p>
<ol type="1">
<li>Define the schema with types, queries, and mutations</li>
<li>Implement resolvers for all operations</li>
<li>Add DataLoader to prevent N+1 queries</li>
<li>Compare the developer experience with REST</li>
</ol>
<hr>
</section>
</section>
<section id="further-reading" class="level2" data-number="12.15">
<h2 data-number="12.15" class="anchored" data-anchor-id="further-reading"><span class="header-section-number">12.15</span> 10.14 Further Reading</h2>
<p><strong>Books:</strong></p>
<ul>
<li>Kleppmann, M. (2017). <em>Designing Data-Intensive Applications</em>. O’Reilly Media.</li>
<li>Richardson, C. (2018). <em>Microservices Patterns</em>. Manning Publications.</li>
<li>Masse, M. (2011). <em>REST API Design Rulebook</em>. O’Reilly Media.</li>
</ul>
<p><strong>Online Resources:</strong></p>
<ul>
<li>PostgreSQL Documentation: https://www.postgresql.org/docs/</li>
<li>MongoDB Manual: https://docs.mongodb.com/manual/</li>
<li>Redis Documentation: https://redis.io/documentation</li>
<li>GraphQL Official Learn: https://graphql.org/learn/</li>
<li>OpenAPI Specification: https://swagger.io/specification/</li>
</ul>
<hr>
</section>
<section id="references" class="level2" data-number="12.16">
<h2 data-number="12.16" class="anchored" data-anchor-id="references"><span class="header-section-number">12.16</span> References</h2>
<p>Codd, E. F. (1970). A Relational Model of Data for Large Shared Data Banks. <em>Communications of the ACM</em>, 13(6), 377-387.</p>
<p>Date, C. J. (2003). <em>An Introduction to Database Systems</em> (8th Edition). Addison-Wesley.</p>
<p>Fielding, R. T. (2000). <em>Architectural Styles and the Design of Network-based Software Architectures</em> (Doctoral dissertation). University of California, Irvine.</p>
<p>Kleppmann, M. (2017). <em>Designing Data-Intensive Applications</em>. O’Reilly Media.</p>
<p>Facebook. (2015). GraphQL Specification. Retrieved from https://spec.graphql.org/</p>
<p>OpenAPI Initiative. (2021). OpenAPI Specification. Retrieved from https://spec.openapis.org/oas/v3.1.0</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/09-cicd.html" class="pagination-link" aria-label="Chapter 9: Continuous Integration and Continuous Deployment">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Chapter 9: Continuous Integration and Continuous Deployment</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/11-cloud-services.html" class="pagination-link" aria-label="Chapter 11: Cloud Services and Deployment">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Chapter 11: Cloud Services and Deployment</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>